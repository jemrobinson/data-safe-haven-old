
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Build an SRE compute image &#8212; Data Safe Haven v3.4.0 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/overrides.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/toggle.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Deploy a Secure Research Environment (SRE)" href="deploy_sre.html" />
    <link rel="prev" title="Deploy a Safe Haven Management Environment (SHM)" href="deploy_shm.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/logo_turing.jpg" class="logo" alt="logo">
</a>      


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../introduction/index.html">
  Introduction
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Roles
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../policies/index.html">
  Policies
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../design/index.html">
  Design
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/alan-turing-institute/data-safe-haven" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../data_provider_representative/index.html">
   Dataset Provider Representative
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../data_provider_representative/data_ingress.html">
     Data ingress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data_provider_representative/data_egress.html">
     Data egress process
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../investigator/index.html">
   Investigator
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../investigator/data_ingress.html">
     Data ingress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../investigator/data_egress.html">
     Data egress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../investigator/request_software_package.html">
     Requesting new software packages
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../programme_manager/index.html">
   Programme Manager
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../project_manager/index.html">
   Project Manager
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../project_manager/project_lifecycle.html">
     Project lifecycle
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../project_manager/data_ingress.html">
     Data ingress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../project_manager/data_egress.html">
     Data egress process
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../referee/index.html">
   Referee
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../researcher/index.html">
   Researcher
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../researcher/user_guide.html">
     User guide
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../researcher/user_guide_guacamole.html">
       User Guide: Apache Guacamole
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../researcher/user_guide_msrds.html">
       User Guide: Microsoft Remote Desktop
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../researcher/available_software.html">
     Available software
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   System Deployer
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="deploy_shm.html">
     Deploy a Safe Haven Management Environment (SHM)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Build an SRE compute image
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="deploy_sre.html">
     Deploy a Secure Research Environment (SRE)
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="deploy_sre_apache_guacamole.html">
       Deploy an SRE with Apache Guacamole
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="deploy_sre_microsoft_rds.html">
       Deploy an SRE with Microsoft RDS
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="migrate_an_shm.html">
     Migrating an SHM
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../system_manager/index.html">
   System Manager
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../system_manager/security_checklist.html">
     Security evaluation checklist
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../system_manager/administrator_guide.html">
     Administrator documentation
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
    
  
  <div class="rst-versions" data-toggle="rst-downloads" role="note" aria-label="downloads">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-file-pdf fa-fw left"></span>
      <span class="left">Download <strong>latest</strong> PDFs</span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_guacamole.pdf">User guide (Apache Guacamole)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_msrds.pdf">User guide (Microsoft RDS)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_full.pdf">Classification flowchart</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_simple.pdf">Simplified classification  flowchart</a></dd>
        
      </dl>
    </div>
  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book fa-fw left"></span>
      <span class="left">Currently reading: <strong>v3.4.0</strong></span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      
      
      <dl>
        <dt>Versions</dt>
        
          
          <dd><a href="/data-safe-haven/develop/index.html">develop</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.1.0-beta/index.html">v0.1.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.2.0-beta/index.html">v0.2.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.3.0-beta/index.html">v0.3.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.0-beta/index.html">v1.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.1-beta/index.html">v1.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.1.0-beta/index.html">v1.1.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v2.0.0-beta/index.html">v2.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.0.0-beta/index.html">v3.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.0.1-beta/index.html">v3.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.1.0/index.html">v3.1.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.2.0/index.html">v3.2.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.0/index.html">v3.3.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.1/index.html">v3.3.1</a></dd>
          
        
           <strong> 
          <dd><a href="/data-safe-haven/v3.4.0/index.html">v3.4.0</a></dd>
           </strong> 
        
      </dl>
      
      
    </div>
  </div>
</div>




          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explanation-of-symbols-used-in-this-guide">
   Explanation of symbols used in this guide
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   1. 🌱 Prerequisites
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-verify-code-version">
     (Optional) Verify code version
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optional-customise-the-build-configuration">
   2. 🎁 (Optional) Customise the build configuration
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-apt-package">
     Adding a new apt package
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-python-package">
     Adding a new Python package
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#adding-a-new-r-package">
     Adding a new R package
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#adding-packages-to-the-package-allowlist">
       Adding packages to the package allowlist
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-the-version-of-a-package">
     Changing the version of a package
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#build-a-release-candidate">
   3. 👷 Build a release candidate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convert-candidate-vm-to-an-image">
   4. 📷 Convert candidate VM to an image
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#register-image-in-the-gallery">
   5. 🎨 Register image in the gallery
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/alan-turing-institute/data-safe-haven/edit/develop/docs/roles/system_deployer/build_srd_image.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="build-an-sre-compute-image">
<h1>Build an SRE compute image<a class="headerlink" href="#build-an-sre-compute-image" title="Permalink to this headline">¶</a></h1>
<p>These instructions will walk you through creating a new VM image for use in the secure research environment.</p>
<section id="explanation-of-symbols-used-in-this-guide">
<h2>Explanation of symbols used in this guide<a class="headerlink" href="#explanation-of-symbols-used-in-this-guide" title="Permalink to this headline">¶</a></h2>
<div class="admonition-powershell-command admonition">
<p class="admonition-title">Powershell command</p>
<p><img alt="Powershell: estimate of time needed" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=powershell&amp;label=local&amp;color=blue&amp;message=estimate%20of%20time%20needed" /></p>
<ul>
<li><p>This indicates a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> command which you will need to run locally on your machine</p></li>
<li><p>Ensure you have checked out (or downloaded) the appropriate tag of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the indicated directory of your locally checked-out version of the Safe Haven repository</p></li>
<li><p>Ensure that you are logged into Azure by running the <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code> command</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If your account is a guest in additional Azure tenants, you may need to add the <code class="docutils literal notranslate"><span class="pre">-Tenant</span> <span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> flag, where <code class="docutils literal notranslate"><span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> is the ID of the Azure tenant you want to deploy into.</p>
</div>
</li>
<li><p>This command will give you a URL and a short alphanumeric code.</p></li>
<li><p>Go to URL in a web browser, enter the code and log in to your account on Azure.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you have several Azure accounts, make sure you use one that has permissions to make changes to the subscription you are using</p>
</div>
</li>
</ul>
</div>
<div class="admonition-remote-command admonition">
<p class="admonition-title">Remote command</p>
<p><img alt="Remote: estimate of time needed" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=microsoft-onedrive&amp;label=remote&amp;color=blue&amp;message=estimate%20of%20time%20needed" /></p>
<ul class="simple">
<li><p>This indicates a command which you will need to run remotely on an Azure virtual machine (VM) using <code class="docutils literal notranslate"><span class="pre">Microsoft</span> <span class="pre">Remote</span> <span class="pre">Desktop</span></code></p></li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">Microsoft</span> <span class="pre">Remote</span> <span class="pre">Desktop</span></code> and click <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Desktop</span></code> / <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">PC</span></code></p></li>
<li><p>Enter the private IP address of the VM that you need to connect to in the <code class="docutils literal notranslate"><span class="pre">PC</span> <span class="pre">name</span></code> field (this can be found by looking in the Azure portal)</p></li>
<li><p>Enter the name of the VM (for example <code class="docutils literal notranslate"><span class="pre">DC1-SHM-PROJECT</span></code>) in the <code class="docutils literal notranslate"><span class="pre">Friendly</span> <span class="pre">name</span></code> field</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Add</span></code></p></li>
<li><p>Ensure you are connected to the SHM VPN that you have set up</p></li>
<li><p>Double click on the desktop that appears under <code class="docutils literal notranslate"><span class="pre">Saved</span> <span class="pre">Desktops</span></code> or <code class="docutils literal notranslate"><span class="pre">PCs</span></code>.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code> specified by the appropriate section of the guide</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you see a warning dialog that the certificate cannot be verified as root, accept this and continue.</p>
</div>
</div>
<div class="admonition-azure-portal-operation admonition">
<p class="admonition-title">Azure Portal operation</p>
<p><img alt="Portal: estimate of time needed" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=microsoft-azure&amp;label=portal&amp;color=blue&amp;message=estimate%20of%20time%20needed" /></p>
<ul class="simple">
<li><p>This indicates an operation which needs to be carried out in the <a class="reference external" href="https://portal.azure.com"><code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Portal</span></code></a> using a web browser on your local machine.</p></li>
<li><p>You will need to login to the portal using an account with privileges to make the necessary changes to the resources you are altering</p></li>
</ul>
</div>
<div class="admonition-azure-active-directory-operation admonition">
<p class="admonition-title">Azure Active Directory operation</p>
<p><img alt="Azure AD: estimate of time needed" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=microsoft-academic&amp;label=Azure%20AD&amp;color=blue&amp;message=estimate%20of%20time%20needed" /></p>
<ul class="simple">
<li><p>This indicates an operation which needs to be carried out in the <a class="reference external" href="https://portal.azure.com"><code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Portal</span></code></a> using a web browser on your local machine.</p></li>
<li><p>You will need to login to the portal using an account with administrative privileges on the <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code> that you are altering.</p></li>
<li><p>Note that this might be different from the account which is able to create/alter resources in the Azure subscription where you are building the Safe Haven.</p></li>
</ul>
</div>
<div class="admonition-os-dependent-steps admonition">
<p class="admonition-title">OS-dependent steps</p>
<p>The following icons indicate steps that depend on the OS you are using to deploy the SHM</p>
<ul class="simple">
<li><p><img alt="macOS" src="https://img.shields.io/badge/-555?&amp;logo=apple&amp;logoColor=white" /> <strong>MacOS</strong></p></li>
<li><p><img alt="Windows" src="https://img.shields.io/badge/-555?&amp;logo=windows&amp;logoColor=white" /> <strong>Windows</strong></p></li>
<li><p><img alt="Linux" src="https://img.shields.io/badge/-555?&amp;logo=linux&amp;logoColor=white" /> <strong>Linux</strong></p></li>
</ul>
</div>
</section>
<section id="prerequisites">
<h2>1. 🌱 Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>An <code class="docutils literal notranslate"><span class="pre">Azure</span></code> subscription with sufficient credits to build the environment in</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Powershell</span></code> for <code class="docutils literal notranslate"><span class="pre">Azure</span></code></p>
<ul>
<li><p>Install <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.2.0">Powershell v6.0 or above</a></p></li>
<li><p>Install the Azure <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.2.0&amp;viewFallbackFrom=azps-1.3.0">Powershell Module</a></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">SSH</span></code> or <code class="docutils literal notranslate"><span class="pre">OpenSSH</span></code> (not tested on Windows)</p></li>
<li><p>SHM configuration file</p>
<ul>
<li><p>The core properties for the environment must be present in the <code class="docutils literal notranslate"><span class="pre">environment_configs</span></code> folder as described in the <a class="reference internal" href="deploy_shm.html#deploy-shm"><span class="std std-ref">Safe Haven Management deployment instructions</span></a>.</p></li>
</ul>
</li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If you run:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Start-Transcript</span> <span class="n">-Path</span> <span class="p">&lt;</span><span class="n">a</span> <span class="n">log</span> <span class="n">file</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>before you start your deployment and</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="nb">Stop-Transcript</span>
</pre></div>
</div>
<p>afterwards, you will automatically get a full log of the Powershell commands you have run.</p>
</div>
<section id="optional-verify-code-version">
<h3>(Optional) Verify code version<a class="headerlink" href="#optional-verify-code-version" title="Permalink to this headline">¶</a></h3>
<p>If you have cloned/forked the code from our <code class="docutils literal notranslate"><span class="pre">GitHub</span></code> repository, you can confirm which version of the Data Safe Haven you are currently using by running the following commands:</p>
<p><img alt="Powershell: a few seconds" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=powershell&amp;label=local&amp;color=blue&amp;message=a%20few%20seconds" /></p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="n">git</span> <span class="n">tag</span> <span class="p">-</span><span class="n">-list</span> <span class="p">|</span> <span class="nb">Select-String</span> <span class="p">$(</span><span class="n">git</span> <span class="n">describe</span> <span class="p">-</span><span class="n">-tags</span><span class="p">)</span>
</pre></div>
</div>
<p>This will check the tag you are using against the list of known tags and print it out.
You can include this confirmation in any record you keep of your deployment.</p>
</section>
</section>
<section id="optional-customise-the-build-configuration">
<h2>2. 🎁 (Optional) Customise the build configuration<a class="headerlink" href="#optional-customise-the-build-configuration" title="Permalink to this headline">¶</a></h2>
<p>Provisioning a VM with all the Safe Haven software is done using <a class="reference external" href="https://cloudinit.readthedocs.io/en/latest/">cloud-init</a>.
This takes a basic Ubuntu image and installs and configures all the necessary software packages.
In general, this image should cover most use cases, but it’s possible that you may want to customise it for your particular circumstances, for example if you want to add a new package or to update the version of an existing package.</p>
<section id="adding-a-new-apt-package">
<h3>Adding a new apt package<a class="headerlink" href="#adding-a-new-apt-package" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Add the name of the package to <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/packages-apt.list</span></code></p></li>
<li><p>If this package adds a new executable that you would like to be available to the end user, you should also add a check for this to the end of <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/cloud_init/cloud-init-buildimage-ubuntu-&lt;version&gt;.mustache.yaml</span></code></p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>For example, to check for <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Data</span> <span class="pre">Studio</span></code>, the following line was added:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$(</span>which azuredatastudio<span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;\n\n*azuredatastudio*\n\n</span><span class="k">$(</span>which azuredatastudio<span class="k">)</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">else</span> <span class="nb">echo</span> <span class="s2">&quot;ERROR azuredatastudio not found!&quot;</span><span class="p">;</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="k">fi</span>
</pre></div>
</div>
</div>
</section>
<section id="adding-a-new-python-package">
<h3>Adding a new Python package<a class="headerlink" href="#adding-a-new-python-package" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Add the name of the package as it appears on <code class="docutils literal notranslate"><span class="pre">PyPI</span></code> to each of the package lists (supported Python versions only):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/packages-python-pypi-36.list</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/packages-python-pypi-37.list</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/packages-python-pypi-38.list</span></code></p></li>
</ul>
</li>
<li><p>If there are any restrictions on acceptable versions for this package (e.g. a minimum or exact version) then add an entry to the appropriate section in <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/python-requirements.json</span></code></p></li>
<li><p>You should also add this package to the <strong>allow list</strong> used by <a class="reference internal" href="../../policies/data_sensitivity_classification/sensitivity_tiers.html#policy-tier-3"><span class="std std-ref">Tier 3</span></a> package mirrors in <code class="docutils literal notranslate"><span class="pre">environment_configs/package_lists/allowlist-core-python-pypi-tier3.list</span></code></p></li>
</ul>
</section>
<section id="adding-a-new-r-package">
<h3>Adding a new R package<a class="headerlink" href="#adding-a-new-r-package" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Add the name of the package as it appears on <code class="docutils literal notranslate"><span class="pre">CRAN</span></code> or <code class="docutils literal notranslate"><span class="pre">Bioconductor</span></code> to the appropriate package list:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/packages-r-bioconductor.list</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/packages-r-cran.list</span></code></p></li>
</ul>
</li>
<li><p>If this <code class="docutils literal notranslate"><span class="pre">R</span></code> package is available as a pre-compiled apt binary (eg. <code class="docutils literal notranslate"><span class="pre">abind</span></code> is available as <code class="docutils literal notranslate"><span class="pre">r-cran-abind</span></code>) then also add it to <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/packages/packages-apt.list</span></code>.</p></li>
<li><p>You should also add this package to the <strong>allow list</strong> used by <a class="reference internal" href="../../policies/data_sensitivity_classification/sensitivity_tiers.html#policy-tier-3"><span class="std std-ref">Tier 3</span></a> package mirrors in <code class="docutils literal notranslate"><span class="pre">environment_configs/package_lists/allowlist-core-r-cran-tier3.list</span></code></p></li>
</ul>
<section id="adding-packages-to-the-package-allowlist">
<h4>Adding packages to the package allowlist<a class="headerlink" href="#adding-packages-to-the-package-allowlist" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>When you add a new package to either the <code class="docutils literal notranslate"><span class="pre">PyPI</span></code> or <code class="docutils literal notranslate"><span class="pre">CRAN</span></code> allowlist you should also determine all of its dependencies (and their dependencies, recursively)</p></li>
<li><p>Once you have the list of packages you should add them to:</p>
<ul>
<li><p><strong>PyPI:</strong> <code class="docutils literal notranslate"><span class="pre">environment_configs/package_lists/allowlist-full-python-pypi-tier3.list</span></code></p></li>
<li><p><strong>CRAN:</strong> <code class="docutils literal notranslate"><span class="pre">environment_configs/package_lists/allowlist-full-r-cran-tier3.list</span></code></p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="changing-the-version-of-a-package">
<h3>Changing the version of a package<a class="headerlink" href="#changing-the-version-of-a-package" title="Permalink to this headline">¶</a></h3>
<p>If you want to update the version of one of the packages we install from a <code class="docutils literal notranslate"><span class="pre">.deb</span></code> file (eg. <code class="docutils literal notranslate"><span class="pre">RStudio</span></code>), you will need to edit <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_desktop/cloud_init/cloud-init-buildimage-ubuntu-&lt;version&gt;.mustache.yaml</span></code></p>
<ul class="simple">
<li><p>Find the appropriate <code class="docutils literal notranslate"><span class="pre">/installation/&lt;package</span> <span class="pre">name&gt;.debinfo</span></code> section under the <code class="docutils literal notranslate"><span class="pre">write_files:</span></code> key</p></li>
<li><p>Update the version number and the <code class="docutils literal notranslate"><span class="pre">sha256</span></code> hash for the file</p></li>
<li><p>Check that the file naming structure still matches the format described in this <code class="docutils literal notranslate"><span class="pre">.debinfo</span></code> file</p></li>
</ul>
</section>
</section>
<section id="build-a-release-candidate">
<h2>3. 👷 Build a release candidate<a class="headerlink" href="#build-a-release-candidate" title="Permalink to this headline">¶</a></h2>
<p>In order to provision a candidate VM you will need to do the following:</p>
<p><img alt="Powershell: two to three hours" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=powershell&amp;label=local&amp;color=blue&amp;message=two%20to%20three%20hours" /> at 📁 <code class="docutils literal notranslate"><span class="pre">./deployment/secure_research_desktop/setup</span></code></p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="p">./</span><span class="n">Provision_Compute_VM</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">SHM</span> <span class="n">ID</span><span class="p">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>where <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code> is the <a class="reference internal" href="deploy_shm.html#roles-deployer-shm-id"><span class="std std-ref">management environment ID</span></a> for this SRE</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>Although the <code class="docutils literal notranslate"><span class="pre">./Provision_Compute_VM.ps1</span></code> script will finish running in a few minutes, the build itself will take several hours.</p></li>
<li><p>We recommend <strong>monitoring</strong> the build by accessing the machine using <code class="docutils literal notranslate"><span class="pre">ssh</span></code> and either reading through the full build log at <code class="docutils literal notranslate"><span class="pre">/var/log/cloud-init-output.log</span></code> or running the summary script using <code class="docutils literal notranslate"><span class="pre">/opt/verification/analyse_build.py</span></code>.</p></li>
<li><p>Note that the VM will automatically shutdown at the end of the cloud-init process - if you want to analyse the build after this point, you will need to turn it back on in the <code class="docutils literal notranslate"><span class="pre">Azure</span></code> portal.</p></li>
</ul>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<ul class="simple">
<li><p>If you are unable to access the VM over <code class="docutils literal notranslate"><span class="pre">ssh</span></code> please check whether you are trying to connect from one of the approved IP addresses that you defined under <code class="docutils literal notranslate"><span class="pre">vmImages</span> <span class="pre">&gt;</span> <span class="pre">buildIpAddresses</span></code> in the SHM config file.</p></li>
<li><p>You can check which IP addresses are currently allowed by looking at the <code class="docutils literal notranslate"><span class="pre">AllowBuildAdminSSH</span></code> inbound connection rule in the <code class="docutils literal notranslate"><span class="pre">RG_VMIMAGES_NETWORKING</span> <span class="pre">&gt;</span> <span class="pre">NSG_VMIMAGES_BUILD_CANDIDATES</span></code> network security group in the subscription where you are building the candidate VM</p></li>
</ul>
</div>
</section>
<section id="convert-candidate-vm-to-an-image">
<h2>4. 📷 Convert candidate VM to an image<a class="headerlink" href="#convert-candidate-vm-to-an-image" title="Permalink to this headline">¶</a></h2>
<p>Once you are happy with a particular candidate, you can convert it into an image as follows:</p>
<p><img alt="Powershell: ten minutes" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=powershell&amp;label=local&amp;color=blue&amp;message=ten%20minutes" /> at 📁 <code class="docutils literal notranslate"><span class="pre">./deployment/secure_research_desktop/setup</span></code></p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="p">./</span><span class="n">Convert_VM_To_Image</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">SHM</span> <span class="n">ID</span><span class="p">&gt;</span> <span class="n">-vmName</span> <span class="p">&lt;</span><span class="n">VM</span> <span class="n">name</span><span class="p">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>where <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code> is the <a class="reference internal" href="deploy_shm.html#roles-deployer-shm-id"><span class="std std-ref">management environment ID</span></a> for this SRE</p></li>
<li><p>where <code class="docutils literal notranslate"><span class="pre">&lt;VM</span> <span class="pre">name&gt;</span></code> is the name of the virtual machine created during the provisioning step</p></li>
</ul>
<p>This will build a new image in <code class="docutils literal notranslate"><span class="pre">RG_VMIMAGES_STORAGE</span></code> and delete the VM plus associated build artifacts (hard disk, network card and public IP address)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The first step of this script will run the remote build analysis script.
Please <strong>check</strong> that everything has built correctly before proceeding.</p>
</div>
</section>
<section id="register-image-in-the-gallery">
<h2>5. 🎨 Register image in the gallery<a class="headerlink" href="#register-image-in-the-gallery" title="Permalink to this headline">¶</a></h2>
<p>Once you have created an image, it can be registered in the image gallery for future use using the <code class="docutils literal notranslate"><span class="pre">Register_Image_In_Gallery.ps1</span></code> script.</p>
<p><img alt="Powershell: one hour" src="https://img.shields.io/static/v1?style=for-the-badge&amp;logo=powershell&amp;label=local&amp;color=blue&amp;message=one%20hour" /> at 📁 <code class="docutils literal notranslate"><span class="pre">./deployment/secure_research_desktop/setup</span></code></p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="p">./</span><span class="n">Register_Image_In_Gallery</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">SHM</span> <span class="n">ID</span><span class="p">&gt;</span> <span class="n">-vmName</span> <span class="n">-imageName</span> <span class="p">&lt;</span><span class="n">Image</span> <span class="n">name</span><span class="p">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>where <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code> is the <a class="reference internal" href="deploy_shm.html#roles-deployer-shm-id"><span class="std std-ref">management environment ID</span></a> for this SRE</p></li>
<li><p>where <code class="docutils literal notranslate"><span class="pre">&lt;Image</span> <span class="pre">Name&gt;</span></code> is the name of the VM image created during the conversion step</p></li>
</ul>
<p>This will register the image in the shared gallery as a new version of the relevant SRD image.
This command can take between 30 minutes and 1 hour to complete, as it has to replicate the VM across 3 different regions.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="deploy_shm.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Deploy a Safe Haven Management Environment (SHM)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="deploy_sre.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Deploy a Secure Research Environment (SRE)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, The Alan Turing Institute.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 4.3.0.
    Hosted by <a href="https://pages.github.com/">GitHub Pages</a>.
    <br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>