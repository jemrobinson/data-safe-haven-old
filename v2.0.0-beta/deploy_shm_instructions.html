
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Safe Haven Management Environment Build Instructions &#8212; Data Safe Haven v2.0.0-beta documentation</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="_static/overrides.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/toggle.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="index.html">
  <img src="_static/logo_turing.jpg" class="logo" alt="logo">
</a>      


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/alan-turing-institute/data-safe-haven" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
    
  
  <div class="rst-versions" data-toggle="rst-downloads" role="note" aria-label="downloads">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-file-pdf fa-fw left"></span>
      <span class="left">Download <strong>latest</strong> PDFs</span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_guacamole.pdf">User guide (Apache Guacamole)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_msrds.pdf">User guide (Microsoft RDS)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_full.pdf">Classification flowchart</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_simple.pdf">Simplified classification  flowchart</a></dd>
        
      </dl>
    </div>
  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book fa-fw left"></span>
      <span class="left">Currently reading: <strong>v2.0.0-beta</strong></span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      
      
      <dl>
        <dt>Versions</dt>
        
          
          <dd><a href="/data-safe-haven/develop/index.html">develop</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.1.0-beta/index.html">v0.1.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.2.0-beta/index.html">v0.2.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.3.0-beta/index.html">v0.3.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.0-beta/index.html">v1.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.1-beta/index.html">v1.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.1.0-beta/index.html">v1.1.0-beta</a></dd>
          
        
           <strong> 
          <dd><a href="/data-safe-haven/v2.0.0-beta/index.html">v2.0.0-beta</a></dd>
           </strong> 
        
          
          <dd><a href="/data-safe-haven/v3.0.0-beta/index.html">v3.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.0.1-beta/index.html">v3.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.1.0/index.html">v3.1.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.2.0/index.html">v3.2.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.0/index.html">v3.3.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.1/index.html">v3.3.1</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.4.0/index.html">v3.4.0</a></dd>
          
        
      </dl>
      
      
    </div>
  </div>
</div>




          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contents">
   Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   1. Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#safe-haven-management-configuration">
   2. Safe Haven Management configuration
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#domain-name">
     Domain name
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#management-environment-id-shmid">
     Management environment ID
     <code class="docutils literal notranslate">
      <span class="pre">
       &lt;shmId&gt;
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-configuration-file">
     Create configuration file
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#configure-dns-for-the-custom-domain">
   3. Configure DNS for the custom domain
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-dns-zone-for-the-custom-domain">
     Create a DNS zone for the custom domain
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-dns-records-to-the-parent-dns-system">
     Add DNS records to the parent DNS system
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup-azure-active-directory-aad">
   4. Setup Azure Active Directory (AAD)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-new-aad">
     Create a new AAD
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-the-custom-domain-to-the-new-aad">
     Add the custom domain to the new AAD
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-key-vault-for-shm-secrets">
   5. Deploy key vault for SHM secrets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup-safe-haven-administrators">
   6. Setup Safe Haven administrators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-global-administrator">
     Add global administrator
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-additional-administrators-optional">
     Add additional administrators (optional)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enable-mfa">
     Enable MFA
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-and-configure-vnet-and-domain-controllers">
   7. Deploy and configure VNET and Domain Controllers
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploy-the-virtual-network-and-active-directory-domain-controller">
     Deploy the Virtual Network and Active Directory Domain Controller
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-a-client-vpn-certificate-for-the-safe-haven-management-vnet">
     Download a client VPN certificate for the Safe Haven Management VNet
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-a-vpn-connection-to-the-safe-haven-management-vnet">
     Configure a VPN connection to the Safe Haven Management VNet
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-the-first-domain-controller-dc1-via-remote-desktop">
     Access the first Domain Controller (DC1) via Remote Desktop
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-azure-active-directory-connect">
     Install Azure Active Directory Connect
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-aad-sync-permissions">
     Set AAD sync permissions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#additional-aad-connect-configuration">
     Additional AAD Connect Configuration
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#validation-of-ad-sync">
     Validation of AD sync
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-aad-side-of-ad-connect">
     Configure AAD side of AD connect
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-and-configure-network-policy-server-nps">
   8. Deploy and configure Network Policy Server (NPS)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-nps-server">
     Configure NPS server
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mfa-configuation">
     MFA Configuation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-package-mirrors">
   9. Deploy package mirrors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#when-to-deploy-mirrors">
     When to deploy mirrors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploying-package-mirrors">
     Deploying package mirrors
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-tearing-down-package-mirrors">
     [Optional] Tearing down package mirrors
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tearing-down-the-shm">
   10. Tearing down the SHM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#disconnect-from-the-azure-active-directory">
     Disconnect from the Azure Active Directory
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tear-down-any-attached-sres-then-the-shm">
     Tear down any attached SREs then the SHM
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/alan-turing-institute/data-safe-haven/edit/develop/docs/deploy_shm_instructions.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="safe-haven-management-environment-build-instructions">
<h1>Safe Haven Management Environment Build Instructions<a class="headerlink" href="#safe-haven-management-environment-build-instructions" title="Permalink to this headline">¶</a></h1>
<p>These instructions will deploy a new Safe Haven Management Environment (SHM). This is required to manage your Secure Research Environments (SREs) and must be deployed before you create any SREs. A single SHM can manage all your SREs. Alternatively, you may run multiple SHMs concurrently (eg one for each Data Study Group).</p>
<section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="#1-prerequisites">Prerequisites</a></p></li>
<li><p><a class="reference external" href="#2-safe-haven-management-configuration">Safe Haven Management configuration</a></p></li>
<li><p><a class="reference external" href="#3-configure-dns-for-the-custom-domain">Configure DNS for the custom domain</a></p></li>
<li><p><a class="reference external" href="#4-setup-azure-active-directory-aad">Setup Azure Active Directory (AAD)</a></p></li>
<li><p><a class="reference external" href="#5-deploy-key-vault-for-shm-secrets">Deploy key vault for SHM secrets</a></p></li>
<li><p><a class="reference external" href="#6-setup-safe-haven-administrators">Setup Safe Haven administrators</a></p></li>
<li><p><a class="reference external" href="#7-deploy-and-configure-vnet-and-domain-controllers">Deploy and configure VNET and Domain Controllers</a></p></li>
<li><p><a class="reference external" href="#8-deploy-and-configure-network-policy-server-nps">Deploy and configure Network Policy Server (NPS)</a></p></li>
<li><p><a class="reference external" href="#9-deploy-package-mirrors">Deploy package mirrors</a></p></li>
<li><p><a class="reference external" href="#10-tearing-down-the-shm">Tear down SHM</a></p></li>
</ol>
</section>
<section id="prerequisites">
<h2>1. Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>An Azure subscription with sufficient credits to build the environment in</p></li>
<li><p>PowerShell for Azure</p>
<ul>
<li><p>Install <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.2.0">PowerShell v 6.0 or above</a></p></li>
<li><p>Install the Azure <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.2.0&amp;viewFallbackFrom=azps-1.3.0">PowerShell Module</a></p></li>
</ul>
</li>
<li><p>Microsoft Remote Desktop</p>
<ul>
<li><p>On Mac this can be installed from the <a class="reference external" href="https://itunes.apple.com/gb/app/microsoft-remote-desktop-10/id1295203466?mt=12">apple store</a></p></li>
</ul>
</li>
<li><p>OpenSSL</p>
<ul>
<li><p>Install using your package manager of choice</p></li>
</ul>
</li>
</ul>
</section>
<section id="safe-haven-management-configuration">
<h2>2. Safe Haven Management configuration<a class="headerlink" href="#safe-haven-management-configuration" title="Permalink to this headline">¶</a></h2>
<section id="domain-name">
<h3>Domain name<a class="headerlink" href="#domain-name" title="Permalink to this headline">¶</a></h3>
<p>Choose a domain according to the following rules:</p>
<ul class="simple">
<li><p>Turing production: a subdomain of the <code class="docutils literal notranslate"><span class="pre">turingsafehaven.ac.uk</span></code> domain</p></li>
<li><p>Turing testing: a subdomain of the <code class="docutils literal notranslate"><span class="pre">dsgroupdev.co.uk</span></code> domain</p></li>
<li><p>Other safe havens: follow your organisation’s guidance. This may require purchasing a dedicated domain</p></li>
</ul>
</section>
<section id="management-environment-id-shmid">
<h3>Management environment ID <code class="docutils literal notranslate"><span class="pre">&lt;shmId&gt;</span></code><a class="headerlink" href="#management-environment-id-shmid" title="Permalink to this headline">¶</a></h3>
<p>Choose a short ID <code class="docutils literal notranslate"><span class="pre">&lt;shmId&gt;</span></code> to identify the management environment (e.g. <code class="docutils literal notranslate"><span class="pre">testa</span></code>).</p>
</section>
<section id="create-configuration-file">
<h3>Create configuration file<a class="headerlink" href="#create-configuration-file" title="Permalink to this headline">¶</a></h3>
<p>The core properties for the Safe Haven Management (SHM) environment must be present in the <code class="docutils literal notranslate"><span class="pre">environment_configs/core</span></code> folder. These are also used when deploying an SRE environment.
The following core SHM properties must be defined in a JSON file named <code class="docutils literal notranslate"><span class="pre">shm_&lt;shmId&gt;_core_config.json</span></code>. The <code class="docutils literal notranslate"><span class="pre">shm_testa_core_config.json</span></code> provides an example.</p>
<p><strong>NOTE:</strong> The <code class="docutils literal notranslate"><span class="pre">netbiosName</span></code> must have a maximum length of 15 characters.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;subscriptionName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure subscription the management environment is deployed in&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;domainSubscriptionName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure subscription holding DNS records&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;adminSecurityGroupName&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure Security Group that admins of this Safe Haven will belong to&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;computeVmImageSubscriptionName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Azure Subscription name for compute VM&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;domain&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The fully qualified domain name for the management environment&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;netbiosname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A short name to use as the local name for the domain. This must be 15 characters or less&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;shmId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A short ID to identify the management environment&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Safe Haven deployment name&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;organisation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Organisation name&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;townCity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Location&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;stateCountyRegion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Location&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;countryCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e.g. GB&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The Azure location in which the management environment VMs are deployed&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;ipPrefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The three octet IP address prefix for the Class A range used by the management environment. Use 10.0.0 for this unless you have a good reason to use another prefix.&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="configure-dns-for-the-custom-domain">
<h2>3. Configure DNS for the custom domain<a class="headerlink" href="#configure-dns-for-the-custom-domain" title="Permalink to this headline">¶</a></h2>
<section id="create-a-dns-zone-for-the-custom-domain">
<h3>Create a DNS zone for the custom domain<a class="headerlink" href="#create-a-dns-zone-for-the-custom-domain" title="Permalink to this headline">¶</a></h3>
<p>Whatever new domain or subdomain you choose, you must create a new Azure DNS Zone for the domain or subdomain.</p>
<ul class="simple">
<li><p>Use the following resource group and subscriptions:</p>
<ul>
<li><p>Turing production (<code class="docutils literal notranslate"><span class="pre">.turingsafehaven.ac.uk</span></code>):</p>
<ul>
<li><p>use the <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Domains</span></code> subscription</p></li>
<li><p>use the <code class="docutils literal notranslate"><span class="pre">RG_SHM_DNS_PRODUCTION</span></code> resource group</p></li>
</ul>
</li>
<li><p>Turing testing (<code class="docutils literal notranslate"><span class="pre">.dsgroupdev.co.uk</span></code>):</p>
<ul>
<li><p>use the <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Domains</span></code> subscription</p></li>
<li><p>use the <code class="docutils literal notranslate"><span class="pre">RG_SHM_DNS_TEST</span></code> resource group</p></li>
</ul>
</li>
<li><p>Other safe havens: follow your organisation’s guidance.</p></li>
</ul>
</li>
<li><p>If the resource group specified above does not exist in your chosen subscription, create it now in the <code class="docutils literal notranslate"><span class="pre">UK</span> <span class="pre">South</span></code> region</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">a</span> <span class="pre">resource</span></code> in the far left menu, search for “DNS Zone” and click <code class="docutils literal notranslate"><span class="pre">Create</span></code>, using the above resource group and subscription.</p></li>
<li><p>For the <code class="docutils literal notranslate"><span class="pre">Name</span></code> field enter the fully qualified domain / subdomain. Examples are:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">testa.dsgroupdev.co.uk</span></code> for the first test SHM deployed as part of the Turing <code class="docutils literal notranslate"><span class="pre">test</span></code> environment</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">testb.dsgroupdev.co.uk</span></code> for a second test SHM deployed as part of the Turing <code class="docutils literal notranslate"><span class="pre">test</span></code> environment</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">turingsafehaven.ac.uk</span></code> for the production SHM deployed as the Turing <code class="docutils literal notranslate"><span class="pre">production</span></code> environment</p></li>
</ul>
</li>
<li><p>Click through the various validation screens</p></li>
</ul>
</section>
<section id="add-dns-records-to-the-parent-dns-system">
<h3>Add DNS records to the parent DNS system<a class="headerlink" href="#add-dns-records-to-the-parent-dns-system" title="Permalink to this headline">¶</a></h3>
<p>Once the new DNS Zone for your domain/subdomain has been deployed, you need to add an <code class="docutils literal notranslate"><span class="pre">NS</span></code> record set to the parent DNS records in the parent’s DNS system.</p>
<ul class="simple">
<li><p>To find the required values for the NS records, use the Azure portal to navigate to the new DNS Zone (click <code class="docutils literal notranslate"><span class="pre">All</span> <span class="pre">resources</span></code> in the far left panel and search for “DNS Zone”). The NS record will list 4 Azure name servers.</p></li>
<li><p>Duplicate these records to the parent DNS system as follows:</p>
<ul>
<li><p>If using a subdomain of an existing Azure DNS Zone, create an NS record set in the parent Azure DNS Zone. The name should be set to the subdomain, and the values duplicated from above (for example, for a new subdomain <code class="docutils literal notranslate"><span class="pre">testa.dsgroupdev.co.uk</span></code>, duplicate its NS record to the Azure DNS Zone for <code class="docutils literal notranslate"><span class="pre">dsgroupdev.co.uk</span></code>, under the name <code class="docutils literal notranslate"><span class="pre">testa</span></code>).</p></li>
<li><p>If using a new domain, create an NS record in at the registrar for the new domain with the same value as the NS record in the new Azure DNS Zone for the domain.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="setup-azure-active-directory-aad">
<h2>4. Setup Azure Active Directory (AAD)<a class="headerlink" href="#setup-azure-active-directory-aad" title="Permalink to this headline">¶</a></h2>
<section id="create-a-new-aad">
<h3>Create a new AAD<a class="headerlink" href="#create-a-new-aad" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Login to the <a class="reference external" href="https://azure.microsoft.com/en-gb/features/azure-portal/">Azure Portal</a></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">a</span> <span class="pre">Resource</span></code>  and search for <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code>
<img alt="AAD" src="_images/AAD.png" /></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Create</span></code></p></li>
<li><p>Set the “Organisation Name” to <code class="docutils literal notranslate"><span class="pre">&lt;organisation&gt;</span> <span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">&lt;environment&gt;</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">Turing</span> <span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Test</span> <span class="pre">A</span></code></p></li>
<li><p>Set the “Initial Domain Name” to the “Organisation Name” all lower case with spaces removed</p></li>
<li><p>Set the “Country or Region” to “United Kingdom”</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Create</span></code></p></li>
</ol>
</section>
<section id="add-the-custom-domain-to-the-new-aad">
<h3>Add the custom domain to the new AAD<a class="headerlink" href="#add-the-custom-domain-to-the-new-aad" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Directory</span></code> and then click <code class="docutils literal notranslate"><span class="pre">Custom</span> <span class="pre">domain</span> <span class="pre">names</span></code> in the left panel. Click <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">custom</span> <span class="pre">domain</span></code> at the top and create a new domain name (e.g. <code class="docutils literal notranslate"><span class="pre">testa.dsgroupdev.co.uk</span></code>)</p></li>
<li><p>If the Custom domain name blade shows <code class="docutils literal notranslate"><span class="pre">Status</span> <span class="pre">Verified</span></code> and no DNS details are displayed, you can skip to the next section. Otherwise, if you see DNS record details similar to the image below, you need to verify the domain. Note down the required details displayed and complete the following steps.
<img alt="AAD DNS record details" src="_images/aad_dns_record_details.png" /></p></li>
<li><p>In a separate Azure portal window, switch to the Turing directory and navigate to the DNS Zone for your custom domain within the <code class="docutils literal notranslate"><span class="pre">RG_SHM_DNS</span></code> resource group in the management subscription.</p></li>
<li><p>Create a new record using the details provided (the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> goes in the <code class="docutils literal notranslate"><span class="pre">Name</span></code> field and the TTL of 3600 is in seconds)
<img alt="Create AAD DNS Record" src="_images/create_aad_dns_record.png" /></p></li>
<li><p>Navigate back to the custom domain creation screen in the new AAD and click <code class="docutils literal notranslate"><span class="pre">Verify</span></code></p></li>
<li><p>Wait a few minutes then click on the domain that you just added and click the <code class="docutils literal notranslate"><span class="pre">Make</span> <span class="pre">primary</span></code> button.</p></li>
</ol>
</section>
</section>
<section id="deploy-key-vault-for-shm-secrets">
<h2>5. Deploy key vault for SHM secrets<a class="headerlink" href="#deploy-key-vault-for-shm-secrets" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/safe_haven_management_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Deploy and configure the RDS VMs by running <code class="docutils literal notranslate"><span class="pre">./Setup_SHM_KeyVault.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code>, where the SHM ID is the one specified in the config</p></li>
<li><p>This will take <strong>a few minutes</strong> to run.</p></li>
</ul>
</section>
<section id="setup-safe-haven-administrators">
<h2>6. Setup Safe Haven administrators<a class="headerlink" href="#setup-safe-haven-administrators" title="Permalink to this headline">¶</a></h2>
<section id="add-global-administrator">
<h3>Add global administrator<a class="headerlink" href="#add-global-administrator" title="Permalink to this headline">¶</a></h3>
<p>The User who creates the AAD will automatically have the Global Administrator (GA) Role (Users with this role have access to all administrative features in Azure Active Directory).</p>
<p>For some steps, a dedicated <strong>internal</strong> Global Administrator is required (e.g. to add P1 licences), so at least this additional administrator will need to be created.</p>
<ol class="simple">
<li><p>Ensure your Azure Portal session is using the new Safe Haven Management (SHM) AAD directory. The name of the current directory is under your username in the top right corner of the Azure portal screen. To change directories click on your username at the top right corner of the screen, then <code class="docutils literal notranslate"><span class="pre">Switch</span> <span class="pre">directory</span></code>, then the name of the new SHM directory.</p></li>
<li><p>On the left hand panel click <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code>.</p></li>
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">Users</span></code> and create a dedicated <strong>internal</strong> Global Administrator:</p>
<ul class="simple">
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">+New</span> <span class="pre">user</span></code> and enter the following details:</p>
<ul>
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">AAD</span> <span class="pre">Global</span> <span class="pre">Admin</span></code></p></li>
<li><p>Username: <code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code></p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Groups</span> <span class="pre">and</span> <span class="pre">roles</span> <span class="pre">&gt;</span> <span class="pre">Roles</span></code> change the role to <code class="docutils literal notranslate"><span class="pre">Global</span> <span class="pre">Administrator</span></code></p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Settings</span> <span class="pre">&gt;</span> <span class="pre">Usage</span> <span class="pre">location</span></code> change the location to <code class="docutils literal notranslate"><span class="pre">United</span> <span class="pre">Kingdom</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Create</span></code></p></li>
</ul>
</li>
<li><p>Click on the username in the users list in the Azure Active Directory</p></li>
<li><p>Click the “Reset password” icon to generate a temporary password</p></li>
<li><p>Use this password to log into https://portal.azure.com as the user <code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>. You will either need to log out of your existing account or open an incognito/private browsing window.</p></li>
<li><p>When prompted to change your password on first login:</p>
<ul>
<li><p>Look in the KeyVault under the <code class="docutils literal notranslate"><span class="pre">RG_SHM_SECRETS</span></code> resource group in the management subscription.</p></li>
<li><p>There should be a secret there called <code class="docutils literal notranslate"><span class="pre">shm-&lt;shmId&gt;-aad-admin-password</span></code></p></li>
<li><p>Use this as the new password</p></li>
<li><p>If you are prompted to associate a phone number and email address with the account - do so.</p></li>
</ul>
</li>
<li><p>Once you have set your password and logged in you can administer the Azure Active Directory with this user by selecting <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code> in the left hand sidebar</p></li>
</ul>
</li>
</ol>
</section>
<section id="add-additional-administrators-optional">
<h3>Add additional administrators (optional)<a class="headerlink" href="#add-additional-administrators-optional" title="Permalink to this headline">¶</a></h3>
<p>Giving additional users the GA role, prevents the user you set up earlier from being a single point of failure.</p>
<ol class="simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">Users</span></code> and add new admin users as above:</p>
<ul class="simple">
<li><p>Click on “+New user” and enter the following details:</p>
<ul>
<li><p>Name: <code class="docutils literal notranslate"><span class="pre">Admin</span> <span class="pre">-</span> <span class="pre">Firstname</span> <span class="pre">Lastname</span></code></p></li>
<li><p>Username: <code class="docutils literal notranslate"><span class="pre">admin.firstname.lastname&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code></p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Groups</span> <span class="pre">and</span> <span class="pre">roles</span> <span class="pre">&gt;</span> <span class="pre">Roles</span></code> change the role to <code class="docutils literal notranslate"><span class="pre">Global</span> <span class="pre">Administrator</span></code></p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Settings</span> <span class="pre">&gt;</span> <span class="pre">Usage</span> <span class="pre">location</span></code> change the location to <code class="docutils literal notranslate"><span class="pre">United</span> <span class="pre">Kingdom</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Create</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Let Azure set their passwords. They can reset these later.</p></li>
</ol>
<p>NB. You can also invite guest users from other Azure Active Directories at this stage</p>
<ul class="simple">
<li><p>If their account (<code class="docutils literal notranslate"><span class="pre">user&#64;domain</span></code>) does not have an associated mailbox, invite them as normal and then give them a direct link to the portal for a specific tenant (i.e. <code class="docutils literal notranslate"><span class="pre">https://portal.azure.com/&lt;tenant</span> <span class="pre">id&gt;</span></code>). When they click this they will get taken through the same process that would have happened from the email link. <a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/b2b/redemption-experience">Via Microsoft documentation</a></p></li>
</ul>
</section>
<section id="enable-mfa">
<h3>Enable MFA<a class="headerlink" href="#enable-mfa" title="Permalink to this headline">¶</a></h3>
<p>To enable MFA, purchase sufficient licences and add them to all the new users.</p>
<ul class="simple">
<li><p>You will also need licences for standard users accessing the Safe Haven.</p></li>
</ul>
<ol class="simple">
<li><p>Ensure that you are logged in as the “Local admin” user <code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code></p></li>
</ol>
<ul class="simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code> in the portal</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">&gt;</span> <span class="pre">Licences</span></code> in the left hand sidebar</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">All</span> <span class="pre">products</span></code> in the left hand sidebar</p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">+Try/Buy</span></code> text above the empty product list</p></li>
<li><p><strong>For production</strong> buy P1 licences:</p>
<ul>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">Purchase</span> <span class="pre">services</span></code> link in the infomation panel above the trial options.</p></li>
<li><p>In the “Microsoft 365 Admin Centre” portal that opens:</p>
<ul>
<li><p>Expand the <code class="docutils literal notranslate"><span class="pre">Billing</span></code> section of the left hand side bar</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Purchase</span> <span class="pre">services</span></code></p></li>
<li><p>Scroll down the list of products and select <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Premium</span> <span class="pre">P1</span></code> and click <code class="docutils literal notranslate"><span class="pre">Buy</span></code></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Pay</span> <span class="pre">monthly</span></code></p></li>
<li><p>Enter the number of licences required.</p></li>
<li><p>Leave <code class="docutils literal notranslate"><span class="pre">automatically</span> <span class="pre">assign</span> <span class="pre">all</span> <span class="pre">of</span> <span class="pre">your</span> <span class="pre">users</span> <span class="pre">with</span> <span class="pre">no</span> <span class="pre">licences</span></code> checked</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Check</span> <span class="pre">out</span> <span class="pre">now</span></code></p></li>
<li><p>Enter the address of the organisation running the Safe Haven on the next screen</p></li>
<li><p>Click next and enter payment details when requested</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>For testing</strong> you can enable a free trial of the P2 License (NB. It can take a while for these to appear on your AAD)</p>
<ul>
<li><p>Expand the <code class="docutils literal notranslate"><span class="pre">Free</span> <span class="pre">trial</span></code> arrow under <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">AD</span> <span class="pre">Premium</span> <span class="pre">P2</span></code></p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">Activate</span></code> button</p></li>
<li><p>Wait for around 20 minutes until the <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">AD</span> <span class="pre">Premium</span> <span class="pre">P2</span></code> licences appear on the list of <code class="docutils literal notranslate"><span class="pre">All</span> <span class="pre">Products</span></code></p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>Adding licenses to a user:</p></li>
</ol>
<ul class="simple">
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Users</span></code> in the left hand sidebar</p></li>
<li><p>For each user you want to add a licence to, click on their username</p>
<ul>
<li><p>Ensure that the user has <code class="docutils literal notranslate"><span class="pre">usage</span> <span class="pre">location</span></code> set under “Settings” (see image below):
<img alt="Set user location" src="_images/set_user_location.png" /></p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Licences</span></code> in the left hand sidebar</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">+</span> <span class="pre">Assignments</span></code> in the top bar</p></li>
<li><p>Assign <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Premium</span> <span class="pre">P1</span></code> and <code class="docutils literal notranslate"><span class="pre">Microsoft</span> <span class="pre">Azure</span> <span class="pre">Multi-Factor</span> <span class="pre">Authentication</span></code> then click <code class="docutils literal notranslate"><span class="pre">Save</span></code></p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>Configuring MFA on Azure Active Directory</p></li>
</ol>
<ul class="simple">
<li><p>Sign in to the Azure portal as a user administrator or global administrator.</p></li>
<li><p>Go to <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code> then click <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">&gt;</span> <span class="pre">Security</span></code> in the left hand side bar</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">&gt;</span> <span class="pre">MFA</span></code> in the left hand side bar</p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">Additional</span> <span class="pre">cloud-based</span> <span class="pre">MFA</span> <span class="pre">settings</span></code> link in the <code class="docutils literal notranslate"><span class="pre">Configure</span></code> section of the main panel (if this is not available, trying signing out of the portal and back in again)</p></li>
<li><p>Configure MFA as follows:</p>
<ul>
<li><p>In “App passwords” section select “Do not allow users to create app passwords to sign in to non-browser apps”</p></li>
<li><p>In “Verification options” section.</p>
<ul>
<li><p><strong>check</strong> “Call to phone” and “Notification through mobile app”</p></li>
<li><p><strong>uncheck</strong> “Text message to phone” and “Verification code from mobile app or hardware token”</p></li>
</ul>
</li>
<li><p>In “Remember multi-factor authentication” section</p>
<ul>
<li><p>ensure “Allow users to remember multi-factor authentication on devices they trust” is <strong>unchecked</strong></p></li>
</ul>
</li>
<li><p>Click “Save” and close window
<img alt="AAD MFA settings" src="_images/aad_mfa_settings.png" /></p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>Require MFA for all admins</p></li>
</ol>
<ul class="simple">
<li><p>Sign in to the Azure portal as a user administrator or global administrator.</p></li>
<li><p>Go to <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code> then click <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">&gt;</span> <span class="pre">Security</span></code> in the left hand side bar</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Protect</span> <span class="pre">&gt;</span> <span class="pre">Conditional</span> <span class="pre">access</span></code> in the left hand sidebar</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Baseline</span> <span class="pre">policy:</span> <span class="pre">Require</span> <span class="pre">MFA</span> <span class="pre">for</span> <span class="pre">admins</span></code></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Use</span> <span class="pre">policy</span> <span class="pre">immediately</span></code> in the left hand side bar</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Save</span></code></p></li>
</ul>
</section>
</section>
<section id="deploy-and-configure-vnet-and-domain-controllers">
<h2>7. Deploy and configure VNET and Domain Controllers<a class="headerlink" href="#deploy-and-configure-vnet-and-domain-controllers" title="Permalink to this headline">¶</a></h2>
<section id="deploy-the-virtual-network-and-active-directory-domain-controller">
<h3>Deploy the Virtual Network and Active Directory Domain Controller<a class="headerlink" href="#deploy-the-virtual-network-and-active-directory-domain-controller" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/safe_haven_management_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Deploy and configure the RDS VMs by running <code class="docutils literal notranslate"><span class="pre">./Setup_SHM_DC.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code>, where the SHM ID is the one specified in the config</p></li>
<li><p>This will take <strong>around one hour</strong> to run.</p></li>
<li><p>Once the script exits successfully you should see the following resource groups under the SHM subscription:
<img alt="Resource groups" src="_images/resource_groups.png" /></p></li>
</ul>
</section>
<section id="download-a-client-vpn-certificate-for-the-safe-haven-management-vnet">
<h3>Download a client VPN certificate for the Safe Haven Management VNet<a class="headerlink" href="#download-a-client-vpn-certificate-for-the-safe-haven-management-vnet" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Navigate to the SHM Key Vault via <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SHM_SECRETS</span> <span class="pre">-&gt;</span> <span class="pre">kv-shm-&lt;shm-id&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code> will be the one defined in the config file.</p></li>
<li><p>Once there open the “Certificates” page under the “Settings” section in the left hand sidebar.</p></li>
<li><p>Click on the certificate named <code class="docutils literal notranslate"><span class="pre">shm-&lt;shmId&gt;-vpn-client-cert</span></code>, click on the “current version” and click the “Download in PFX/PEM format” link.</p></li>
<li><p>To install, double click on the downloaded certificate (or on OSX you can manually drag it into the “login” keychain), leaving the password field blank.</p></li>
</ol>
<p><strong>Make sure to securely delete the “*.pfx” certificate file after you have installed it.</strong></p>
</section>
<section id="configure-a-vpn-connection-to-the-safe-haven-management-vnet">
<h3>Configure a VPN connection to the Safe Haven Management VNet<a class="headerlink" href="#configure-a-vpn-connection-to-the-safe-haven-management-vnet" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Navigate to the Safe Haven Management (SHM) VNet gateway in the SHM subscription via <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SHM_NETWORKING</span> <span class="pre">-&gt;</span> <span class="pre">VNET_SHM_&lt;shm-id&gt;_GW</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code> will be the one defined in the config file.</p></li>
<li><p>Once there open the “Point-to-site configuration page under the “Settings” section in the left hand sidebar (see image below).</p></li>
<li><p>Click the “Download VPN client” link at the top of the page to get the root certificate (<code class="docutils literal notranslate"><span class="pre">VpnServerRoot.cer</span></code>) and VPN configuration file (<code class="docutils literal notranslate"><span class="pre">VpnSettings.xml</span></code>)
<img alt="certificate details" src="_images/certificate_details.png" /></p></li>
<li><p>Read through the following notes, then follow the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-vpn-client-configuration-azure-cert">VPN set up instructions</a> using the Windows or Mac sections as appropriate.</p></li>
</ol>
<p><strong>NOTES:</strong></p>
<ul class="simple">
<li><p><strong>You do not need to install the <code class="docutils literal notranslate"><span class="pre">VpnServerRoot.cer</span></code> certificate, as we’re using our own self-signed root certificate</strong></p></li>
<li><p>Use SSTP (Windows) or IKEv2 (OSX) for the VPN type</p></li>
<li><p>Name the VPN connection “Safe Haven Management Gateway (<code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code>)”, where <code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code> will be the one defined in the config file.</p></li>
<li><p><strong>Windows:</strong> do not rename the VPN client as this will break it</p></li>
<li><p><strong>Windows:</strong> you may get a “Windows protected your PC” pop up. If so, click <code class="docutils literal notranslate"><span class="pre">More</span> <span class="pre">info</span> <span class="pre">-&gt;</span> <span class="pre">Run</span> <span class="pre">anyway</span></code>.</p></li>
<li><p><strong>OSX:</strong> you can view the details of the downloaded certificate by highlighting the certificate file in Finder and pressing the spacebar. You can then look for the certificate of the same name in the login KeyChain and view its details by double clicking the list entry. If the details match the certificate has been successfully installed.</p></li>
</ul>
<p>You should now be able to connect to the SHM virtual network via the VPN. Each time you need to access the virtual network ensure you are connected via the VPN.</p>
</section>
<section id="access-the-first-domain-controller-dc1-via-remote-desktop">
<h3>Access the first Domain Controller (DC1) via Remote Desktop<a class="headerlink" href="#access-the-first-domain-controller-dc1-via-remote-desktop" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Open Microsoft Remote Desktop</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Desktop</span></code></p></li>
<li><p>In the Azure portal, navigate to the <code class="docutils literal notranslate"><span class="pre">RG_SHM_DC</span></code> resource group and then to the <code class="docutils literal notranslate"><span class="pre">DC1-SHM-&lt;shm-id&gt;</span></code> virtual machine (VM).</p></li>
<li><p>Copy the Private IP address and enter it in the <code class="docutils literal notranslate"><span class="pre">PC</span> <span class="pre">name</span></code> field on remote desktop. Click Add.</p></li>
<li><p>Double click on the desktop that appears under <code class="docutils literal notranslate"><span class="pre">saved</span> <span class="pre">desktops</span></code>.</p></li>
<li><p>Log in as a <strong>domain</strong> user (ie. <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>) using the username and password obtained from the Azure portal as follows:
rather than simply <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;</span></code>)</p></li>
</ol>
<ul class="simple">
<li><p>On the Azure portal navigate to the <code class="docutils literal notranslate"><span class="pre">RG_SHM_SECRETS</span></code> resource group and then the <code class="docutils literal notranslate"><span class="pre">kv-shm-&lt;shm-id&gt;</span></code> key vault and then select <code class="docutils literal notranslate"><span class="pre">secrets</span></code> on the left hand panel.</p></li>
<li><p>The username is the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-dcnps-admin-username</span></code> secret. Add your custom AD domain to the username so the login is <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;SHMm</span> <span class="pre">domain&gt;</span></code> rather than simply <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;</span></code>.</p></li>
<li><p>The password in the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-dcnps-admin-password</span></code> secret.</p></li>
</ul>
<ol class="simple">
<li><p>If you see a warning dialog that the certificate cannot be verified as root, accept this and continue.</p></li>
</ol>
</section>
<section id="install-azure-active-directory-connect">
<h3>Install Azure Active Directory Connect<a class="headerlink" href="#install-azure-active-directory-connect" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code></p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">AzureADConnect.msi</span></code> installer</p></li>
</ol>
<ul class="simple">
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Welcome</span> <span class="pre">to</span> <span class="pre">Azure</span> <span class="pre">AD</span> <span class="pre">Connect</span></code> screen:</p>
<ul>
<li><p>Tick the <code class="docutils literal notranslate"><span class="pre">I</span> <span class="pre">agree</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">license</span> <span class="pre">terms</span></code> box</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Continue</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Express</span> <span class="pre">Settings</span></code> screen:</p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Customize</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Install</span> <span class="pre">required</span> <span class="pre">components</span></code> screen:</p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Install</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">User</span> <span class="pre">sign-in</span></code> screen:</p>
<ul>
<li><p>Ensure that <code class="docutils literal notranslate"><span class="pre">Password</span> <span class="pre">Hash</span> <span class="pre">Synchronization</span></code> is selected</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Connect</span> <span class="pre">to</span> <span class="pre">Azure</span> <span class="pre">AD</span></code> screen:</p>
<ul>
<li><p>Provide a global administrator details for the Azure Active Directory you are connected to</p></li>
<li><p>You should have created <code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code> during the <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">additional</span> <span class="pre">administrators</span></code> step and its password should be stored in the Key Vault</p>
<ul>
<li><p>If you receive an Internet Explorer pop-up dialog “Content within this application coming from the website below is being blocked by Internet Explorer Advanced Security Configuration: https://login.microsoft.com”</p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Add</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Add</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Close</span></code></p></li>
<li><p>Repeat for the same dialog with <code class="docutils literal notranslate"><span class="pre">https://aadcdn.msftauth.net</span></code></p></li>
</ul>
</li>
<li><p>If you receive an error box <code class="docutils literal notranslate"><span class="pre">We</span> <span class="pre">can't</span> <span class="pre">sign</span> <span class="pre">you</span> <span class="pre">in,.</span> <span class="pre">Javascript</span> <span class="pre">is</span> <span class="pre">required</span> <span class="pre">to</span> <span class="pre">sign</span> <span class="pre">you</span> <span class="pre">in.</span> <span class="pre">Do</span> <span class="pre">you</span> <span class="pre">want</span> <span class="pre">to</span> <span class="pre">continue</span> <span class="pre">running</span> <span class="pre">scripts</span> <span class="pre">on</span> <span class="pre">this</span> <span class="pre">page</span></code></p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Yes</span></code></p></li>
<li><p>Close the dialog by clicking <code class="docutils literal notranslate"><span class="pre">X</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Enter the global administrator password if prompted</p></li>
<li><p>Back on the <code class="docutils literal notranslate"><span class="pre">Connect</span> <span class="pre">to</span> <span class="pre">Azure</span> <span class="pre">AD</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
<li><p>Approve the login with MFA if required</p>
<ul>
<li><p>If you see a Windows Security Warning, check <code class="docutils literal notranslate"><span class="pre">Don't</span> <span class="pre">show</span> <span class="pre">this</span> <span class="pre">message</span> <span class="pre">again</span> <span class="pre">and</span> <span class="pre">click</span> <span class="pre">&quot;Yes</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Connect</span> <span class="pre">your</span> <span class="pre">directories</span></code> screen:</p>
<ul>
<li><p>Ensure that correct forest (your custom domain name; e.g <code class="docutils literal notranslate"><span class="pre">turingsafehaven.ac.uk</span></code>) is selected and click “Add Directory”</p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">AD</span> <span class="pre">forest</span> <span class="pre">account</span></code> pop-up:</p>
<ul>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Use</span> <span class="pre">existing</span> <span class="pre">AD</span> <span class="pre">account</span></code></p></li>
<li><p>Enter the details for the <code class="docutils literal notranslate"><span class="pre">localadsync</span></code> user.</p>
<ul>
<li><p>Username: <code class="docutils literal notranslate"><span class="pre">localadsync&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code> (e.g. localadsync)</p></li>
<li><p>Password: use the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-localadsync-password</span></code> secret in the management Key Vault.</p></li>
</ul>
</li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code></p></li>
<li><p><strong>Troubleshooting:</strong> if you get an error that the username/password is incorrect or that the domain/directory could not be found, try resetting the password for this user to the secret value from the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-localadsync-password</span></code> secret in the management Key Vault.</p>
<ul>
<li><p>In Server Manager click <code class="docutils literal notranslate"><span class="pre">Tools</span> <span class="pre">&gt;</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Users</span> <span class="pre">and</span> <span class="pre">Computers</span></code></p></li>
<li><p>Expand the domain in the left hand panel</p></li>
<li><p>Expand the <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Service</span> <span class="pre">Accounts</span></code> OU</p></li>
<li><p>Right click on the “Local AD Sync Administrator” user and select “reset password”</p></li>
<li><p>Set the password to the the secret value from the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-localadsync-password</span></code> secret in the management Key Vault.</p></li>
<li><p>Leave the other settings as is and click “Ok”</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">AD</span> <span class="pre">sign-in</span> <span class="pre">configuration</span></code> screen:</p>
<ul>
<li><p>Verify that the <code class="docutils literal notranslate"><span class="pre">User</span> <span class="pre">Principal</span> <span class="pre">Name</span></code> is set to <code class="docutils literal notranslate"><span class="pre">userPrincipalName</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Domain</span> <span class="pre">and</span> <span class="pre">OU</span> <span class="pre">filtering</span></code> screen:</p>
<ul>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Sync</span> <span class="pre">Selected</span> <span class="pre">domains</span> <span class="pre">and</span> <span class="pre">OUs</span></code></p></li>
<li><p>Expand the domain and deselect all objects</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Research</span> <span class="pre">Users</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Uniquely</span> <span class="pre">identifying</span> <span class="pre">your</span> <span class="pre">users</span></code> screen:</p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Filter</span> <span class="pre">users</span> <span class="pre">and</span> <span class="pre">devices</span></code> screen:</p>
<ul>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Synchronize</span> <span class="pre">all</span> <span class="pre">users</span> <span class="pre">and</span> <span class="pre">devices</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Optional</span> <span class="pre">features</span></code> screen:</p>
<ul>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Password</span> <span class="pre">Writeback</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Ready</span> <span class="pre">to</span> <span class="pre">configure</span></code> screen:</p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Install</span></code></p></li>
<li><p>This may take a few minutes to complete</p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Configuration</span> <span class="pre">complete</span></code> screen:</p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Exit</span></code></p></li>
</ul>
</li>
<li><p><strong>Troubleshooting:</strong> The error <code class="docutils literal notranslate"><span class="pre">Directory</span> <span class="pre">synchronization</span> <span class="pre">is</span> <span class="pre">currently</span> <span class="pre">in</span> <span class="pre">a</span> <span class="pre">pending</span> <span class="pre">disabled</span> <span class="pre">state</span> <span class="pre">for</span> <span class="pre">this</span> <span class="pre">directory.</span> <span class="pre">Please</span> <span class="pre">wait</span> <span class="pre">until</span> <span class="pre">directory</span> <span class="pre">synchronization</span> <span class="pre">has</span> <span class="pre">been</span> <span class="pre">fully</span> <span class="pre">disabled</span> <span class="pre">before</span> <span class="pre">trying</span> <span class="pre">again</span></code> may occur if you have recently torn down another SHM linked to the same Azure Active Directory. You need to wait for the Azure Active Directory to fully disconnect - this can take up to 72 hours but is typically sooner. You do not need to close the installer window while waiting. If you need to, you can disconnect from the RDS and VPN and reconnect later before clicking <code class="docutils literal notranslate"><span class="pre">Retry</span></code>.</p></li>
</ul>
</section>
<section id="set-aad-sync-permissions">
<h3>Set AAD sync permissions<a class="headerlink" href="#set-aad-sync-permissions" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">localadsync&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code> account needs to be given permissions to change passwords or self-service password reset will not work.</p>
<ul class="simple">
<li><p>In Server Manager select <code class="docutils literal notranslate"><span class="pre">Tools</span> <span class="pre">&gt;</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Users</span> <span class="pre">and</span> <span class="pre">Computers</span></code> (or open the <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Users</span> <span class="pre">and</span> <span class="pre">Computers</span></code> desktop app directly)</p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">View</span></code> menu item and make sure that <code class="docutils literal notranslate"><span class="pre">Advanced</span> <span class="pre">Features</span></code> is enabled</p></li>
<li><p>Right click on the root domain (eg. <code class="docutils literal notranslate"><span class="pre">dsgroupdev.co.uk</span></code>) in the left-hand window and select <code class="docutils literal notranslate"><span class="pre">Properties</span></code>
<img alt="AD permissions properties" src="_images/aad_permissions_properties.png" /></p></li>
<li><p>In the pop-up window, go to the <code class="docutils literal notranslate"><span class="pre">Security</span></code> tab and click on the <code class="docutils literal notranslate"><span class="pre">Advanced</span></code> button
<img alt="AD permissions security" src="_images/aad_permissions_security.png" /></p></li>
<li><p>In the pop-up window, click on the <code class="docutils literal notranslate"><span class="pre">Add</span></code> button</p>
<ul>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">a</span> <span class="pre">principal</span></code> and then select the <code class="docutils literal notranslate"><span class="pre">localadsync&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code> by typing the first few letters into the search box and clicking on <code class="docutils literal notranslate"><span class="pre">Check</span> <span class="pre">Names</span></code>. When the <code class="docutils literal notranslate"><span class="pre">localadsync&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code> principal is selected, click <code class="docutils literal notranslate"><span class="pre">OK</span></code> to return to the <code class="docutils literal notranslate"><span class="pre">Permissions</span> <span class="pre">Entry</span> <span class="pre">for</span> <span class="pre">&lt;SHM</span> <span class="pre">domain&gt;</span></code> window.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Applies</span> <span class="pre">to</span></code> section, select <code class="docutils literal notranslate"><span class="pre">Descendant</span> <span class="pre">User</span> <span class="pre">objects</span></code></p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Permissions</span></code>, ensure that the following options are checked:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Reset</span> <span class="pre">password</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Change</span> <span class="pre">password</span></code></p></li>
</ul>
</li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Properties</span></code>, ensure that the following options are checked (NB. there are a lot of properties, so this might take some scrolling. <em>The properties are listed in alphabetical order of the main part of the property name excluding the initial prefix Read/Write etc)</em>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Write</span> <span class="pre">lockoutTime</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Write</span> <span class="pre">pwdLastSet</span></code></p></li>
</ul>
</li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code></p></li>
</ul>
</li>
<li><p>Now go through the same procedure, this time selecting <code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">object</span> <span class="pre">and</span> <span class="pre">all</span> <span class="pre">descendant</span> <span class="pre">objects</span></code> in the <code class="docutils literal notranslate"><span class="pre">Applies</span> <span class="pre">to</span></code> section</p>
<ul>
<li><p>Enable the following under <code class="docutils literal notranslate"><span class="pre">Permissions</span></code>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Replicating</span> <span class="pre">Directory</span> <span class="pre">Changes</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Replicating</span> <span class="pre">Directory</span> <span class="pre">Changes</span> <span class="pre">All</span></code></p></li>
</ul>
</li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> on all open dialog boxes</p></li>
</ul>
</li>
</ul>
</section>
<section id="additional-aad-connect-configuration">
<h3>Additional AAD Connect Configuration<a class="headerlink" href="#additional-aad-connect-configuration" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Open <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">AD</span> <span class="pre">Connect</span> <span class="pre">&gt;</span> <span class="pre">Synchronization</span> <span class="pre">Rules</span> <span class="pre">Editor</span></code> from the start menu</p></li>
</ol>
<p><img alt="synchronisation rules" src="_images/synchronisation_rules.png" /></p>
<ol class="simple">
<li><p>Change the <code class="docutils literal notranslate"><span class="pre">Direction</span></code> drop down to <code class="docutils literal notranslate"><span class="pre">Outbound</span></code></p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Out</span> <span class="pre">to</span> <span class="pre">AAD</span> <span class="pre">-</span> <span class="pre">User</span> <span class="pre">Join</span></code> rule.</p></li>
</ol>
<ul class="simple">
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Disable</span></code>.</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Edit</span></code>.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">Reserved</span> <span class="pre">Rule</span> <span class="pre">Confirmation</span></code> dialog box click <code class="docutils literal notranslate"><span class="pre">Yes</span></code></p></li>
</ul>
<ol class="simple">
<li><p>In the editing view set <code class="docutils literal notranslate"><span class="pre">precedence</span></code> to 1.</p></li>
</ol>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Transformations</span></code> from the sidebar and locate the rule with its <code class="docutils literal notranslate"><span class="pre">Target</span> <span class="pre">Attribute</span></code> set to <code class="docutils literal notranslate"><span class="pre">usageLocation</span></code></p>
<ul>
<li><p>Change the <code class="docutils literal notranslate"><span class="pre">FlowType</span></code> column from <code class="docutils literal notranslate"><span class="pre">Expression</span></code> to <code class="docutils literal notranslate"><span class="pre">Direct</span></code></p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Source</span></code> column click the drop-down menu and select <code class="docutils literal notranslate"><span class="pre">c</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Save</span></code> (in the <code class="docutils literal notranslate"><span class="pre">Warning</span></code> dialog box click <code class="docutils literal notranslate"><span class="pre">OK</span></code>)</p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>You will now see a cloned version of the <code class="docutils literal notranslate"><span class="pre">Out</span> <span class="pre">to</span> <span class="pre">AAD</span> <span class="pre">-</span> <span class="pre">User</span> <span class="pre">Join</span></code>.</p></li>
</ol>
<ul class="simple">
<li><p>Delete the original.</p></li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Warning</span></code> dialog box click <code class="docutils literal notranslate"><span class="pre">OK</span></code></p></li>
</ul>
<ol class="simple">
<li><p>Edit the cloned version.</p></li>
</ol>
<ul class="simple">
<li><p>Change <code class="docutils literal notranslate"><span class="pre">Precedence</span></code> to 115</p></li>
<li><p>Edit the name to <code class="docutils literal notranslate"><span class="pre">Out</span> <span class="pre">to</span> <span class="pre">AAD</span> <span class="pre">-</span> <span class="pre">User</span> <span class="pre">Join</span></code>.</p></li>
<li><p>Click “Save” (in the “Warning” dialog box click “OK”).</p></li>
</ul>
<ol class="simple">
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Enable</span></code> on the <code class="docutils literal notranslate"><span class="pre">Out</span> <span class="pre">to</span> <span class="pre">AAD</span> <span class="pre">-</span> <span class="pre">User</span> <span class="pre">Join</span></code> rule that you have just edited</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">X</span></code> to close the <code class="docutils literal notranslate"><span class="pre">Synchronization</span> <span class="pre">Rules</span> <span class="pre">Editor</span></code> window</p></li>
<li><p>Open Powershell as an administrator</p></li>
</ol>
<ul class="simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">.\Run_ADSync.ps1</span></code></p></li>
</ul>
</section>
<section id="validation-of-ad-sync">
<h3>Validation of AD sync<a class="headerlink" href="#validation-of-ad-sync" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Add a research user:</p></li>
</ol>
<ul class="simple">
<li><p>In Server Manager select <code class="docutils literal notranslate"><span class="pre">Tools</span> <span class="pre">&gt;</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Users</span> <span class="pre">and</span> <span class="pre">Computers</span></code> (or open the <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Users</span> <span class="pre">and</span> <span class="pre">Computers</span></code> desktop app directly)</p></li>
<li><p>Expand the domain</p></li>
<li><p>Right click on the <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Research</span> <span class="pre">Users</span></code> OU and select <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">-&gt;</span> <span class="pre">User</span></code></p></li>
<li><p>Create a new user:</p>
<ul>
<li><p>First name: <code class="docutils literal notranslate"><span class="pre">Test</span></code></p></li>
<li><p>Last name: <code class="docutils literal notranslate"><span class="pre">ADUser</span></code></p></li>
<li><p>User login name: <code class="docutils literal notranslate"><span class="pre">testaduser</span></code></p></li>
<li><p>Click “Next”</p></li>
</ul>
</li>
<li><p>Password: use the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-testaduser-password</span></code> secret in the management Key Vault.</p>
<ul>
<li><p>Untick <code class="docutils literal notranslate"><span class="pre">User</span> <span class="pre">must</span> <span class="pre">change</span> <span class="pre">password</span> <span class="pre">at</span> <span class="pre">next</span> <span class="pre">logon</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Finish</span></code></p></li>
</ul>
<ol class="simple">
<li><p>Force a sync to the Azure Active Directory</p></li>
</ol>
<ul class="simple">
<li><p>Open Powershell as an administrator</p></li>
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">.\Run_ADSync.ps1</span> <span class="pre">-sync</span> <span class="pre">Delta</span></code></p></li>
</ul>
<ol class="simple">
<li><p>Go to the Azure Active Directory in <code class="docutils literal notranslate"><span class="pre">portal.azure.com</span></code></p></li>
</ol>
<ul class="simple">
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Users</span> <span class="pre">&gt;</span> <span class="pre">All</span> <span class="pre">users</span></code> and confirm that the new user is shown in the user list.</p></li>
<li><p>It may take a few minutes for the synchronisation to fully propagate in Azure.</p></li>
</ul>
</section>
<section id="configure-aad-side-of-ad-connect">
<h3>Configure AAD side of AD connect<a class="headerlink" href="#configure-aad-side-of-ad-connect" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Go to the Azure Active Directory in <code class="docutils literal notranslate"><span class="pre">portal.azure.com</span></code></p></li>
</ol>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">&gt;</span> <span class="pre">Password</span> <span class="pre">reset</span></code> from the left hand menu</p></li>
</ul>
<ol class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">On-premises</span> <span class="pre">integration</span></code> from the left hand side bar</p></li>
</ol>
<ul class="simple">
<li><p>Ensure <code class="docutils literal notranslate"><span class="pre">Write</span> <span class="pre">back</span> <span class="pre">passwords</span> <span class="pre">to</span> <span class="pre">your</span> <span class="pre">on-premises</span> <span class="pre">directory</span></code> is set to yes.
<img alt="Enable writeback" src="_images/enable_writeback.png" /></p></li>
<li><p>If you changed this setting, click the <code class="docutils literal notranslate"><span class="pre">Save</span></code> icon</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Properties</span></code> from the left hand side bar</p>
<ul>
<li><p>Make sure that <code class="docutils literal notranslate"><span class="pre">Self</span> <span class="pre">service</span> <span class="pre">password</span> <span class="pre">reset</span> <span class="pre">enabled</span></code> is set to <code class="docutils literal notranslate"><span class="pre">All</span></code>
<img alt="Enable password reset" src="_images/enable_passwordreset.png" /></p></li>
<li><p>If you changed this setting, click the <code class="docutils literal notranslate"><span class="pre">Save</span></code> icon</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="deploy-and-configure-network-policy-server-nps">
<h2>8. Deploy and configure Network Policy Server (NPS)<a class="headerlink" href="#deploy-and-configure-network-policy-server-nps" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/safe_haven_management_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Deploy and configure the RDS VMs by running <code class="docutils literal notranslate"><span class="pre">./Setup_SHM_NPS.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code>, where the SHM ID is the one specified in the config</p></li>
<li><p>This will take <strong>around 10 minutes</strong> to run.</p>
<ul>
<li><p><strong>Troubleshooting:</strong> If you see an error similar to <code class="docutils literal notranslate"><span class="pre">New-AzResourceGroupDeployment</span> <span class="pre">:</span> <span class="pre">Resource</span> <span class="pre">Microsoft.Compute/virtualMachines/extensions</span> <span class="pre">NPS-SHM-&lt;SHM</span> <span class="pre">ID&gt;/joindomain'</span> <span class="pre">failed</span> <span class="pre">with</span> <span class="pre">message</span></code> you may find this error resolves if you wait and retry later. Alternatively, you can try deleting the extension from the <code class="docutils literal notranslate"><span class="pre">NPS-SHM-&lt;SHM</span> <span class="pre">ID&gt;</span> <span class="pre">&gt;</span> <span class="pre">Extensions</span></code> blade in the Azure portal.</p></li>
</ul>
</li>
</ul>
<section id="configure-nps-server">
<h3>Configure NPS server<a class="headerlink" href="#configure-nps-server" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Log in to the NPS Server VM using Microsoft Remote Desktop</p></li>
</ol>
<ul class="simple">
<li><p>the private IP address for the SHM NPS VM can be found in the <code class="docutils literal notranslate"><span class="pre">RG_SHM_NPS</span></code> resource group</p></li>
<li><p>the Username and Password are the same as for <code class="docutils literal notranslate"><span class="pre">DC1-SHM</span></code> and <code class="docutils literal notranslate"><span class="pre">DC2-SHM</span></code> (ie the credentials you used above to Remote Desktop into the domain controller above):</p></li>
<li><p>To obtain the login credentials again, on the Azure portal navigate to the <code class="docutils literal notranslate"><span class="pre">RG_SHM_SECRETS</span></code> resource group and then the <code class="docutils literal notranslate"><span class="pre">kv-shm-&lt;shm-id&gt;</span></code> key vault and then select <code class="docutils literal notranslate"><span class="pre">secrets</span></code> on the left hand panel.</p></li>
<li><p>The username is the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-dcnps-admin-username</span></code> secret plus the domain, ie <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;custom</span> <span class="pre">domain</span></code></p></li>
<li><p>The password in the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-dcnps-admin-password</span></code> secret.</p></li>
</ul>
<ol class="simple">
<li><p>In Server Manager select <code class="docutils literal notranslate"><span class="pre">Tools</span> <span class="pre">&gt;</span> <span class="pre">Network</span> <span class="pre">Policy</span> <span class="pre">Server</span></code> (or open the <code class="docutils literal notranslate"><span class="pre">Network</span> <span class="pre">Policy</span> <span class="pre">Server</span></code> desktop app directly)</p></li>
<li><p>Configure NPS server to log to text file:</p></li>
</ol>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">NPS</span> <span class="pre">(Local)</span> <span class="pre">&gt;</span> <span class="pre">Accounting</span></code> on the left-hand sidebar
<img alt="NPS accounting" src="_images/nps_accounting.png" /></p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Accounting</span> <span class="pre">&gt;</span> <span class="pre">Configure</span> <span class="pre">Accounting</span></code></p>
<ul>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Introduction</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">Accounting</span> <span class="pre">Options</span></code> screen, select <code class="docutils literal notranslate"><span class="pre">Log</span> <span class="pre">to</span> <span class="pre">text</span> <span class="pre">file</span> <span class="pre">on</span> <span class="pre">the</span> <span class="pre">local</span> <span class="pre">computer</span></code> then click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Configure</span> <span class="pre">Local</span> <span class="pre">File</span> <span class="pre">Logging</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Summary</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Conclusions</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Close</span></code>.</p></li>
</ul>
</li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Log</span> <span class="pre">file</span> <span class="pre">properties</span> <span class="pre">&gt;</span> <span class="pre">Change</span> <span class="pre">log</span> <span class="pre">file</span> <span class="pre">properties</span></code></p>
<ul>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Log</span> <span class="pre">file</span></code> tab, select <code class="docutils literal notranslate"><span class="pre">Daily</span></code> under <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">a</span> <span class="pre">new</span> <span class="pre">log</span> <span class="pre">file</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Ok</span></code></p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>Add NPS policy to allow connections</p></li>
</ol>
<ul class="simple">
<li><p>Select <code class="docutils literal notranslate"><span class="pre">NPS</span> <span class="pre">(Local)</span> <span class="pre">&gt;</span> <span class="pre">Policies</span> <span class="pre">&gt;</span> <span class="pre">Network</span> <span class="pre">policies</span></code> on the left-hand sidebar
<img alt="NPS network policies" src="_images/nps_network_policies.png" /></p></li>
<li><p>Right click on <code class="docutils literal notranslate"><span class="pre">Network</span> <span class="pre">policies</span></code> and select <code class="docutils literal notranslate"><span class="pre">New</span></code></p>
<ul>
<li><p>Set the policy name to <code class="docutils literal notranslate"><span class="pre">RDG_CAP</span></code> and click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Add</span></code> to add a restriction</p>
<ul>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Day</span> <span class="pre">and</span> <span class="pre">Time</span> <span class="pre">Restrictions</span></code> and click <code class="docutils literal notranslate"><span class="pre">Add</span></code></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Permitted</span></code> (the whole weekly calendar should turn blue) and click <code class="docutils literal notranslate"><span class="pre">OK</span></code>.</p></li>
</ul>
</li>
<li><p>Back on the <code class="docutils literal notranslate"><span class="pre">Specify</span> <span class="pre">Conditions</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Specify</span> <span class="pre">Access</span> <span class="pre">Permission</span></code> screen:</p>
<ul>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code>, leaving <code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">granted</span></code> checked</p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Configure</span> <span class="pre">authentication</span> <span class="pre">methods</span></code> screen:</p>
<ul>
<li><p>Check the <code class="docutils literal notranslate"><span class="pre">Allow</span> <span class="pre">clients</span> <span class="pre">to</span> <span class="pre">connect</span> <span class="pre">without</span> <span class="pre">negotiating</span> <span class="pre">an</span> <span class="pre">authentication</span> <span class="pre">method</span></code> checkbox</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">No</span></code> on the <code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">Request</span> <span class="pre">Policy</span></code> pop up.</p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Configure</span> <span class="pre">constraints</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Configure</span> <span class="pre">settings</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Completing</span> <span class="pre">network</span> <span class="pre">policy</span></code> screen, click <code class="docutils literal notranslate"><span class="pre">Finish</span></code></p></li>
</ul>
</li>
</ul>
<p><strong>NOTE:</strong> If this policy is not present, then users will not be prompted for MFA when launching an RDS app.
This is because, without this policy, the NPS server will reject their authentication with the following error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">-</span> <span class="n">Event</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">6273</span>
  <span class="o">-</span> <span class="n">First</span> <span class="n">line</span> <span class="n">of</span> <span class="n">even</span> <span class="n">message</span><span class="p">:</span> <span class="n">Network</span> <span class="n">Policy</span> <span class="n">Server</span> <span class="n">discarded</span> <span class="n">the</span> <span class="n">request</span> <span class="k">for</span> <span class="n">a</span> <span class="n">user</span><span class="o">.</span>
  <span class="o">-</span> <span class="n">Reason</span> <span class="n">Code</span><span class="p">:</span> <span class="mi">21</span>
  <span class="o">-</span> <span class="n">Reason</span><span class="p">:</span> <span class="n">An</span> <span class="n">NPS</span> <span class="n">extension</span> <span class="n">dynamic</span> <span class="n">link</span> <span class="n">library</span> <span class="p">(</span><span class="n">DLL</span><span class="p">)</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">installed</span> <span class="n">on</span> <span class="n">the</span> <span class="n">NPS</span> <span class="n">server</span> <span class="n">rejected</span> <span class="n">the</span> <span class="n">connection</span> <span class="n">request</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="mfa-configuation">
<h3>MFA Configuation<a class="headerlink" href="#mfa-configuation" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code></p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">NpsExtnForAzureMfaInstaller.exe</span></code> installer</p></li>
<li><p>Agree the license terms and click “Install”</p></li>
<li><p>Click “Close” once the install has completed</p></li>
<li><p>Run PowerShell as administrator and run:</p></li>
</ol>
<div class="highlight-pwsh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd </span><span class="s2">&quot;C:\Program Files\Microsoft\AzureMfa\Config&quot;</span>
<span class="p">.\</span><span class="n">AzureMfaNpsExtnConfigSetup</span><span class="p">.</span><span class="n">ps1</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Enter <code class="docutils literal notranslate"><span class="pre">A</span></code> when prompted</p></li>
<li><p>If you are prompted to add webpages to exceptions then accept them.</p></li>
<li><p><strong>NOTE:</strong> You may get a Javascript error. If you do, simply run this script again.</p></li>
<li><p><strong>Troubleshooting:</strong> If you see an error <code class="docutils literal notranslate"><span class="pre">New-MsolServicePrincipalCredential</span> <span class="pre">:</span> <span class="pre">Service</span> <span class="pre">principal</span> <span class="pre">was</span> <span class="pre">not</span> <span class="pre">found</span></code>, this indicates that the <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Multi-Factor</span> <span class="pre">Auth</span> <span class="pre">Client</span></code> is not enabled in Azure Active Directory.</p>
<ul>
<li><p>Look at <a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-nps-extension#troubleshooting">the documentation here</a>.</p></li>
<li><p>Make sure the Safe Haven Azure Active Directory has valid P1 licenses:</p>
<ul>
<li><p>Go to the Azure Portal and click <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directories</span></code> in the left hand side bar</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Licenses</span></code>in the left hand side bar then <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">&gt;</span> <span class="pre">All</span> <span class="pre">products</span></code></p></li>
<li><p>You should see <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Premium</span> <span class="pre">P1</span></code> in the list of products, with a non-zero number of available licenses.</p>
<ul>
<li><p>If you do not have P1 licences, purchase some following the instructions at the end of the <a class="reference external" href="#Add-additional-administrators">Add additional administrators</a> section above, making sure to also follow the final step to configure the MFA settings on the Azure Active Directory.</p></li>
</ul>
</li>
<li><p>If you are using the trial <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Premium</span> <span class="pre">P2</span></code> licences, you may find that enabling a trial of <code class="docutils literal notranslate"><span class="pre">Enterprise</span> <span class="pre">Mobility</span> <span class="pre">+</span> <span class="pre">Security</span> <span class="pre">E5</span></code> licences will resolve this.</p></li>
</ul>
</li>
<li><p>You may also find that the issue resolves itself given enough time.</p></li>
</ul>
</li>
<li><p><strong>Troubleshooting:</strong> If you get a <code class="docutils literal notranslate"><span class="pre">New-MsolServicePrincipalCredential:</span> <span class="pre">Access</span> <span class="pre">denied</span></code> error stating <code class="docutils literal notranslate"><span class="pre">You</span> <span class="pre">do</span> <span class="pre">not</span> <span class="pre">have</span> <span class="pre">permissions</span> <span class="pre">to</span> <span class="pre">call</span> <span class="pre">this</span> <span class="pre">cmdlet</span></code>, check the following:</p>
<ul>
<li><p>Make sure you authenticate as the “Local Administrator” (<code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>) user when prompted by the script. Other administrators added as guests will not work for this step.</p></li>
<li><p>Make sure you are logged in as a <strong>domain</strong> user rather than a local user.</p></li>
<li><p>The output of the <code class="docutils literal notranslate"><span class="pre">whoami</span></code> command in Powershell should be <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">netBios</span> <span class="pre">domain&gt;\admin</span></code> rather than <code class="docutils literal notranslate"><span class="pre">NPS-SHM-&lt;SHM</span> <span class="pre">ID&gt;\admin</span></code></p></li>
<li><p>If it is not, reconnect to the remote desktop with the username <code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>, using the same password as before</p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>On the webpage pop-up, sign in as the “Global Administrator” (eg. <code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>) user. Other administrators added as guests will not work for this step.</p></li>
</ol>
<ul class="simple">
<li><p>If you have not done so already, you may be prompted to add a phone number and backup email for the <code class="docutils literal notranslate"><span class="pre">admin&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code> account at this point.</p></li>
</ul>
<ol class="simple">
<li><p>When prompted to <code class="docutils literal notranslate"><span class="pre">Provide</span> <span class="pre">your</span> <span class="pre">Tenant</span> <span class="pre">ID</span></code>, enter your Azure Active Directory ID. To get this:</p></li>
</ol>
<ul class="simple">
<li><p>In the Azure portal select <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code> in the left hand side bar</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Properties</span></code> in the left hand side bar</p></li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">Directory</span> <span class="pre">ID</span></code> field</p></li>
</ul>
<ol class="simple">
<li><p>At the message <code class="docutils literal notranslate"><span class="pre">Configuration</span> <span class="pre">complete.</span> <span class="pre">Press</span> <span class="pre">Enter</span> <span class="pre">to</span> <span class="pre">continue</span></code>, press <code class="docutils literal notranslate"><span class="pre">Enter</span></code></p></li>
</ol>
</section>
</section>
<section id="deploy-package-mirrors">
<h2>9. Deploy package mirrors<a class="headerlink" href="#deploy-package-mirrors" title="Permalink to this headline">¶</a></h2>
<section id="when-to-deploy-mirrors">
<h3>When to deploy mirrors<a class="headerlink" href="#when-to-deploy-mirrors" title="Permalink to this headline">¶</a></h3>
<p>A full set of Tier 2 mirrors take around 4 days to fully synchronise with the external package repositories, so you may want to kick off the building of these mirrors before deploying your first SRE.</p>
</section>
<section id="deploying-package-mirrors">
<h3>Deploying package mirrors<a class="headerlink" href="#deploying-package-mirrors" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/safe_haven_management_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Deploy and configure the RDS VMs by running <code class="docutils literal notranslate"><span class="pre">./Create_Package_Mirrors.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span> <span class="pre">-tier</span> <span class="pre">&lt;desired</span> <span class="pre">tier</span> <span class="pre">eg.</span> <span class="pre">'2'&gt;</span></code>, where the SHM ID is the one specified in the config</p></li>
<li><p>This will take <strong>around 30 minutes</strong> to run.</p></li>
</ul>
</section>
<section id="optional-tearing-down-package-mirrors">
<h3>[Optional] Tearing down package mirrors<a class="headerlink" href="#optional-tearing-down-package-mirrors" title="Permalink to this headline">¶</a></h3>
<p>During normal usage, you should not need to tear down the package mirrors, but if you decide to do so, use the following procedure:</p>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/safe_haven_management_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Deploy and configure the RDS VMs by running <code class="docutils literal notranslate"><span class="pre">./Teardown_Package_Mirrors.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span> <span class="pre">-tier</span> <span class="pre">&lt;desired</span> <span class="pre">tier</span> <span class="pre">eg.</span> <span class="pre">'2'&gt;</span></code>, where the SHM ID is the one specified in the config</p></li>
<li><p>This will take <strong>a few minutes</strong> to run.</p></li>
</ul>
</section>
</section>
<section id="tearing-down-the-shm">
<h2>10. Tearing down the SHM<a class="headerlink" href="#tearing-down-the-shm" title="Permalink to this headline">¶</a></h2>
<p>In order to tear down the SHM, use the following procedure:</p>
<section id="disconnect-from-the-azure-active-directory">
<h3>Disconnect from the Azure Active Directory<a class="headerlink" href="#disconnect-from-the-azure-active-directory" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Using Microsoft Remote Desktop, connect to the <code class="docutils literal notranslate"><span class="pre">DC1-SHM-&lt;shm-id&gt;</span></code> virtual machine (VM).</p></li>
<li><p>Log in as a <strong>domain</strong> user (ie. <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>) using the username and password obtained from the Azure portal.</p></li>
<li><p>If you see a warning dialog that the certificate cannot be verified as root, accept this and continue.</p></li>
<li><p>Open Powershell as an administrator</p></li>
</ol>
<ul class="simple">
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">.\Disconnect_AD.ps1</span></code></p></li>
<li><p>You will need to provide login credentials (including MFA if set up) for <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code></p></li>
</ul>
<ol class="simple">
<li><p>Full disconnection of the Azure Active Directory can take up to 72 hours but is typically less. If you are planning to install a new SHM connected to the same Azure Active Directory you may find the <code class="docutils literal notranslate"><span class="pre">AzureADConnect</span></code> installation step requires you to wait for the previous disconnection to complete.</p></li>
</ol>
</section>
<section id="tear-down-any-attached-sres-then-the-shm">
<h3>Tear down any attached SREs then the SHM<a class="headerlink" href="#tear-down-any-attached-sres-then-the-shm" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>For each SRE that each attached to the SHM, do the following:</p>
<ul>
<li><p>Tear down the SRE by running <code class="docutils literal notranslate"><span class="pre">./SRE_Teardown.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where the SRE ID is the one specified in the relevant config file</p></li>
</ul>
</li>
<li><p>Tear down the SHM by running <code class="docutils literal notranslate"><span class="pre">./SHM_Teardown.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code>, where the SHM ID is the one specified in the config</p></li>
</ul>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, The Alan Turing Institute.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 4.3.0.
    Hosted by <a href="https://pages.github.com/">GitHub Pages</a>.
    <br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>