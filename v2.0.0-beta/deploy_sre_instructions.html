
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Secure Research Environment Build Instructions &#8212; Data Safe Haven v2.0.0-beta documentation</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="_static/overrides.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/toggle.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="index.html">
  <img src="_static/logo_turing.jpg" class="logo" alt="logo">
</a>      


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/alan-turing-institute/data-safe-haven" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
    
  
  <div class="rst-versions" data-toggle="rst-downloads" role="note" aria-label="downloads">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-file-pdf fa-fw left"></span>
      <span class="left">Download <strong>latest</strong> PDFs</span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_guacamole.pdf">User guide (Apache Guacamole)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_msrds.pdf">User guide (Microsoft RDS)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_full.pdf">Classification flowchart</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_simple.pdf">Simplified classification  flowchart</a></dd>
        
      </dl>
    </div>
  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book fa-fw left"></span>
      <span class="left">Currently reading: <strong>v2.0.0-beta</strong></span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      
      
      <dl>
        <dt>Versions</dt>
        
          
          <dd><a href="/data-safe-haven/develop/index.html">develop</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.1.0-beta/index.html">v0.1.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.2.0-beta/index.html">v0.2.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.3.0-beta/index.html">v0.3.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.0-beta/index.html">v1.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.1-beta/index.html">v1.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.1.0-beta/index.html">v1.1.0-beta</a></dd>
          
        
           <strong> 
          <dd><a href="/data-safe-haven/v2.0.0-beta/index.html">v2.0.0-beta</a></dd>
           </strong> 
        
          
          <dd><a href="/data-safe-haven/v3.0.0-beta/index.html">v3.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.0.1-beta/index.html">v3.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.1.0/index.html">v3.1.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.2.0/index.html">v3.2.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.0/index.html">v3.3.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.1/index.html">v3.3.1</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.4.0/index.html">v3.4.0</a></dd>
          
        
      </dl>
      
      
    </div>
  </div>
</div>




          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contents">
   Contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   1. Prerequisites
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-a-client-vpn-certificate-for-the-safe-haven-management-vnet">
     Download a client VPN certificate for the Safe Haven Management VNet
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-a-vpn-connection-to-the-safe-haven-management-vnet">
     Configure a VPN connection to the Safe Haven Management VNet
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ensure-the-required-sre-resources-can-be-accessed">
     Ensure the required SRE resources can be accessed
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploying-multiple-sres-in-parallel">
     Deploying multiple SREs in parallel
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-sre-configuration">
   2. Define SRE configuration
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#core-shm-configuration-properties">
     Core SHM configuration properties
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#core-sre-configuration-properties">
     Core SRE configuration properties
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sre-ip-address-prefix">
     SRE IP Address prefix
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generate-full-configuration-for-sre">
     Generate full configuration for SRE
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare-safe-haven-management-deployment">
   3. Prepare Safe Haven Management deployment
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#clear-out-any-remaining-sre-data-from-previous-deployments">
     Clear out any remaining SRE data from previous deployments
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-users-and-dns">
     Set up users and DNS
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-virtual-network">
   4. Deploy Virtual Network
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-the-virtual-network">
     Create the virtual network
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-a-vpn-connection-to-the-sre">
     Set up a VPN connection to the SRE
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-sre-domain-controller">
   5. Deploy SRE Domain Controller
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-remote-desktop-service-environment">
   6. Deploy Remote Desktop Service Environment
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-rds-vms-and-perform-initial-configuration">
     Create RDS VMs and perform initial configuration
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-and-configure-rds-environment-and-webclient">
     Install and configure RDS Environment and webclient
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#install-rds-environment-and-webclient">
       Install RDS environment and webclient
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#configure-rds-to-use-shm-nps-server-for-client-access-policies">
       Configure RDS to use SHM NPS server for client access policies
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#set-the-security-groups-for-access-to-session-hosts">
       Set the security groups for access to session hosts
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#increase-the-authorisation-timeout-to-allow-for-mfa">
       Increase the authorisation timeout to allow for MFA
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configuration-of-ssl-on-rds-gateway">
     Configuration of SSL on RDS Gateway
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-rds-deployment">
     Test RDS deployment
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-data-server">
   7. Deploy Data Server
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-dataserver-vm">
     Create Dataserver VM
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-web-application-servers-gitlab-and-hackmd">
   8. Deploy Web Application Servers (Gitlab and HackMD)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-gitlab-server">
     Test GitLab Server
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-hackmd-server">
     Test HackMD Server
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-initial-shared-compute-vm">
   9. Deploy initial shared compute VM
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optional-create-a-custom-cloud-init-file-for-the-sre-if-required">
     [OPTIONAL] Create a custom cloud init file for the SRE if required
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploy-a-compute-vm">
     Deploy a compute VM
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#troubleshooting-compute-vm-deployments">
     Troubleshooting Compute VM deployments
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#apply-network-configuration">
   10. Apply network configuration
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unpeering-package-mirrors">
     Unpeering package mirrors
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-smoke-tests-on-shared-compute-vm">
   11. Run smoke tests on shared compute VM
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#server-list">
   Server list
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tearing-down-the-sre">
   Tearing down the SRE
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/alan-turing-institute/data-safe-haven/edit/develop/docs/deploy_sre_instructions.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="secure-research-environment-build-instructions">
<h1>Secure Research Environment Build Instructions<a class="headerlink" href="#secure-research-environment-build-instructions" title="Permalink to this headline">¶</a></h1>
<p>The following instructions will walk you through deploying a Secure Research Environment. This assumes the Safe Haven Management (SHM) environment has already been set up.</p>
<section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="#1-prerequisites">Prerequisites</a></p></li>
<li><p><a class="reference external" href="#2-define-sre-configuration">Define SRE configuration</a></p></li>
<li><p><a class="reference external" href="#3-prepare-safe-haven-management-deployment">Prepare Safe Haven Management deployment</a></p></li>
<li><p><a class="reference external" href="#4-deploy-virtual-network">Deploy Virtual Network</a></p></li>
<li><p><a class="reference external" href="#5-deploy-sre-domain-controller">Deploy SRE Domain Controller</a></p></li>
<li><p><a class="reference external" href="#6-deploy-remote-desktop-service-environment">Deploy Remote Desktop Service Environment</a></p></li>
<li><p><a class="reference external" href="#7-deploy-data-server">Deploy Data Server</a></p></li>
<li><p><a class="reference external" href="#8-deploy-web-application-servers-gitlab-and-hackmd">Deploy Web Application Servers (Gitlab and HackMD)</a></p></li>
<li><p><a class="reference external" href="#9-deploy-initial-shared-compute-vm">Deploy initial shared compute VM</a></p></li>
<li><p><a class="reference external" href="#10-apply-network-configuration">Apply network configuration</a></p></li>
<li><p><a class="reference external" href="#11-run-smoke-tests-on-shared-compute-vm">Run smoke tests on shared compute VM</a></p></li>
</ol>
</section>
<section id="prerequisites">
<h2>1. Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>An Azure subscription with sufficient credits to build the environment in</p>
<ul>
<li><p>If deploying at Turing, you will need to be a member of the relevant Azure Security Group: <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Test</span> <span class="pre">Admins</span></code> for testing/development or <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Production</span> <span class="pre">Admins</span></code> for production deployment. This will give you the administrative access to:</p>
<ul>
<li><p>the relevant Safe Haven Management Azure subscription</p></li>
<li><p>the relevant Safe Haven Management Active Directory Domain</p></li>
<li><p>the relevant Safe Haven Management VMs</p></li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">PowerShell</span></code> for Azure</p>
<ul>
<li><p>Install <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.2.0">PowerShell v6.0 or above</a></p></li>
<li><p>Install the Azure <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.2.0&amp;viewFallbackFrom=azps-1.3.0">PowerShell Module</a></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Microsoft</span> <span class="pre">Remote</span> <span class="pre">Desktop</span></code></p>
<ul>
<li><p>On Mac this can be installed from the <a class="reference external" href="https://itunes.apple.com/gb/app/microsoft-remote-desktop-10/id1295203466?mt=12">apple store</a></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">OpenSSL</span></code></p>
<ul>
<li><p>Install using your package manager of choice</p></li>
</ul>
</li>
</ul>
<section id="download-a-client-vpn-certificate-for-the-safe-haven-management-vnet">
<h3>Download a client VPN certificate for the Safe Haven Management VNet<a class="headerlink" href="#download-a-client-vpn-certificate-for-the-safe-haven-management-vnet" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Navigate to the Safe Haven Management (SHM) KeyVault in the Safe Haven Management subscription via <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SHM_SECRETS</span> <span class="pre">-&gt;</span> <span class="pre">kv-shm-&lt;shm-id&gt;</span></code>.</p></li>
<li><p>Once there open the “Certificates” page under the “Settings” section in the left hand sidebar.</p></li>
<li><p>Click on the certificate named <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-vpn-client-cert</span></code>, click on the “current version” and click the “Download in PFX/PEM format” link.</p></li>
<li><p>To install, double click on the downloaded certificate, leaving the password field blank.</p></li>
<li><p><strong>Make sure to securely delete the “*.pfx” certificate file after you have installed it.</strong></p></li>
<li><p>This certificate will also allow you to connect via VPN to the SRE VNets once deployed.</p></li>
</ul>
</section>
<section id="configure-a-vpn-connection-to-the-safe-haven-management-vnet">
<h3>Configure a VPN connection to the Safe Haven Management VNet<a class="headerlink" href="#configure-a-vpn-connection-to-the-safe-haven-management-vnet" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Navigate to the Safe Haven Management (SHM) VNet gateway in the SHM subscription via <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SHM_NETWORKING</span> <span class="pre">-&gt;</span> <span class="pre">VNET_SHM_&lt;shm-id&gt;_GW</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code> is defined in the config file. Once there open the “Point-to-site configuration page under the “Settings” section in the left hand sidebar (see image below).</p></li>
<li><p>Click the “Download VPN client” link at the top of the page to get the root certificate (<code class="docutils literal notranslate"><span class="pre">VpnServerRoot.cer</span></code>) and VPN configuration file (<code class="docutils literal notranslate"><span class="pre">VpnSettings.xml</span></code>), then follow the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-vpn-client-configuration-azure-cert">VPN set up instructions</a> using the Windows or Mac sections as appropriate.</p></li>
<li><p>On Windows you may get a “Windows protected your PC” pop up. If so, click <code class="docutils literal notranslate"><span class="pre">More</span> <span class="pre">info</span> <span class="pre">-&gt;</span> <span class="pre">Run</span> <span class="pre">anyway</span></code></p></li>
<li><p>On Windows do not rename the vpn client as this will break it</p></li>
<li><p>Note that on OSX double clicking on the root certificate may not result in any pop-up dialogue, but the certificate should still be installed. You can view the details of the downloaded certificate by highlighting the certificate file in Finder and pressing the spacebar. You can then look for the certificate of the same name in the login KeyChain and view it’s details by double clicking the list entry. If the details match the certificate has been successfully installed.</p>
<p><img alt="Point-to-site connection" src="_images/point_to_site.png" /></p>
</li>
<li><p>Continue to follow the set up instructions from the link above, using SSTP (Windows) or IKEv2 (OSX) for the VPN type and naming the VPN connection “Safe Haven Management Gateway (<code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code>)”, where <code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code> is defined in the config file.</p></li>
</ul>
</section>
<section id="ensure-the-required-sre-resources-can-be-accessed">
<h3>Ensure the required SRE resources can be accessed<a class="headerlink" href="#ensure-the-required-sre-resources-can-be-accessed" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Access to a new Azure subscription which the SRE will be deployed to</p>
<ul>
<li><p>If a subscription does not exist, create one with the name <code class="docutils literal notranslate"><span class="pre">Secure</span> <span class="pre">Research</span> <span class="pre">Environment</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">(&lt;shm-id&gt;)</span></code>, picking an SRE ID that is not yet in use and setting <code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code> to the value given in the config file.</p></li>
<li><p>Add an initial $3,000 for test and production sandbox environments and the project specific budget for production project environments</p></li>
<li><p>Give the relevant “Safe Haven <code class="docutils literal notranslate"><span class="pre">&lt;shm-id&gt;</span></code> Admins” Security Group <strong>Owner</strong> role on the new SRE subscription</p></li>
</ul>
</li>
<li><p>Access to a public routable domain name for the SRE and its name servers</p>
<ul>
<li><p>This can be a top-level domain (eg. <code class="docutils literal notranslate"><span class="pre">dsgroup100.co.uk</span></code>) or a subdomain (eg. <code class="docutils literal notranslate"><span class="pre">sandbox.dsgroupdev.co.uk</span></code> or <code class="docutils literal notranslate"><span class="pre">sandbox.testb.dsgroupdev.co.uk</span></code>)</p></li>
<li><p>A DNS for this domain must exist in the <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Domains</span></code> subscription, in the <code class="docutils literal notranslate"><span class="pre">RG_SHM_DNS_TEST</span></code> or <code class="docutils literal notranslate"><span class="pre">RG_SHM_DNS_PRODUCTION</span></code> resource group.</p></li>
<li><p>To create a new DNS zone:</p>
<ul>
<li><p>From within the resource group click <code class="docutils literal notranslate"><span class="pre">&quot;+&quot;</span> <span class="pre">Add</span> <span class="pre">-&gt;</span> <span class="pre">DNS</span> <span class="pre">Zone</span></code> and click “create”</p></li>
<li><p>Set the <strong>Name</strong> field to the SRE domain (eg. <code class="docutils literal notranslate"><span class="pre">sandbox.dsgroupdev.co.uk</span></code>)</p></li>
<li><p>Click “Review + create”</p></li>
<li><p>Once deployment is finished, click “Go to resource” to view the new Azure DNS zone</p></li>
<li><p>Copy the 4 nameservers in the “NS” record to the domain’s DNS record</p>
<ul>
<li><p>if this is a top-level domain, contact whoever registered the domain</p></li>
<li><p>if this is a subdomain of an existing Azure domain (eg. <code class="docutils literal notranslate"><span class="pre">sandbox.dsgroupdev.co.uk</span></code> then:</p>
<ul>
<li><p>go to the DNS zone for the top-level domain in Azure</p></li>
<li><p>add a new NS record using the 4 nameservers you copied down above
<img alt="Subdomain NS record" src="_images/subdomain_ns_record.png" /></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="deploying-multiple-sres-in-parallel">
<h3>Deploying multiple SREs in parallel<a class="headerlink" href="#deploying-multiple-sres-in-parallel" title="Permalink to this headline">¶</a></h3>
<p><strong>NOTE:</strong> You can only deploy to <strong>one SRE at a time</strong> from a given computer as both the <code class="docutils literal notranslate"><span class="pre">Az</span></code> CLI and the <code class="docutils literal notranslate"><span class="pre">Az</span></code> Powershell module can only work within one Azure subscription at a time. For convenience we recommend using one of the Safe Haven deployment VMs on Azure for all production deploys. This will also let you deploy compute VMs in parallel to as many SREs as you have deployment VMs. See the <span class="xref myst">parallel deployment guide</span> for details.</p>
</section>
</section>
<section id="define-sre-configuration">
<h2>2. Define SRE configuration<a class="headerlink" href="#define-sre-configuration" title="Permalink to this headline">¶</a></h2>
<p>The full configuration details for a new SRE are generated by defining a few “core” properties for the new SRE and the management environment in which it will be deployed.</p>
<section id="core-shm-configuration-properties">
<h3>Core SHM configuration properties<a class="headerlink" href="#core-shm-configuration-properties" title="Permalink to this headline">¶</a></h3>
<p>The core properties for the relevant pre-existing Safe Haven Management (SHM) environment must be present in the <code class="docutils literal notranslate"><span class="pre">environment_configs/core</span></code> folder.
The following core SHM properties must be defined in a JSON file named <code class="docutils literal notranslate"><span class="pre">shm_&lt;shm-id&gt;_core_config.json</span></code>.</p>
<p><strong>NOTE:</strong> The <code class="docutils literal notranslate"><span class="pre">netbiosName</span></code> fields must have a maximum length of 15 characters.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;subscriptionName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure subscription the management environment is deployed in&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;domainSubscriptionName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure subscription holding DNS records&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;adminSecurityGroupName&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure Security Group that admins of this Safe Haven will belong to&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;computeVmImageSubscriptionName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Azure Subscription name for compute VM&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;domain&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The fully qualified domain name for the management environment&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;netbiosname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A short name to use as the local name for the domain. This must be 15 characters or less&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;shmId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A short ID to identify the management environment&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Safe Haven deployment name&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;organisation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Organisation name&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;townCity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Location&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;stateCountyRegion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Location&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;countryCode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e.g. GB&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The Azure location in which the management environment VMs are deployed&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;ipPrefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The three octet IP address prefix for the Class A range used by the management environment. Use 10.0.0 for this unless you have a good reason to use another prefix.&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="core-sre-configuration-properties">
<h3>Core SRE configuration properties<a class="headerlink" href="#core-sre-configuration-properties" title="Permalink to this headline">¶</a></h3>
<p>The core properties for the new SRE environment must be present in the <code class="docutils literal notranslate"><span class="pre">environment_configs/core</span></code> folder.
The following core SRE properties must be defined in a JSON file named <code class="docutils literal notranslate"><span class="pre">sre_&lt;SRE</span> <span class="pre">ID&gt;_core_config.json</span></code>.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;subscriptionName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure subscription the secure research environment is deployed in&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;adminSecurityGroupName&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Name of the Azure Security Group that admins of this SHM belong to&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;sreId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A short ID to identify the secure research environment. Ideally this should be 7 characters or less; if not it will be truncated in some places, but will otherwise not cause problems.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;shmId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The short ID for the SHM segment to deploy against&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;tier&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The data classification tier for the SRE. This controls the outbound network restrictions on the SRE and which mirror set the SRE is peered with&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;domain&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The fully qualified domain name for the SRE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;netbiosname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A short name to use as the local name for the domain. This must be 15 characters or less. If the first part of the domain is less than 15 characters, use this for the netbiosName&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;ipPrefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The three octet IP address prefix for the Class A range used by the management environemnt&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;rdsAllowedSources&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A comma-separated string of IP ranges (addresses or CIDR ranges) from which access to the RDS webclient is permitted. For Tier 0 and 1 this should be &#39;Internet&#39;. For Tier 2 this should correspond to the any organisational networks (including guest networks) at the partner organisations where access should be permitted from (i.e. any network managed by the organsiation, such as EduRoam, Turing Guest, Turing Secure etc). For Tier 3 SREs, this should correspond to the RESTRICTED networks at the partner organisations. These should only permit connections from within meduim security access controlled physical spaces and from managed devices (e.g. Turing Secure). Using &#39;default&#39; will use the default Turing networks.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;rdsInternetAccess&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Whether to allow outbound internet access from inside the remote desktop environment. Either &#39;Allow&#39;, &#39;Deny&#39; or &#39;default&#39; (for Tier 0 and 1 &#39;Allow&#39; otherwise &#39;Deny&#39;)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;computeVmImageType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The name of the Compute VM image (most commonly &#39;Ubuntu&#39;)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;computeVmImageVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The version of the Compute VM image (e.g. 0.1.2019082900)&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="sre-ip-address-prefix">
<h3>SRE IP Address prefix<a class="headerlink" href="#sre-ip-address-prefix" title="Permalink to this headline">¶</a></h3>
<p>Each SRE must be assigned it’s own unique IP address space, and it is very important that address spaces do not overlap in the environment as this will cause network faults. The address spaces use a private class A range and use a 21bit subnet mask. This provides ample addresses for a SRE and capacity to add additional subnets should that be required in the future.</p>
</section>
<section id="generate-full-configuration-for-sre">
<h3>Generate full configuration for SRE<a class="headerlink" href="#generate-full-configuration-for-sre" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the top-level folder within the Safe Haven repository.</p></li>
<li><p>Generate a new full configuration file for the new SRE using the following commands.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Import-Module</span> <span class="pre">./deployment/common/Configuration.psm1</span> <span class="pre">-Force</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Add-SreConfig</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> is a short string, e.g. <code class="docutils literal notranslate"><span class="pre">sandbox</span></code> for <code class="docutils literal notranslate"><span class="pre">sandbox.dsgroupdev.co.uk</span></code></p></li>
</ul>
</li>
<li><p>A full configuration file for the new SRE will be created at <code class="docutils literal notranslate"><span class="pre">environment_configs/full/sre_&lt;SRE</span> <span class="pre">ID&gt;_full_config.json</span></code>. This file is used by the subsequent steps in the SRE deployment.</p></li>
<li><p>Commit this new full configuration file to the Safe Haven repository</p></li>
</ul>
</section>
</section>
<section id="prepare-safe-haven-management-deployment">
<h2>3. Prepare Safe Haven Management deployment<a class="headerlink" href="#prepare-safe-haven-management-deployment" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
</ul>
<section id="clear-out-any-remaining-sre-data-from-previous-deployments">
<h3>Clear out any remaining SRE data from previous deployments<a class="headerlink" href="#clear-out-any-remaining-sre-data-from-previous-deployments" title="Permalink to this headline">¶</a></h3>
<p><strong>NOTE</strong> Ensure that the SRE subscription is completely empty before running this script. If the subscription is not empty, confirm that it is not being used before deleting the resources</p>
<ul class="simple">
<li><p>Clear any remaining SRE data from the SHM by running <code class="docutils literal notranslate"><span class="pre">./Remove_SRE_Data_From_SHM.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where the SRE ID is the one specified in the config.</p></li>
</ul>
</section>
<section id="set-up-users-and-dns">
<h3>Set up users and DNS<a class="headerlink" href="#set-up-users-and-dns" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Prepare SHM by running <code class="docutils literal notranslate"><span class="pre">./Prepare_SHM.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where the SRE ID is the one specified in the config</p></li>
<li><p>This step also creates a KeyVault in the SRE subscription in <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SRE_SECRETS</span> <span class="pre">-&gt;</span> <span class="pre">kv-shm-&lt;shm-id&gt;-sre-&lt;SRE</span> <span class="pre">ID&gt;</span></code>. Additional deployment steps will add secrets to this KeyVault and you will need to access some of these for some of the manual configuration steps later.</p></li>
</ul>
</section>
</section>
<section id="deploy-virtual-network">
<h2>4. Deploy Virtual Network<a class="headerlink" href="#deploy-virtual-network" title="Permalink to this headline">¶</a></h2>
<section id="create-the-virtual-network">
<h3>Create the virtual network<a class="headerlink" href="#create-the-virtual-network" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">./Create_VNET.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where the SRE ID is the one specified in the config</p></li>
<li><p>The deployment will take around 20 minutes. Most of this is deploying the virtual network gateway.</p></li>
<li><p>The VNet peerings may take a few minutes to provision after the script completes.</p></li>
</ul>
</section>
<section id="set-up-a-vpn-connection-to-the-sre">
<h3>Set up a VPN connection to the SRE<a class="headerlink" href="#set-up-a-vpn-connection-to-the-sre" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>In the <strong>SRE subscription</strong> open <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SRE_NETWORKING</span> <span class="pre">-&gt;</span> <span class="pre">VNET_SRE_&lt;SRE</span> <span class="pre">ID&gt;_GW</span></code></p>
<ul>
<li><p>Select “<strong>Point to Site Configuration</strong>” from the left-hand navigation</p></li>
<li><p>Download the VPN client from the “Point to Site configuration” menu
<img alt="VPN client" src="_images/vpn_client.png" /></p></li>
<li><p>Install the VPN on your PC and test. See the <a class="reference external" href="#Configure-a-VPN-connection-to-the-Safe-Haven-Management-VNet">Configure a VPN connection to the Safe Haven Management VNet</a> section in the <a class="reference external" href="#Prerequisites">Prerequisites</a> list above for instructions. You can re-use the same client certificate as used for the VPN to the management VNet gateway.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="deploy-sre-domain-controller">
<h2>5. Deploy SRE Domain Controller<a class="headerlink" href="#deploy-sre-domain-controller" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">./Setup_SRE_DC.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> script, where the SRE ID is the one specified in the config</p></li>
<li><p>The deployment will normally take around 30 minutes. Most of this is running the setup scripts after creating the VM. However it may take longer if many Windows updates need to be performed.</p></li>
<li><p><strong>Troubleshooting:</strong> If you see errors such as <code class="docutils literal notranslate"><span class="pre">Installing</span> <span class="pre">Windows</span> <span class="pre">updates</span> <span class="pre">failed</span></code> you should try re-running the script (you do not need to destroy existing resources as the script is idempotent).</p></li>
</ul>
</section>
<section id="deploy-remote-desktop-service-environment">
<h2>6. Deploy Remote Desktop Service Environment<a class="headerlink" href="#deploy-remote-desktop-service-environment" title="Permalink to this headline">¶</a></h2>
<section id="create-rds-vms-and-perform-initial-configuration">
<h3>Create RDS VMs and perform initial configuration<a class="headerlink" href="#create-rds-vms-and-perform-initial-configuration" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Deploy and configure the RDS VMs by running <code class="docutils literal notranslate"><span class="pre">./Setup_SRE_RDS_Servers.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where the SRE ID is the one specified in the config</p></li>
<li><p>The deployment will take around 40 minutes to complete.</p></li>
</ul>
</section>
<section id="install-and-configure-rds-environment-and-webclient">
<h3>Install and configure RDS Environment and webclient<a class="headerlink" href="#install-and-configure-rds-environment-and-webclient" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Connect to the <strong>RDS Gateway</strong> via Remote Desktop client over the SRE VPN connection</p></li>
<li><p>The IP address can be found using the Azure portal by navigating to the Virtual Machine (<code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SRE_RDS</span> <span class="pre">-&gt;</span> <span class="pre">RDG-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code>)</p></li>
<li><p>Login as the <strong>SRE domain</strong> admin user eg. <code class="docutils literal notranslate"><span class="pre">sresandboxadmin&#64;sandbox.dsgroupdev.co.uk</span></code>) where the admin username and password are stored in the SRE KeyVault <code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SRE_SECRETS</span> <span class="pre">-&gt;</span> <span class="pre">kv-shm-&lt;shm-id&gt;-sre-&lt;SRE</span> <span class="pre">ID&gt;</span></code> as <code class="docutils literal notranslate"><span class="pre">sre-&lt;SRE</span> <span class="pre">ID&gt;-dc-admin-username</span></code> and <code class="docutils literal notranslate"><span class="pre">sre-&lt;SRE</span> <span class="pre">ID&gt;-dc-admin-password</span></code>. (NB. all SRE Windows servers use the same admin credentials.)</p></li>
</ul>
<section id="install-rds-environment-and-webclient">
<h4>Install RDS environment and webclient<a class="headerlink" href="#install-rds-environment-and-webclient" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Open a PowerShell command window with elevated privileges - make sure to use the <code class="docutils literal notranslate"><span class="pre">Windows</span> <span class="pre">PowerShell</span></code> application, not the <code class="docutils literal notranslate"><span class="pre">Windows</span> <span class="pre">PowerShell</span> <span class="pre">(x86)</span></code> application. The required server management commandlets are not installed on the x86 version.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">C:\Installation\Deploy_RDS_Environment.ps1</span></code> (prefix the command with a leading <code class="docutils literal notranslate"><span class="pre">.\</span></code> if running from within the <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code> directory)</p></li>
<li><p>This script will take about 20 minutes to run (this cannot be done remotely, as it needs to be run as a domain user but remote Powershell uses a local user)</p></li>
</ul>
</section>
<section id="configure-rds-to-use-shm-nps-server-for-client-access-policies">
<h4>Configure RDS to use SHM NPS server for client access policies<a class="headerlink" href="#configure-rds-to-use-shm-nps-server-for-client-access-policies" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>In “Server Manager”, open <code class="docutils literal notranslate"><span class="pre">Tools</span> <span class="pre">-&gt;</span> <span class="pre">Remote</span> <span class="pre">Desktop</span> <span class="pre">Services</span> <span class="pre">-&gt;</span> <span class="pre">Remote</span> <span class="pre">Desktop</span> <span class="pre">Gateway</span> <span class="pre">Manager</span></code>
<img alt="Remote Desktop Gateway Manager" src="_images/rd_gateway_manager_01.png" /></p></li>
<li><p>In the left pane, underneath “RD Gateway Manager”, right click on the <code class="docutils literal notranslate"><span class="pre">RDG-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">(Local)</span></code> object and select “Properties”
<img alt="RDS server properties" src="_images/rd_gateway_manager_02.png" /></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">RD</span> <span class="pre">CAP</span> <span class="pre">Store</span></code> tab</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Central</span> <span class="pre">Server</span> <span class="pre">Running</span> <span class="pre">NPS</span></code></p></li>
<li><p>Enter the IP address of the NPS within the management domain (this will be <code class="docutils literal notranslate"><span class="pre">10.&lt;something&gt;.0.248</span></code>, you can see it from the Azure portal (<code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SHM_NPS</span> <span class="pre">-&gt;</span> <span class="pre">NPS-SHM-&lt;SHM</span> <span class="pre">ID&gt;</span></code>)</p></li>
<li><p>Set the “Shared Secret” to the value of the <code class="docutils literal notranslate"><span class="pre">sre-&lt;SRE</span> <span class="pre">ID&gt;-nps-secret</span></code> in the SRE Key Vault (<code class="docutils literal notranslate"><span class="pre">Resource</span> <span class="pre">Groups</span> <span class="pre">-&gt;</span> <span class="pre">RG_SRE_SECRETS</span> <span class="pre">-&gt;</span> <span class="pre">kv-shm-&lt;shm-id&gt;-sre-&lt;SRE</span> <span class="pre">ID&gt;</span></code>).
<img alt="RD CAP store" src="_images/rd_gateway_manager_03.png" /></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> to close the dialogue box.</p></li>
</ul>
</section>
<section id="set-the-security-groups-for-access-to-session-hosts">
<h4>Set the security groups for access to session hosts<a class="headerlink" href="#set-the-security-groups-for-access-to-session-hosts" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Expand the <code class="docutils literal notranslate"><span class="pre">RDG-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">(Local)</span></code> server object and select <code class="docutils literal notranslate"><span class="pre">Policies</span> <span class="pre">-&gt;</span> <span class="pre">Resource</span> <span class="pre">Authorization</span> <span class="pre">Policies</span></code></p></li>
<li><p>Right click on <code class="docutils literal notranslate"><span class="pre">RDG_AllDomainComputers</span></code> and select “Properties`
<img alt="Session host security groups" src="_images/rd_gateway_session_hosts_01.png" /></p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">User</span> <span class="pre">Groups</span></code> tab click <code class="docutils literal notranslate"><span class="pre">Add</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Locations</span></code> and select the management domain (e.g. <code class="docutils literal notranslate"><span class="pre">testa.dsgroupdev.co.uk</span></code>) and click <code class="docutils literal notranslate"><span class="pre">OK</span></code></p></li>
<li><p>Enter <code class="docutils literal notranslate"><span class="pre">SG</span></code> into the <code class="docutils literal notranslate"><span class="pre">Enter</span> <span class="pre">the</span> <span class="pre">object</span> <span class="pre">names</span> <span class="pre">to</span> <span class="pre">select</span></code> box and click on <code class="docutils literal notranslate"><span class="pre">Check</span> <span class="pre">Names</span></code></p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">SG</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">Research</span> <span class="pre">Users</span></code>security group from the list.
<img alt="Session host security groups" src="_images/rd_gateway_session_hosts_02.png" /></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> and the group will be added to the “User Groups” screen
<img alt="Session host security groups" src="_images/rd_gateway_session_hosts_03.png" /></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> to exit the dialogue box</p></li>
<li><p>Right click on <code class="docutils literal notranslate"><span class="pre">RDG_RDConnectionBrokers</span></code> policy and select <code class="docutils literal notranslate"><span class="pre">Properties</span></code>
<img alt="Session host security groups" src="_images/rd_gateway_session_hosts_04.png" /></p></li>
<li><p>Repeat the process you did for the <code class="docutils literal notranslate"><span class="pre">RDG_AllDomainComputers</span></code> policy, again adding the <code class="docutils literal notranslate"><span class="pre">SG</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">Research</span> <span class="pre">Users</span></code> security group from the list.</p></li>
</ul>
</section>
<section id="increase-the-authorisation-timeout-to-allow-for-mfa">
<h4>Increase the authorisation timeout to allow for MFA<a class="headerlink" href="#increase-the-authorisation-timeout-to-allow-for-mfa" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>In “Server Manager”, select <code class="docutils literal notranslate"><span class="pre">Tools</span> <span class="pre">-&gt;</span> <span class="pre">Network</span> <span class="pre">Policy</span> <span class="pre">Server</span></code></p></li>
<li><p>Expand <code class="docutils literal notranslate"><span class="pre">NPS</span> <span class="pre">(Local)</span> <span class="pre">-&gt;</span> <span class="pre">RADIUS</span> <span class="pre">Clients</span> <span class="pre">and</span> <span class="pre">Servers</span> <span class="pre">-&gt;</span> <span class="pre">Remote</span> <span class="pre">RADIUS</span> <span class="pre">Server</span> <span class="pre">Groups</span></code> and double click on <code class="docutils literal notranslate"><span class="pre">TS</span> <span class="pre">GATEWAY</span> <span class="pre">SERVER</span> <span class="pre">GROUP</span></code>
<img alt="Remote RADIUS server" src="_images/rds_local_nps_remote_server_selection.png" /></p></li>
<li><p>Highlight the server shown in the <code class="docutils literal notranslate"><span class="pre">RADIUS</span> <span class="pre">Server</span></code> column and click <code class="docutils literal notranslate"><span class="pre">Edit</span></code></p></li>
<li><p>Change to the <code class="docutils literal notranslate"><span class="pre">Load</span> <span class="pre">Balancing</span></code> tab and change the parameters to match the screen below
<img alt="Load balancing" src="_images/rds_local_nps_remote_server_timeouts.png" /></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> twice and close <code class="docutils literal notranslate"><span class="pre">Network</span> <span class="pre">Policy</span> <span class="pre">Server</span></code> MMC</p></li>
</ul>
</section>
</section>
<section id="configuration-of-ssl-on-rds-gateway">
<h3>Configuration of SSL on RDS Gateway<a class="headerlink" href="#configuration-of-ssl-on-rds-gateway" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">./CreateUpdate_Signed_Ssl_Certificate.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">-emailAddress</span> <span class="pre">&lt;email&gt;</span></code>, where the SRE ID is the one specified in the config and the email address is one that you would like to be notified when certificate expiry is approaching.</p></li>
<li><p><strong>NOTE:</strong> This script should be run again whenever you want to update the certificate for this SRE.</p></li>
<li><p><strong>Troubleshooting:</strong> Let’s Encrypt will only issue <strong>5 certificates per week</strong> for a particular host (e.g. <code class="docutils literal notranslate"><span class="pre">rdg-sre-sandbox.sandbox.dsgroupdev.co.uk</span></code>). For production environments this should usually not be an issue. The signed certificates are also stored in the KeyVault for easy redeployment. However, if you find yourself needing to re-run this step without the KeyVault secret available, either to debug an error experienced in production or when redeploying a test environment frequently during development, you should run <code class="docutils literal notranslate"><span class="pre">./CreateUpdate_Signed_Ssl_Certificate.ps1</span> <span class="pre">-dryRun</span> <span class="pre">$true</span></code> to use the Let’s Encrypt staging server, which will issue certificates more frequently. However, these certificates will not be trusted by your browser, so you will need to override the security warning in your browser to access the RDS web client for testing.</p></li>
</ul>
</section>
<section id="test-rds-deployment">
<h3>Test RDS deployment<a class="headerlink" href="#test-rds-deployment" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Disconnect from any SRE VMs and connect to the SHM VPN</p></li>
<li><p>Connect to the <strong>SHM Domain Controller</strong> via the Remote Desktop client</p></li>
<li><p>Log in as a <strong>domain</strong> user (ie. <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>) using the username and password obtained from the Azure portal. They are in the <code class="docutils literal notranslate"><span class="pre">RG_SHM_SECRETS</span></code> resource group, in the <code class="docutils literal notranslate"><span class="pre">kv-shm-&lt;shm-id&gt;</span></code> key vault, under “SECRETS”.</p>
<ul>
<li><p>The username is the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-dcnps-admin-username</span></code> secret plus <code class="docutils literal notranslate"><span class="pre">&#64;&lt;SHM</span> <span class="pre">DOMAIN&gt;</span></code> where you add your custom SHM domain. For example <code class="docutils literal notranslate"><span class="pre">shmtestbadmin&#64;testb.dsgroupdev.co.uk</span></code></p></li>
<li><p>The password in the <code class="docutils literal notranslate"><span class="pre">shm-&lt;shm-id&gt;-dcnps-admin-password</span></code> secret.</p></li>
</ul>
</li>
<li><p><strong>NB. Before performing the remaining steps, ensure that you have created a non-privileged user account that you can use for testing. This user should be created in the local Active Directory and must have been synchronised to the Azure Active Directory. You must ensure that you have assigned a licence to this user so that MFA will work correctly.</strong></p></li>
</ul>
<ol class="simple">
<li><p>Ensuring that a non-privileged user account exists</p></li>
</ol>
<ul class="simple">
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Server</span> <span class="pre">Management</span></code> app, click <code class="docutils literal notranslate"><span class="pre">Tools</span> <span class="pre">-&gt;</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Users</span> <span class="pre">and</span> <span class="pre">Computers</span></code></p></li>
<li><p>Open the <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Research</span> <span class="pre">Users</span></code> OU</p></li>
<li><p>Ensure that the non-privileged user account that you want to use is listed here, or if it is not then create it.</p></li>
</ul>
<ol class="simple">
<li><p>Adding the user account to the correct Security Group</p></li>
</ol>
<ul class="simple">
<li><p>Still in the <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Users</span> <span class="pre">and</span> <span class="pre">Computers</span></code> app, open the <code class="docutils literal notranslate"><span class="pre">Safe</span> <span class="pre">Haven</span> <span class="pre">Security</span> <span class="pre">Groups</span></code> OU</p></li>
<li><p>Right click the <code class="docutils literal notranslate"><span class="pre">SG</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">Research</span> <span class="pre">Users</span></code> security group and select <code class="docutils literal notranslate"><span class="pre">Properties</span></code></p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">Members</span></code> tab.</p></li>
<li><p>If the user you plan to use is not already listed here you must add them to the group (<em>the automatically-created test researcher should already be in the correct group</em>)</p>
<ul>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">Add</span></code> button</p></li>
<li><p>Enter the start of the <code class="docutils literal notranslate"><span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> and click “Check names”</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">Test</span> <span class="pre">Researcher</span></code> and click <code class="docutils literal notranslate"><span class="pre">Ok</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Ok</span></code> again to exit the add users dialogue</p></li>
</ul>
</li>
</ul>
<ol class="simple">
<li><p>Ensure that the account has MFA enabled</p></li>
</ol>
<ul class="simple">
<li><p>If you have just created the account, you will need to synchronise with Azure Active Directory</p></li>
<li><p>Please ensure that this account is fully set-up (including MFA) as <span class="xref myst">detailed in the user guide</span></p></li>
</ul>
<ol class="simple">
<li><p>Test using the RDG web interface</p></li>
</ol>
<ul class="simple">
<li><p>Launch a local web browser and go to <code class="docutils literal notranslate"><span class="pre">https://&lt;SRE</span> <span class="pre">ID&gt;.&lt;safe</span> <span class="pre">haven</span> <span class="pre">domain&gt;</span></code> (eg. <code class="docutils literal notranslate"><span class="pre">https://sandbox.dsgroupdev.co.uk/</span></code>) and log in.</p>
<ul>
<li><p><strong>Troubleshooting</strong> If you get a “404 resource not found” error when accessing the webclient URL, it is likely that you missed the step of installing the RDS webclient.</p>
<ul>
<li><p>Go back to the previous section and run the webclient installation step.</p></li>
<li><p>Once the webclient is installed, you will need to manually run the steps from the SSL certificate generation script to install the SSL certificate on the  webclient. Still on the RDS Gateway, run the commands below, replacing <code class="docutils literal notranslate"><span class="pre">&lt;path-to-full-certificate-chain&gt;</span></code> with the path to the <code class="docutils literal notranslate"><span class="pre">xxx_full_chain.pem</span></code> file in the <code class="docutils literal notranslate"><span class="pre">C:\Certificates</span></code> folder.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Import-RDWebClientBrokerCert</span> <span class="pre">&lt;path-to-full-certificate-chain&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Publish-RDWebClientPackage</span> <span class="pre">-Type</span> <span class="pre">Production</span> <span class="pre">-Latest</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Troubleshooting</strong> If you get an “unexpected server authentication certificate error”, your browser has probably cached a previous certificate for this domain.</p>
<ul>
<li><p>Do a <a class="reference external" href="https://www.getfilecloud.com/blog/2015/03/tech-tip-how-to-do-hard-refresh-in-browsers/">hard reload</a> of the page (permanent fix)</p></li>
<li><p>OR open a new private / incognito browser window and visit the page.</p></li>
</ul>
</li>
<li><p><strong>Troubleshooting</strong> If you can see an empty screen with <code class="docutils literal notranslate"><span class="pre">Work</span> <span class="pre">resources</span></code> but no app icons, your user has not been correctly added to the security group.</p></li>
</ul>
</li>
<li><p>Once you have logged in, click on the <code class="docutils literal notranslate"><span class="pre">Presentation</span> <span class="pre">server</span></code> app icon. You should receive an MFA request to your phone or authentication app.</p>
<ul>
<li><p><strong>Troubleshooting</strong> If you can log in to the initial webclient authentication but don’t get the MFA request, then the issue is likely that the configuration of the connection between the SHM NPS server and the RDS Gateway server is not correct.</p>
<ul>
<li><p>Ensure that both the SHM NPS server and the RDS Gateway are running</p></li>
<li><p>Ensure that the <a class="reference external" href="sre_build_instructions.md#configure-rds-to-use-shm-nps-server-for-client-access-policies">SHM NPS server RADIUS Client configuration</a> is using the <strong>private</strong> IP address of the RDS Gateway and <strong>not</strong> its public one.</p></li>
<li><p>Use the Event viewer on the SRE RDS Gateway (<code class="docutils literal notranslate"><span class="pre">Custom</span> <span class="pre">views</span> <span class="pre">&gt;</span> <span class="pre">Server</span> <span class="pre">roles</span> <span class="pre">&gt;</span> <span class="pre">Network</span> <span class="pre">Policy</span> <span class="pre">and</span> <span class="pre">Access</span> <span class="pre">Services</span></code>) to check whether the NPS server is contactable and whether it is discarding requests</p></li>
<li><p>Use the Event viewer on the SHM NPS server  (<code class="docutils literal notranslate"><span class="pre">Custom</span> <span class="pre">views</span> <span class="pre">&gt;</span> <span class="pre">Server</span> <span class="pre">roles</span> <span class="pre">&gt;</span> <span class="pre">Network</span> <span class="pre">Policy</span> <span class="pre">and</span> <span class="pre">Access</span> <span class="pre">Services</span></code>) to check whether NPS requests are being received and whether the NPS server has an LDAP connection to the SHM DC.</p></li>
<li><p>One common error on the NPS server is <code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">RADIUS</span> <span class="pre">message</span> <span class="pre">was</span> <span class="pre">received</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">invalid</span> <span class="pre">RADIUS</span> <span class="pre">client</span> <span class="pre">IP</span> <span class="pre">address</span> <span class="pre">x.x.x.x</span></code>. <a class="reference external" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd316135(v=ws.10)">This help page</a> might be useful. This may indicate that the shared secret is different between the SHM and SRE.</p></li>
<li><p>Ensure the same shared secret from the <code class="docutils literal notranslate"><span class="pre">sre-&lt;SRE</span> <span class="pre">ID&gt;-nps-secret</span></code> in the SRE KeyVault is used in <strong>both</strong> the SHM NPS server RADIUS Client configuration (you can set this manually by connecting to the Network Policy Server) and the <a class="reference external" href="sre_build_instructions.md#configure-rds-to-use-shm-nps-server-for-client-access-policies">SRE RDS Gateway RD CAP Store configuration</a> (see previous sections for instructions).</p></li>
<li><p>Ensure that the <code class="docutils literal notranslate"><span class="pre">Windows</span> <span class="pre">Firewall</span></code> is set to <code class="docutils literal notranslate"><span class="pre">Domain</span> <span class="pre">Network</span></code> on both the SHM NPS server and the SRE RDS Gateway</p></li>
</ul>
</li>
<li><p><strong>Troubleshooting</strong> If you get a “We couldn’t connect to the gateway because of an error” message, it’s likely that the “Remote RADIUS Server” authentication timeouts have not been <a class="reference external" href="sre_build_instructions.md#increase-the-authorisation-timeout-to-allow-for-mfa">increased as described in a previous section</a>. It seems that these are reset everytime the “Central CAP store” shared RADIUS secret is changed.</p></li>
<li><p><strong>Troubleshooting</strong> If you get multiple MFA requests with no change in the “Opening ports” message, it may be that the shared RADIUS secret does not match on the SHM server and SRE RDS Gateway. It is possible that this may occur if the password is too long. We previously experienced this issue with a 20 character shared secret and this error went away when we reduced the length of the secret to 12 characters. We then got a “We couldn’t connect to the gateway because of an error” message, but were then able to connect successfully after again increasing the authorisation timeout for the remote RADIUS server on the RDS Gateway.</p></li>
<li><p><strong>Troubleshooting</strong> If you are able to log into the webclient with a username and password but cannot connect to the presentation server (as no MFA prompt is given), please look at <a class="reference external" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd316134(v=ws.10)">this documentation</a>. In particular, ensure that the default UDP ports <code class="docutils literal notranslate"><span class="pre">1812</span></code>, <code class="docutils literal notranslate"><span class="pre">1813</span></code>, <code class="docutils literal notranslate"><span class="pre">1645</span></code> and <code class="docutils literal notranslate"><span class="pre">1646</span></code> are all open on the SHM NPS network security group (<code class="docutils literal notranslate"><span class="pre">NSG_SHM_SUBNET_IDENTITY</span></code>).</p></li>
</ul>
</li>
<li><p>Once you have approved the sign in, you should see a remote Windows desktop.</p></li>
<li><p><strong>NOTE:</strong> The other apps will not work until the other servers have been deployed.</p></li>
</ul>
</section>
</section>
<section id="deploy-data-server">
<h2>7. Deploy Data Server<a class="headerlink" href="#deploy-data-server" title="Permalink to this headline">¶</a></h2>
<section id="create-dataserver-vm">
<h3>Create Dataserver VM<a class="headerlink" href="#create-dataserver-vm" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">./Setup_Data_Server.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> script, where the SRE ID is the one specified in the config</p></li>
<li><p>The deployment will take around 20 minutes to complete</p></li>
</ul>
</section>
</section>
<section id="deploy-web-application-servers-gitlab-and-hackmd">
<h2>8. Deploy Web Application Servers (Gitlab and HackMD)<a class="headerlink" href="#deploy-web-application-servers-gitlab-and-hackmd" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">./Create_Web_App_Servers.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> script, where the SRE ID is the one specified in the config</p></li>
<li><p>The deployment will take a few minutes to complete</p></li>
</ul>
<section id="test-gitlab-server">
<h3>Test GitLab Server<a class="headerlink" href="#test-gitlab-server" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>There is a built-in <code class="docutils literal notranslate"><span class="pre">root</span></code> user, whose password is stored in the SRE KeyVault (see SRE config file for KeyVault and secret names).</p></li>
<li><p>You can test Gitlab from inside the RDS environment by connecting to <code class="docutils literal notranslate"><span class="pre">&lt;sre-subnet-data-prefix&gt;.151</span></code> and logging in with the full <code class="docutils literal notranslate"><span class="pre">username&#64;&lt;shm-domain-fqdn&gt;</span></code> of a user in the <code class="docutils literal notranslate"><span class="pre">SG</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">Research</span> <span class="pre">Users</span></code> security group.</p></li>
</ul>
</section>
<section id="test-hackmd-server">
<h3>Test HackMD Server<a class="headerlink" href="#test-hackmd-server" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>You can test HackMD from inside the RDS environment by connecting to <code class="docutils literal notranslate"><span class="pre">&lt;sre-subnet-data-prefix&gt;.152:3000</span></code> and logging in with the full <code class="docutils literal notranslate"><span class="pre">username&#64;&lt;shm-domain-fqdn&gt;</span></code> of a user in the <code class="docutils literal notranslate"><span class="pre">SG</span> <span class="pre">DSGROUP&lt;SRE</span> <span class="pre">ID&gt;</span> <span class="pre">Research</span> <span class="pre">Users</span></code> security group.</p></li>
</ul>
</section>
</section>
<section id="deploy-initial-shared-compute-vm">
<h2>9. Deploy initial shared compute VM<a class="headerlink" href="#deploy-initial-shared-compute-vm" title="Permalink to this headline">¶</a></h2>
<section id="optional-create-a-custom-cloud-init-file-for-the-sre-if-required">
<h3>[OPTIONAL] Create a custom cloud init file for the SRE if required<a class="headerlink" href="#optional-create-a-custom-cloud-init-file-for-the-sre-if-required" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>By default, compute VM deployments will use the <code class="docutils literal notranslate"><span class="pre">cloud-init-compute-vm.template.yaml</span></code> configuration file in the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/cloud_init/</span></code> folder. This does all the necessary steps to configure the VM to work with LDAP.</p></li>
<li><p>If you require additional steps to be taken at deploy time while the VM still has access to the internet (e.g. to install some additional project-specific software), copy the default cloud init file to a file named <code class="docutils literal notranslate"><span class="pre">cloud-init-compute-vm-sre-&lt;SRE</span> <span class="pre">ID&gt;.template.yaml</span></code> in the same folder and add any additional required steps in the <code class="docutils literal notranslate"><span class="pre">SRE-SPECIFIC</span> <span class="pre">COMMANDS</span></code> block marked with comments.</p></li>
</ul>
</section>
<section id="deploy-a-compute-vm">
<h3>Deploy a compute VM<a class="headerlink" href="#deploy-a-compute-vm" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">fetch;git</span> <span class="pre">pull;git</span> <span class="pre">status;git</span> <span class="pre">log</span> <span class="pre">-1</span> <span class="pre">--pretty=&quot;At</span> <span class="pre">commit</span> <span class="pre">%h</span> <span class="pre">(%H)&quot;</span></code> to verify you are on the correct branch and up to date with <code class="docutils literal notranslate"><span class="pre">origin</span></code> (and to output this confirmation and the current commit for inclusion in the deployment record).</p></li>
<li><p>Deploy a new VM into an SRE environment using <code class="docutils literal notranslate"><span class="pre">./Create_Compute_VM.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where the SRE ID is the one specified in the config</p></li>
<li><p>You will also be prompted for the VM size (optional) and the desired last octet of the IP address (the first machine deployed should use <code class="docutils literal notranslate"><span class="pre">160</span></code> here)</p>
<ul>
<li><p>The initial shared VM should be deployed with the last octet <code class="docutils literal notranslate"><span class="pre">160</span></code></p></li>
<li><p>The convention is that subsequent CPU-based VMs are deployed with the next unused last octet in the range <code class="docutils literal notranslate"><span class="pre">161</span></code> to <code class="docutils literal notranslate"><span class="pre">179</span></code> and GPU-based VMs are deployed with the next unused last octet between <code class="docutils literal notranslate"><span class="pre">180</span></code> and <code class="docutils literal notranslate"><span class="pre">199</span></code>.</p></li>
</ul>
</li>
<li><p>After deployment, copy everything from the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">fetch;...</span></code> command and its output to the command prompt returned after the VM deployment and paste this into the deployment log (e.g. a Github issue used to record VM deployments for a SRE or set of SREs)</p></li>
<li><p>The deployment will take around 10 minutes to complete</p></li>
</ul>
</section>
<section id="troubleshooting-compute-vm-deployments">
<h3>Troubleshooting Compute VM deployments<a class="headerlink" href="#troubleshooting-compute-vm-deployments" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Click on the VM in the SRE subscription under the <code class="docutils literal notranslate"><span class="pre">RG_DSG_COMPUTE</span></code> resource group. It will have the last octet of its IP address at the end of its name.</p></li>
<li><p>Click on the “Serial console” item near the bottom of the VM menu on the left hand side of the VM information panel</p></li>
<li><p>If you are not prompted with <code class="docutils literal notranslate"><span class="pre">login:</span></code>, hit enter until the prompt appears</p></li>
<li><p>Enter the username from the <code class="docutils literal notranslate"><span class="pre">&lt;SRE</span> <span class="pre">ID&gt;-dsvm-admin-username</span></code> secret in the SRE KeyVault.</p></li>
<li><p>Enter the password from the <code class="docutils literal notranslate"><span class="pre">&lt;SRE</span> <span class="pre">ID&gt;-dsvm-admin-password</span></code> secret in the SRE KeyVault.</p></li>
<li><p>To validate that our custom <code class="docutils literal notranslate"><span class="pre">cloud-init.yaml</span></code> file has been successfully uploaded, run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cat</span> <span class="pre">/var/lib/cloud/instance/user-data.txt</span></code>. You should see the contents of the <code class="docutils literal notranslate"><span class="pre">secure_research_environment/azure-vms/environment_configs/cloud-init-compute-vm-sre-&lt;SRE</span> <span class="pre">ID&gt;.template.yaml</span></code> file in the Safe Haven git repository.</p></li>
<li><p>To see the output of our custom <code class="docutils literal notranslate"><span class="pre">cloud-init.yaml</span></code> file, run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">tail</span> <span class="pre">-n</span> <span class="pre">200</span> <span class="pre">/var/log/cloud-init-output.log</span></code> and scroll up.</p></li>
</ul>
</section>
</section>
<section id="apply-network-configuration">
<h2>10. Apply network configuration<a class="headerlink" href="#apply-network-configuration" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">./Apply_Network_Configuration.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> script, where the SRE ID is the one specified in the config</p></li>
</ul>
<section id="unpeering-package-mirrors">
<h3>Unpeering package mirrors<a class="headerlink" href="#unpeering-package-mirrors" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Apply_Network_Configuration.ps1</span></code> script ensures that the SRE is peered to the correct mirror network.
However, if you need to unpeer the mirror networks for some reason (e.g. while preparing an SRE subscription for re-use), you can run the unpeering script separately as described below.</p>
<p><strong>Note: this script should not normally be run manually</strong></p>
<ul class="simple">
<li><p>Ensure you have the latest version of the Safe Haven repository from <a class="reference external" href="https://github.com/alan-turing-institute/data-safe-haven">https://github.com/alan-turing-institute/data-safe-haven</a>.</p></li>
<li><p>Open a Powershell terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Safe Haven repository.</p></li>
<li><p>Ensure you are logged into Azure within PowerShell using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">./Unpeer_Sre_And_Mirror_Networks.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> script, where the SRE ID is the one specified in the config</p></li>
</ul>
</section>
</section>
<section id="run-smoke-tests-on-shared-compute-vm">
<h2>11. Run smoke tests on shared compute VM<a class="headerlink" href="#run-smoke-tests-on-shared-compute-vm" title="Permalink to this headline">¶</a></h2>
<p>These tests should be run <strong>after</strong> the network lock down and peering the DSG and mirror VNets. They are automatically uploaded to the compute VM during the deployment step.</p>
<p>To run the smoke tests:</p>
<ul class="simple">
<li><p>Connect to a <strong>remote desktop</strong> on the Main VM (e.g. <code class="docutils literal notranslate"><span class="pre">https://sandbox.dsgroupdev.co.uk/</span></code>) using the “Main VM (Desktop)” app</p></li>
<li><p>Open a terminal session</p></li>
<li><p>Copy the tests folder using <code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">-R</span> <span class="pre">~&lt;sre-admin&gt;/smoke_tests</span> <span class="pre">~/smoke_tests</span></code></p></li>
<li><p>Enter the test directory using <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/smoke_tests/test</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">run_all_tests.sh</span></code>. Check <code class="docutils literal notranslate"><span class="pre">README.md</span></code> if anything is unclear.</p></li>
<li><p>If all test results are expected you are done! Otherwise, contact Turing REG for help diagnosing test failures.</p></li>
</ul>
</section>
<section id="server-list">
<h2>Server list<a class="headerlink" href="#server-list" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The following virtual machines are created as a result of these instructions:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">DC-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code> (domain controller)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DAT-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code> (data server)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HACKMD-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code> (HackMD server)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GITLAB-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code> (GitLab server)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RDG-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code> (Remote Desktop Gateway)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">APP-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code> (Remote Desktop app server)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DKP-SRE-&lt;SRE</span> <span class="pre">ID&gt;</span></code> (Remote Desktop desktop server)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SRE-&lt;SRE</span> <span class="pre">ID&gt;-160-DSVM-0-1-2019082900</span></code>  (initial shared compute VM at IP address <code class="docutils literal notranslate"><span class="pre">&lt;data-subnet-prefix&gt;.160</span></code>)</p></li>
</ul>
</li>
</ul>
</section>
<section id="tearing-down-the-sre">
<h2>Tearing down the SRE<a class="headerlink" href="#tearing-down-the-sre" title="Permalink to this headline">¶</a></h2>
<p>From a clone of the data-safe-haven repository, run the following commands, where <code class="docutils literal notranslate"><span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> is the one defined in the config file.</p>
<div class="highlight-pwsh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd </span><span class="n">deployment</span><span class="p">/</span><span class="n">administration</span>
<span class="p">./</span><span class="n">SRE_Teardown</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-sreId</span> <span class="p">&lt;</span><span class="n">SRE</span> <span class="n">ID</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, The Alan Turing Institute.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 4.3.0.
    Hosted by <a href="https://pages.github.com/">GitHub Pages</a>.
    <br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>