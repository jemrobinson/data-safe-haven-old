
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Administrator documentation &#8212; Data Safe Haven develop documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/overrides.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/toggle.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Policies" href="../../policies/index.html" />
    <link rel="prev" title="Security evaluation checklist" href="security_checklist.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/logo_turing.jpg" class="logo" alt="logo">
</a>      


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../introduction/index.html">
  Introduction
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Roles
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../policies/index.html">
  Policies
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../design/index.html">
  Design
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/alan-turing-institute/data-safe-haven" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../data_provider_representative/index.html">
   Dataset Provider Representative
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../data_provider_representative/data_ingress.html">
     Data ingress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../data_provider_representative/data_egress.html">
     Data egress process
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../investigator/index.html">
   Investigator
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../investigator/data_ingress.html">
     Data ingress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../investigator/data_egress.html">
     Data egress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../investigator/request_software_package.html">
     Requesting new software packages
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../programme_manager/index.html">
   Programme Manager
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../project_manager/index.html">
   Project Manager
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../project_manager/project_lifecycle.html">
     Project lifecycle
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../project_manager/data_ingress.html">
     Data ingress process
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../project_manager/data_egress.html">
     Data egress process
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../referee/index.html">
   Referee
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../researcher/index.html">
   Researcher
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../researcher/user_guide.html">
     User guide
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../researcher/user_guide_guacamole.html">
       User Guide: Apache Guacamole
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../researcher/user_guide_msrds.html">
       User Guide: Microsoft Remote Desktop
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../researcher/available_software.html">
     Available software
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../system_deployer/index.html">
   System Deployer
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../system_deployer/deploy_shm.html">
     Deploy a Safe Haven Management Environment (SHM)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../system_deployer/build_srd_image.html">
     Build an SRE compute image
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../system_deployer/deploy_sre.html">
     Deploy a Secure Research Environment (SRE)
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../system_deployer/deploy_sre_apache_guacamole.html">
       Deploy an SRE with Apache Guacamole
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../system_deployer/deploy_sre_microsoft_rds.html">
       Deploy an SRE with Microsoft RDS
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../system_deployer/migrate_an_shm.html">
     Migrating an SHM
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   System Manager
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="security_checklist.html">
     Security evaluation checklist
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Administrator documentation
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
    
  
  <div class="rst-versions" data-toggle="rst-downloads" role="note" aria-label="downloads">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-file-pdf fa-fw left"></span>
      <span class="left">Download <strong>latest</strong> PDFs</span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_guacamole.pdf">User guide (Apache Guacamole)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_safe_haven_user_guide_msrds.pdf">User guide (Microsoft RDS)</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_full.pdf">Classification flowchart</a></dd>
        
          <dd><a href="/data-safe-haven/develop/pdf/data_classification_flow_simple.pdf">Simplified classification  flowchart</a></dd>
        
      </dl>
    </div>
  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book fa-fw left"></span>
      <span class="left">Currently reading: <strong>develop</strong></span>
      <span class="fa fa-caret-down right"></span>
    </span>
    <div class="rst-other-versions">
      
      
      <dl>
        <dt>Versions</dt>
        
           <strong> 
          <dd><a href="/data-safe-haven/develop/index.html">develop</a></dd>
           </strong> 
        
          
          <dd><a href="/data-safe-haven/v0.1.0-beta/index.html">v0.1.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.2.0-beta/index.html">v0.2.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v0.3.0-beta/index.html">v0.3.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.0-beta/index.html">v1.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.0.1-beta/index.html">v1.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v1.1.0-beta/index.html">v1.1.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v2.0.0-beta/index.html">v2.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.0.0-beta/index.html">v3.0.0-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.0.1-beta/index.html">v3.0.1-beta</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.1.0/index.html">v3.1.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.2.0/index.html">v3.2.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.0/index.html">v3.3.0</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.3.1/index.html">v3.3.1</a></dd>
          
        
          
          <dd><a href="/data-safe-haven/v3.4.0/index.html">v3.4.0</a></dd>
          
        
      </dl>
      
      
    </div>
  </div>
</div>




          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   🌱 Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-new-users">
   🔰 Create new users
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generate-user-details-csv-file">
   📜 Generate user details CSV file
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-data-classification-app">
     🚗 Using data classification app
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#manually-edit-csv">
     ✋ Manually edit CSV
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-and-synchronise-users">
   🔄 Create and synchronise users
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#assign-mfa-licences">
   📲 Assign MFA licences
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#manually-add-licence-to-each-user">
     ✋ Manually add licence to each user
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#automatically-assign-licences-to-users">
     🚗 Automatically assign licences to users
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#user-activation">
   🏃 User activation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-user-problems">
   👷 Common user problems
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#expired-webclient-certificate">
     🌘 Expired webclient certificate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unable-to-log-into-remote-desktop-gateway">
     🔴 Unable to log into remote desktop gateway
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unable-to-open-any-remote-apps">
     🚋 Unable to open any remote apps
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#xrdp-login-failure-on-the-srd">
     ⁉️ xrdp login failure on the SRD
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unable-to-install-from-package-mirrors">
     ☁️ Unable to install from package mirrors
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cost-management">
   💵 Cost management
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shut-down-an-shm-or-sre">
   👇 Shut down an SHM or SRE
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#start-up-an-shm-or-sre">
   👢 Start up an SHM or SRE
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#updating-repository-package-allowlists">
   📦 Updating repository package allowlists
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tear-down-shm-package-mirrors">
   💢 Tear down SHM package mirrors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ingress-and-egress">
   Ingress and Egress
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-ingress">
     Data Ingress
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#software-ingress">
     Software Ingress
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-egress">
     Data egress
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-output-volume">
       The output volume
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#backup">
   🗄️ Backup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#restoring-blobs">
     🗃️ Restoring blobs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#restoring-disks">
     💿 Restoring disks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enrolling-restored-disks-for-backup">
     💿 Enrolling restored disks for backup
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#remove-a-deployed-safe-haven">
   🔚 Remove a deployed Safe Haven
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tear-down-an-sre">
     🔥 Tear down an SRE
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tear-down-the-shm">
     💣 Tear down the SHM
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#disconnect-from-the-azure-active-directory">
       🔓 Disconnect from the Azure Active Directory
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tear-down-any-attached-sres-then-the-shm">
       💥 Tear down any attached SREs then the SHM
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/alan-turing-institute/data-safe-haven/edit/develop/docs/roles/system_manager/administrator_guide.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="administrator-documentation">
<h1>Administrator documentation<a class="headerlink" href="#administrator-documentation" title="Permalink to this headline">¶</a></h1>
<section id="prerequisites">
<h2>🌱 Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>This document assumes that you already have access a <a class="reference internal" href="../system_deployer/deploy_shm.html#deploy-shm"><span class="std std-ref">Safe Haven Management (SHM) environment</span></a> and one or more <a class="reference internal" href="../system_deployer/deploy_sre.html#deploy-sre"><span class="std std-ref">Secure Research Environments (SREs)</span></a> that are linked to it.</p>
<ul class="simple">
<li><p>You will need VPN access to the SHM as described in the deployment instructions</p></li>
</ul>
</section>
<section id="create-new-users">
<h2>🔰 Create new users<a class="headerlink" href="#create-new-users" title="Permalink to this headline">¶</a></h2>
<p>Users should be created on the main domain controller (DC1) in the SHM and synchronised to Azure Active Directory.
A helper script for doing this is already uploaded to the domain controller - you will need to prepare a <code class="docutils literal notranslate"><span class="pre">CSV</span></code> file in the appropriate format for it.</p>
</section>
<section id="generate-user-details-csv-file">
<h2>📜 Generate user details CSV file<a class="headerlink" href="#generate-user-details-csv-file" title="Permalink to this headline">¶</a></h2>
<section id="using-data-classification-app">
<h3>🚗 Using data classification app<a class="headerlink" href="#using-data-classification-app" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Follow the <a class="reference external" href="https://github.com/alan-turing-institute/data-classification-app">instructions in the classification app documentation</a> to create users</p>
<ul class="simple">
<li><p>Users can be created in bulk by selecting <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">User</span> <span class="pre">&gt;</span> <span class="pre">Import</span> <span class="pre">user</span> <span class="pre">list</span></code> and uploading a spreadsheet of user details</p></li>
<li><p>Users can also be created individually by selecting <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">User</span> <span class="pre">&gt;</span> <span class="pre">Create</span> <span class="pre">Single</span> <span class="pre">User</span></code></p></li>
</ul>
</li>
<li><p>After creating users, export the <code class="docutils literal notranslate"><span class="pre">UserCreate.csv</span></code> file</p>
<ul class="simple">
<li><p>To export all users, select <code class="docutils literal notranslate"><span class="pre">Users</span> <span class="pre">&gt;</span> <span class="pre">Export</span> <span class="pre">UserCreate.csv</span></code></p></li>
<li><p>To export only users for a particular project, select <code class="docutils literal notranslate"><span class="pre">Projects</span> <span class="pre">&gt;</span> <span class="pre">(Project</span> <span class="pre">Name)</span> <span class="pre">&gt;</span> <span class="pre">Export</span> <span class="pre">UserCreate.csv</span></code></p></li>
</ul>
</li>
<li><p>Upload the user details CSV file to a sensible location on the SHM domain controller</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We suggest using <code class="docutils literal notranslate"><span class="pre">C:\Installation\YYYYDDMM-HHMM_user_details.csv</span></code> but this is up to you</p>
</div>
</li>
</ul>
</section>
<section id="manually-edit-csv">
<h3>✋ Manually edit CSV<a class="headerlink" href="#manually-edit-csv" title="Permalink to this headline">¶</a></h3>
<p>On the <strong>SHM domain controller (DC1)</strong>.</p>
<ul>
<li><p>Make a new copy of the user details template file from <code class="docutils literal notranslate"><span class="pre">C:\Installation\user_details_template.csv</span></code></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We suggest naming this <code class="docutils literal notranslate"><span class="pre">YYYYDDMM-HHMM_user_details.csv</span></code> but this is up to you</p>
</div>
</li>
<li><p>Remove the example user and add the required details for each user</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SamAccountName</span></code>: Log in username <strong>without</strong> the <code class="docutils literal notranslate"><span class="pre">&#64;&lt;SRE</span> <span class="pre">domain&gt;</span></code> part.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We recommend using <code class="docutils literal notranslate"><span class="pre">firstname.lastname</span></code> format.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Ensure that <code class="docutils literal notranslate"><span class="pre">SamAccountName</span></code> has a maximum of <strong>20 characters</strong> from the 7-bit ASCII set (unnaccented letters, numbers and some punctuation) or synchronisation will fail.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">GivenName</span></code>: User’s first / given name</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Ensure that <code class="docutils literal notranslate"><span class="pre">GivenName</span></code> uses only characters from the 7-bit ASCII set (unnaccented letters, numbers and some punctuation) or synchronisation will fail.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Surname</span></code>: User’s last name / surname</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Ensure that <code class="docutils literal notranslate"><span class="pre">Surname</span></code> uses only characters from the 7-bit ASCII set (unnaccented letters, numbers and some punctuation) or synchronisation will fail.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Mobile</span></code>: Phone number to use for initial password reset.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<ul class="simple">
<li><p>This must include country code in the format <code class="docutils literal notranslate"><span class="pre">+&lt;country-code&gt;</span> <span class="pre">&lt;local</span> <span class="pre">number&gt;</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">+44</span> <span class="pre">7123456789</span></code>).</p></li>
<li><p>Include a space between the country code and local number parts but no other spaces.</p></li>
<li><p>Remove the leading <code class="docutils literal notranslate"><span class="pre">0</span></code> from local number if present.</p></li>
<li><p>This can be a landline or or mobile but must be accessible to the user when resetting their password and setting up MFA.</p></li>
<li><p>Users can add the authenticator app and/or additional phone numbers during MFA self-registration.</p></li>
</ul>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">SecondaryEmail</span></code>: An existing organisational email address for the user.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is <strong>not</strong> uploaded to their Data Safe Haven user account but is needed when sending account activation messages.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">GroupName</span></code>: [Optional] The name of the Active Directory security group(s) that the users should be added (eg. <code class="docutils literal notranslate"><span class="pre">SG</span> <span class="pre">SANDBOX</span> <span class="pre">Research</span> <span class="pre">Users</span></code> ).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If the user needs to be added to multiple groups, separate them with a pipe-character ( <code class="docutils literal notranslate"><span class="pre">|</span></code> ).</p>
</div>
</li>
</ul>
</li>
</ul>
</section>
</section>
<section id="create-and-synchronise-users">
<h2>🔄 Create and synchronise users<a class="headerlink" href="#create-and-synchronise-users" title="Permalink to this headline">¶</a></h2>
<p>Upload the user details <code class="docutils literal notranslate"><span class="pre">CSV</span></code> file to a sensible location on the SHM domain controller (recommended: <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code>).
This can be done by copying and pasting the file from your deployment device to the SHM DC.</p>
<ul class="simple">
<li><p>Log into the <strong>SHM primary domain controller</strong> (<code class="docutils literal notranslate"><span class="pre">DC1-SHM-&lt;SHM</span> <span class="pre">ID&gt;</span></code>) VM using the login credentials <a class="reference internal" href="../system_deployer/deploy_shm.html#roles-system-deployer-shm-remote-desktop"><span class="std std-ref">stored in Azure Key Vault</span></a></p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> command window with elevated privileges</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">C:\Installation\CreateUsers.ps1</span> <span class="pre">&lt;path_to_user_details_file&gt;</span></code></p></li>
<li><p>This script will add the users and trigger synchronisation with Azure Active Directory</p></li>
<li><p>It will still take around 5 minutes for the changes to propagate</p></li>
</ul>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>If you get the message <code class="docutils literal notranslate"><span class="pre">New-ADUser</span> <span class="pre">:</span> <span class="pre">The</span> <span class="pre">specified</span> <span class="pre">account</span> <span class="pre">already</span> <span class="pre">exists</span></code> you should first check to see whether that user actually does already exist!
Once you’re certain that you’re adding a new user, make sure that the following fields are unique across all users in the Active Directory.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SamAccountName</span></code></p>
<ul>
<li><p>Specified explicitly in the <code class="docutils literal notranslate"><span class="pre">CSV</span></code> file.</p></li>
<li><p>If this is already in use, consider something like <code class="docutils literal notranslate"><span class="pre">firstname.middle.initials.lastname</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">DistinguishedName</span></code></p>
<ul>
<li><p>Formed of <code class="docutils literal notranslate"><span class="pre">CN=&lt;DisplayName&gt;,&lt;OUPath&gt;</span></code> by <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Directory</span></code> on user creation.</p></li>
<li><p>If this is in use, consider changing <code class="docutils literal notranslate"><span class="pre">DisplayName</span></code> from <code class="docutils literal notranslate"><span class="pre">&lt;GivenName&gt;</span> <span class="pre">&lt;Surname&gt;</span></code> to <code class="docutils literal notranslate"><span class="pre">&lt;GivenName&gt;</span> <span class="pre">&lt;middle</span> <span class="pre">initials&gt;</span> <span class="pre">&lt;Surname&gt;</span></code> .</p></li>
</ul>
</li>
</ul>
</div>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<ul class="simple">
<li><p>These domain administrator credentials have complete control over creating and deleting users as well as assigning them to groups</p></li>
<li><p>Do not use them except where specified and never write them down!</p></li>
<li><p>Be particularly careful never to use them to log in to any user-accessible VMs (such as the SRDs)</p></li>
</ul>
</div>
</section>
<section id="assign-mfa-licences">
<h2>📲 Assign MFA licences<a class="headerlink" href="#assign-mfa-licences" title="Permalink to this headline">¶</a></h2>
<section id="manually-add-licence-to-each-user">
<h3>✋ Manually add licence to each user<a class="headerlink" href="#manually-add-licence-to-each-user" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Login into the Azure Portal and connect to the correct AAD</p></li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code></p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">&gt;</span> <span class="pre">Licenses</span> <span class="pre">&gt;</span> <span class="pre">All</span> <span class="pre">Products</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span> <span class="pre">Premium</span> <span class="pre">P1</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Assign</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Users</span> <span class="pre">and</span> <span class="pre">groups</span></code></p></li>
<li><p>Select the users you have recently created and click <code class="docutils literal notranslate"><span class="pre">Select</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Assign</span></code> to complete the process</p></li>
</ul>
</section>
<section id="automatically-assign-licences-to-users">
<h3>🚗 Automatically assign licences to users<a class="headerlink" href="#automatically-assign-licences-to-users" title="Permalink to this headline">¶</a></h3>
<p>To automatically assign licences to all local <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Directory</span></code> users that do not currently have a licence in <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Active</span> <span class="pre">Directory</span></code>.</p>
<ul class="simple">
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">./SHM_Add_AAD_Licences.ps1</span> <span class="pre">-tenantId</span> <span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> script, where <code class="docutils literal notranslate"><span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> is the ID of the Azure tenant belonging to the SHM you want to add the licences to</p></li>
</ul>
</section>
</section>
<section id="user-activation">
<h2>🏃 User activation<a class="headerlink" href="#user-activation" title="Permalink to this headline">¶</a></h2>
<p>We recommend using email to send connection details to new users.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is not a security risk since:</p>
<ul class="simple">
<li><p>we are not sending passwords in this email</p></li>
<li><p>the user needs access to their previously-provided phone number in order to set their account password and MFA</p></li>
</ul>
</div>
<p>A sample email might look like the following</p>
<blockquote>
<div><p>Dear &lt;participant name&gt;,</p>
<p>Welcome to &lt;event name&gt;! You’ve been given access to a Data Safe Haven managed by &lt;organisation name&gt;.
Please find a PDF version of our user guide attached.
You should start by following the instructions about setting up your account and enabling multi-factor authentication (MFA).</p>
<p>Your username is: &lt;username&#64;domain&gt;
Your Safe Haven is hosted at: &lt;URL&gt;</p>
<p>The Safe Haven is only accessible from certain networks and may also involve physical location restrictions.</p>
<p>–details about network and location/VPN restrictions here–</p>
</div></blockquote>
</section>
<section id="common-user-problems">
<h2>👷 Common user problems<a class="headerlink" href="#common-user-problems" title="Permalink to this headline">¶</a></h2>
<p>One of the most common user issues is that they are unable to log in to the environment.
Here we go through the login procedure and discuss possible problems at each step</p>
<section id="expired-webclient-certificate">
<h3>🌘 Expired webclient certificate<a class="headerlink" href="#expired-webclient-certificate" title="Permalink to this headline">¶</a></h3>
<p>If the certificate for the SRE domain has expired, users will not be able to login.</p>
<img alt="Login failure - expired certificate" class="align-center" src="../../_images/login_certificate_expiry.png" />
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Solution</strong>: Replace the SSL certificate with a new one</p>
<ul class="simple">
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Ensure you are logged into the <code class="docutils literal notranslate"><span class="pre">Azure</span></code> within <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">./Update_SRE_RDS_Ssl_Certificate.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code>, where the SRE ID is the one specified in the config</p></li>
</ul>
</div>
</section>
<section id="unable-to-log-into-remote-desktop-gateway">
<h3>🔴 Unable to log into remote desktop gateway<a class="headerlink" href="#unable-to-log-into-remote-desktop-gateway" title="Permalink to this headline">¶</a></h3>
<p>If users give the wrong username or password they will not be able to progress past the login screen.</p>
<img alt="Login failure - wrong password" class="align-center" src="../../_images/login_password_login.png" />
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Solution</strong>: Check user credentials, password may need to be reset.</p>
</div>
</section>
<section id="unable-to-open-any-remote-apps">
<h3>🚋 Unable to open any remote apps<a class="headerlink" href="#unable-to-open-any-remote-apps" title="Permalink to this headline">¶</a></h3>
<p>Users are stuck at the <code class="docutils literal notranslate"><span class="pre">Opening</span> <span class="pre">remote</span> <span class="pre">port</span></code> message and never receive the MFA prompt.</p>
<img alt="Login failure - no MFA prompt" class="align-center" src="../../_images/srd_login_opening_port.png" />
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Solution</strong>: Check MFA setup</p>
<ul class="simple">
<li><p>Ensure that the user has been assigned a license in Azure Active Directory</p></li>
<li><p>Check that the user has set up MFA (at <a class="reference external" href="https://aka.ms/mfasetup">https://aka.ms/mfasetup</a> ) and is using the phone-call or app authentication method</p></li>
</ul>
</div>
</section>
<section id="xrdp-login-failure-on-the-srd">
<h3>⁉️ xrdp login failure on the SRD<a class="headerlink" href="#xrdp-login-failure-on-the-srd" title="Permalink to this headline">¶</a></h3>
<p>If users can get to the login screen:</p>
<img alt="SRD login screen" class="align-center" src="../../_images/srd_login_prompt.png" />
<p>but then see this error message:</p>
<img alt="SRD login failure" class="align-center" src="../../_images/srd_login_failure1.png" />
<p>there are a couple of possible causes.</p>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p><strong>Problem</strong>: the username or password was incorrectly entered</p>
<p><strong>Solution</strong>: check username and password</p>
<ul class="simple">
<li><p>Confirm that the username and password have been correctly typed</p></li>
<li><p>Confirm that there are no unsupported special characters in the password</p></li>
<li><p>Reset the account if there is no other solution</p></li>
</ul>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p><strong>Problem</strong>: the computer is unable to communicate with the login server</p>
<p><strong>Solution</strong>: run diagnostics</p>
<ul class="simple">
<li><p>This can happen for a variety of reasons (DNS problems, broken services on the SRD etc.)</p></li>
<li><p>Run the script under <code class="docutils literal notranslate"><span class="pre">deployment/administration/SRE_SRD_Remote_Diagnostics.ps1</span></code>, providing the group and last IP octet of the problematic SRD</p></li>
<li><p>This will run a series of diagnostics intended to fix some common problems including</p>
<ul>
<li><p>LDAP configuration</p></li>
<li><p>DNS configuration</p></li>
<li><p>SSS configuration</p></li>
<li><p>File mounting configuration</p></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="unable-to-install-from-package-mirrors">
<h3>☁️ Unable to install from package mirrors<a class="headerlink" href="#unable-to-install-from-package-mirrors" title="Permalink to this headline">¶</a></h3>
<p>If it is not possible to install packages from the package mirrors then this may be for one of the following reasons:</p>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p><strong>Problem</strong>: Mirror VNet is not correctly peered</p>
<p><strong>Solution</strong>: Re-run the network configuration script.</p>
<p>On your <strong>deployment machine</strong>.</p>
<ul class="simple">
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/secure_research_environment/setup</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Ensure you are logged into <code class="docutils literal notranslate"><span class="pre">Azure</span></code> within <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code></p>
<ul>
<li><p>NB. If your account is a guest in additional Azure tenants, you may need to add the <code class="docutils literal notranslate"><span class="pre">-Tenant</span> <span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> flag, where <code class="docutils literal notranslate"><span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> is the ID of the Azure tenant you want to deploy into.</p></li>
</ul>
</li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">./Apply_Network_Configuration.ps1</span> <span class="pre">-sreId</span> <span class="pre">&lt;SRE</span> <span class="pre">ID&gt;</span></code> script, where the SRE ID is the one specified in the config</p></li>
</ul>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p><strong>Problem</strong>: Internal mirror does not have the required package</p>
<p><strong>Solution</strong>: Check package availability</p>
<p>To diagnose this, log into the <code class="docutils literal notranslate"><span class="pre">Internal</span></code> mirror using the Serial Console through the <code class="docutils literal notranslate"><span class="pre">Azure</span></code> portal.
Check the packages directory (i.e. <code class="docutils literal notranslate"><span class="pre">/datadrive/mirrordaemon/pypi/web/packages</span></code> for PyPI or <code class="docutils literal notranslate"><span class="pre">/datadrive/mirrordaemon/www/cran</span></code> for CRAN)</p>
<img alt="Internal mirror package list" class="align-center" src="../../_images/internal_mirror_packages.png" />
</div>
<p>If the requested package <strong>should</strong> be available (i.e. it is on the appropriate allowlist), then you can force a mirror update by rebooting the <code class="docutils literal notranslate"><span class="pre">EXTERNAL</span></code> mirrors.
This will trigger the following actions:</p>
<ol class="simple">
<li><p>Synchronisation of the external mirror with the remote, internet repository (a <code class="docutils literal notranslate"><span class="pre">pull</span></code> update)</p></li>
<li><p>Synchronisation of the internal mirror with the external mirror (a <code class="docutils literal notranslate"><span class="pre">push</span></code> update)</p></li>
</ol>
<p>This may take an hour or two but should solve the missing package problem.</p>
</section>
</section>
<section id="cost-management">
<h2>💵 Cost management<a class="headerlink" href="#cost-management" title="Permalink to this headline">¶</a></h2>
<p>When and SHM and/or SRE is not being used, it can be cost-efficient to shut it down in order to save on some of the ongoing running costs.</p>
</section>
<section id="shut-down-an-shm-or-sre">
<h2>👇 Shut down an SHM or SRE<a class="headerlink" href="#shut-down-an-shm-or-sre" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you may want to temporarily shut down an SHM or SRE, rather than tearing it down entirely.
You can do that with these scripts:</p>
<p>On your <strong>deployment machine</strong>.</p>
<ul class="simple">
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Then do one or both of the following:</p></li>
</ul>
<div class="admonition-shut-down-shm admonition">
<p class="admonition-title">Shut down SHM</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="p">./</span><span class="n">SHM_Manage_VMs</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">shm</span> <span class="n">id</span><span class="p">&gt;</span> <span class="n">-Action</span> <span class="n">EnsureStopped</span> <span class="n">-Group</span> <span class="n">All</span>
</pre></div>
</div>
</div>
<div class="admonition-shut-down-sre admonition">
<p class="admonition-title">Shut down SRE</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">./</span><span class="n">SRE_Manage_VMs</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">shm</span> <span class="n">id</span><span class="p">&gt;</span> <span class="n">-sreId</span> <span class="p">&lt;</span><span class="n">sre</span> <span class="n">id</span><span class="p">&gt;</span> <span class="n">-Action</span> <span class="n">EnsureStopped</span>
</pre></div>
</div>
</div>
</section>
<section id="start-up-an-shm-or-sre">
<h2>👢 Start up an SHM or SRE<a class="headerlink" href="#start-up-an-shm-or-sre" title="Permalink to this headline">¶</a></h2>
<p>If you need to reboot an SHM or SRE that is not running, you can use the same scripts youused to shut them down, but changing the <code class="docutils literal notranslate"><span class="pre">-Action</span></code> flag to <code class="docutils literal notranslate"><span class="pre">EnsureStopped</span></code>, see below.</p>
<p>On your <strong>deployment machine</strong>.</p>
<ul class="simple">
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">./SHM_Manage_VMs.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;shm</span> <span class="pre">id&gt;</span> <span class="pre">-Action</span> <span class="pre">EnsureStarted</span> <span class="pre">-Group</span> <span class="pre">All</span></code> to restart the SHM</p></li>
<li><p>For each SRE, run <code class="docutils literal notranslate"><span class="pre">./SRE_Manage_VMs.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;shm</span> <span class="pre">id&gt;</span> <span class="pre">-sreId</span> <span class="pre">&lt;sre</span> <span class="pre">id&gt;</span> <span class="pre">-Action</span> <span class="pre">EnsureStarted</span></code></p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the Azure subscription that you have deployed into runs out of credit, the SHM and/or SRE will be shutdown automatically.</p>
</div>
</section>
<section id="updating-repository-package-allowlists">
<h2>📦 Updating repository package allowlists<a class="headerlink" href="#updating-repository-package-allowlists" title="Permalink to this headline">¶</a></h2>
<p>For a <a class="reference internal" href="../../policies/data_sensitivity_classification/sensitivity_tiers.html#policy-tier-3"><span class="std std-ref">Tier 3</span></a> SRE only the packages named in the allowlists at <code class="docutils literal notranslate"><span class="pre">environment_configs/package_lists/</span></code> can be installed by users.</p>
<p>To update the allowlists on an SHM, you should use the <code class="docutils literal notranslate"><span class="pre">SHM_Package_Repository_Update_Allowlists.ps1</span></code> script.</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">deployment</span><span class="p">/</span><span class="n">administration</span><span class="p">/</span><span class="n">SHM_Package_Repository_Update_Allowlists</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">SHM</span> <span class="n">ID</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>By default, this script will use the allowlists present in <code class="docutils literal notranslate"><span class="pre">environment_configs/package_lists/</span></code> but you may use the <code class="docutils literal notranslate"><span class="pre">-allowlistDirectory</span></code> option to specify another directory containing the allowlists.
It is assumed that the allowlists will have the same names as those in in <code class="docutils literal notranslate"><span class="pre">environment_configs/package_lists/</span></code>.</p>
</section>
<section id="tear-down-shm-package-mirrors">
<h2>💢 Tear down SHM package mirrors<a class="headerlink" href="#tear-down-shm-package-mirrors" title="Permalink to this headline">¶</a></h2>
<p>During normal usage of the SHM, you should not need to tear down the package mirrors.
However, if you no longer have any SREs at a particular tier and you want to save on the costs of running the mirrors, you might decide to do so.</p>
<p>On your <strong>deployment machine</strong>.</p>
<ul class="simple">
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team.</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Data Safe Haven repository.</p></li>
<li><p>Ensure you are logged into <code class="docutils literal notranslate"><span class="pre">Azure</span></code> within <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code>. This command will give you a URL and a short alphanumeric code. You will need to visit that URL in a web browser and enter the code</p>
<ul>
<li><p>NB. If your account is a guest in additional Azure tenants, you may need to add the <code class="docutils literal notranslate"><span class="pre">-Tenant</span> <span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> flag, where <code class="docutils literal notranslate"><span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> is the ID of the Azure tenant you want to deploy into.</p></li>
</ul>
</li>
<li><p>Tear down the package mirrors by running <code class="docutils literal notranslate"><span class="pre">./SHM_Package_Repository_Teardown.ps1</span> <span class="pre">-shmId</span> <span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span> <span class="pre">-tier</span> <span class="pre">&lt;desired</span> <span class="pre">tier&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code> is the <a class="reference internal" href="../system_deployer/deploy_shm.html#roles-deployer-shm-id"><span class="std std-ref">management environment ID</span></a> specified in the configuration file.</p></li>
<li><p>This will take <strong>a few minutes</strong> to run.</p></li>
</ul>
</section>
<section id="ingress-and-egress">
<h2>Ingress and Egress<a class="headerlink" href="#ingress-and-egress" title="Permalink to this headline">¶</a></h2>
<section id="data-ingress">
<span id="roles-system-manager-data-ingress"></span><h3>Data Ingress<a class="headerlink" href="#data-ingress" title="Permalink to this headline">¶</a></h3>
<p>It is the data provider’s responsibility to upload the data required by the safe haven.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Any data ingress must be signed off by the <a class="reference internal" href="../data_provider_representative/index.html#role-data-provider-representative"><span class="std std-ref">Dataset Provider Representative</span></a>, <a class="reference internal" href="../investigator/index.html#role-investigator"><span class="std std-ref">Investigator</span></a> and <a class="reference internal" href="../referee/index.html#role-referee"><span class="std std-ref">Referee</span></a> (if applicable).</p>
</div>
<p>The following steps show how to generate a temporary write-only upload token that can be securely sent to the data provider, enabling them to upload the data:</p>
<ul class="simple">
<li><p>In the Azure portal select <code class="docutils literal notranslate"><span class="pre">Subscriptions</span></code> then navigate to the subscription containing the relevant SHM</p></li>
<li><p>Search for the resource group: <code class="docutils literal notranslate"><span class="pre">RG_SHM_&lt;SHM</span> <span class="pre">ID&gt;_PERSISTENT_DATA</span></code>, then click through to the storage account called: <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">ID&gt;&lt;SRE</span> <span class="pre">ID&gt;data&lt;storage</span> <span class="pre">suffix&gt;</span></code> (where <code class="docutils literal notranslate"><span class="pre">&lt;storage</span> <span class="pre">suffix&gt;</span></code> is a random string)</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Networking</span></code> under <code class="docutils literal notranslate"><span class="pre">Settings</span></code> and paste the data providers IP address as one of those allowed under the <code class="docutils literal notranslate"><span class="pre">Firewall</span></code> header, then hit the save icon in the top left</p></li>
<li><p>From the <code class="docutils literal notranslate"><span class="pre">Overview</span></code> tab, click the link to <code class="docutils literal notranslate"><span class="pre">Containers</span></code> (in the middle of the page)</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">ingress</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Shared</span> <span class="pre">access</span> <span class="pre">signature</span></code> under <code class="docutils literal notranslate"><span class="pre">Settings</span></code> and do the following:</p>
<ul>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Permissions</span></code>, check these boxes:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Write</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">List</span></code></p></li>
</ul>
</li>
<li><p>Set a 24 hour time window in the <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">and</span> <span class="pre">expiry</span> <span class="pre">date/time</span></code> (or an appropriate length of time)</p></li>
<li><p>Leave everything else as default click <code class="docutils literal notranslate"><span class="pre">Generate</span> <span class="pre">SAS</span> <span class="pre">token</span> <span class="pre">and</span> <span class="pre">URL</span></code></p></li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">Blob</span> <span class="pre">SAS</span> <span class="pre">URL</span></code></p></li>
</ul>
</li>
<li><p>Send the <code class="docutils literal notranslate"><span class="pre">Blob</span> <span class="pre">SAS</span> <span class="pre">URL</span></code> to the data provider via secure email (for example, you could use the <a class="reference external" href="https://www.egress.com/">Egress secure email</a> service)</p></li>
<li><p>The data provider should now be able to upload data by following <a class="reference internal" href="../data_provider_representative/data_ingress.html#role-data-provider-representative-ingress-upload"><span class="std std-ref">these instructions</span></a></p></li>
<li><p>You can validate successful data ingress by logging into the SRD for the SRE and checking the <code class="docutils literal notranslate"><span class="pre">/data</span></code> volume, where you should be able to view the data that the data provider has uploaded</p></li>
</ul>
</section>
<section id="software-ingress">
<span id="roles-system-manager-software-ingress"></span><h3>Software Ingress<a class="headerlink" href="#software-ingress" title="Permalink to this headline">¶</a></h3>
<p>Software ingress is performed in a similar manner to data.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Software ingress must go through the same <a class="reference internal" href="../../policies/security/software_package_approval_policy.html#policy-security-package-approval"><span class="std std-ref">approval policy</span></a> as is the case for data ingress, including sign-off from the <a class="reference internal" href="../data_provider_representative/index.html#role-data-provider-representative"><span class="std std-ref">Dataset Provider Representative</span></a>, <a class="reference internal" href="../investigator/index.html#role-investigator"><span class="std std-ref">Investigator</span></a> and <a class="reference internal" href="../referee/index.html#role-referee"><span class="std std-ref">Referee</span></a> (if applicable).</p>
</div>
<ul class="simple">
<li><p>Follow the same steps as for <a class="reference internal" href="#roles-system-manager-data-ingress"><span class="std std-ref">data ingress</span></a> above to provide temporary write access, but set the time window for the SAS token to a shorter period (e.g. several hours)</p></li>
<li><p>Share the token with the <a class="reference internal" href="../investigator/index.html#role-investigator"><span class="std std-ref">Investigator</span></a>, so they can install software within the time window</p></li>
<li><p>The <a class="reference internal" href="../investigator/index.html#role-investigator"><span class="std std-ref">Investigator</span></a> can perform software ingress via <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Storage</span> <span class="pre">Explorer</span></code> (for instance as a zip file), by following the same instructions as <a class="reference internal" href="../data_provider_representative/data_ingress.html#role-data-provider-representative-ingress"><span class="std std-ref">the data provider</span></a></p></li>
</ul>
</section>
<section id="data-egress">
<span id="roles-system-manager-data-egress"></span><h3>Data egress<a class="headerlink" href="#data-egress" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>In the Azure portal select <code class="docutils literal notranslate"><span class="pre">Subscriptions</span></code> then navigate to the subscription containing the relevant SHM</p></li>
<li><p>Search for the resource group: <code class="docutils literal notranslate"><span class="pre">RG_SHM_&lt;SHM</span> <span class="pre">ID&gt;_PERSISTENT_DATA</span></code>, then click through to the storage account called: <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">ID&gt;&lt;SRE</span> <span class="pre">ID&gt;data&lt;storage</span> <span class="pre">suffix&gt;</span></code> (where <code class="docutils literal notranslate"><span class="pre">&lt;storage</span> <span class="pre">suffix&gt;</span></code> is a random string)</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Networking</span></code> under <code class="docutils literal notranslate"><span class="pre">Settings</span></code> to check the list of pre-approved IP addresses allowed under the <code class="docutils literal notranslate"><span class="pre">Firewall</span></code> header and check your own IP address to ensure you are connecting from one of these</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Containers</span></code> under <code class="docutils literal notranslate"><span class="pre">Data</span> <span class="pre">storage</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">egress</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Shared</span> <span class="pre">access</span> <span class="pre">signature</span></code> under <code class="docutils literal notranslate"><span class="pre">Settings</span></code> and do the following:</p>
<ul>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Permissions</span></code>, check these boxes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Read</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">List</span></code></p></li>
</ul>
</li>
<li><p>Set a time window in the <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">and</span> <span class="pre">expiry</span> <span class="pre">date/time</span></code> that gives you enough time to extract the data</p></li>
<li><p>Leave everything else as default click <code class="docutils literal notranslate"><span class="pre">Generate</span> <span class="pre">SAS</span> <span class="pre">token</span> <span class="pre">and</span> <span class="pre">URL</span></code></p>
<img alt="Read-only SAS token" class="align-center" src="../../_images/read_only_sas_token.png" />
</li>
<li><p>Leave this portal window open and move to the next step</p></li>
</ul>
</li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Storage</span> <span class="pre">Explorer</span></code> (<a class="reference external" href="https://azure.microsoft.com/en-us/features/storage-explorer/">download</a> it if you don’t have it)</p></li>
<li><p>Click the socket image on the left hand side</p>
<img alt="Azure Storage Explorer connection" class="align-center" src="../../_images/azure_storage_explorer_connect.png" />
</li>
<li><p>On <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">Resource</span></code>, choose <code class="docutils literal notranslate"><span class="pre">Blob</span> <span class="pre">container</span></code></p></li>
<li><p>On <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">Connection</span> <span class="pre">Method</span></code>, choose <code class="docutils literal notranslate"><span class="pre">Shared</span> <span class="pre">access</span> <span class="pre">signature</span> <span class="pre">URL</span> <span class="pre">(SAS)</span></code> and hit <code class="docutils literal notranslate"><span class="pre">Next</span></code></p>
<img alt="Connect with SAS token" class="align-center" src="../../_images/connect_azure_storage.png" />
</li>
<li><p>On <code class="docutils literal notranslate"><span class="pre">Enter</span> <span class="pre">Connection</span> <span class="pre">Info</span></code>:</p>
<ul class="simple">
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">Display</span> <span class="pre">name</span></code> to “egress” (or choose an informative name)</p></li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">Blob</span> <span class="pre">SAS</span> <span class="pre">URL</span></code> from your Azure portal session into the <code class="docutils literal notranslate"><span class="pre">Blob</span> <span class="pre">container</span> <span class="pre">SAS</span> <span class="pre">URL</span></code> box and hit <code class="docutils literal notranslate"><span class="pre">Next</span></code></p></li>
</ul>
</li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Summary</span></code> page, hit <code class="docutils literal notranslate"><span class="pre">Connect</span></code></p></li>
<li><p>On the left hand side, the connection should show up under <code class="docutils literal notranslate"><span class="pre">Local</span> <span class="pre">&amp;</span> <span class="pre">Attached</span> <span class="pre">&gt;</span> <span class="pre">Storage</span> <span class="pre">Accounts</span> <span class="pre">&gt;</span> <span class="pre">(Attached</span> <span class="pre">Containers)</span> <span class="pre">&gt;</span> <span class="pre">Blob</span> <span class="pre">Containers</span> <span class="pre">&gt;</span> <span class="pre">ingress</span> <span class="pre">(SAS)</span></code></p></li>
<li><p>You should now be able to securely download the data from the Safe Haven’s output volume by highlighting the relevant file(s) and hitting the <code class="docutils literal notranslate"><span class="pre">Download</span></code> button</p></li>
</ul>
<section id="the-output-volume">
<h4>The output volume<a class="headerlink" href="#the-output-volume" title="Permalink to this headline">¶</a></h4>
<p>Once you have set up the egress connection in <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Storage</span> <span class="pre">Explorer</span></code>, you should be able to view data from the <strong>output volume</strong>, a read-write area intended for the extraction of results, such as figures for publication.
On the SRD, this volume is <code class="docutils literal notranslate"><span class="pre">/output</span></code> and is shared between all SRDs in an SRE.
For more info on shared SRE storage volumes, consult the <a class="reference internal" href="../researcher/user_guide_guacamole.html#role-researcher-user-guide-shared-storage"><span class="std std-ref">Safe Haven User Guide</span></a>.</p>
</section>
</section>
</section>
<section id="backup">
<h2>🗄️ Backup<a class="headerlink" href="#backup" title="Permalink to this headline">¶</a></h2>
<section id="restoring-blobs">
<h3>🗃️ Restoring blobs<a class="headerlink" href="#restoring-blobs" title="Permalink to this headline">¶</a></h3>
<p>Blob containers in backed up storage accounts are protected by <a class="reference external" href="https://docs.microsoft.com/en-us/azure/backup/blob-backup-overview#how-operational-backup-works">operational backup</a>.
It is possible to restore the state of the blobs to an earlier point in time, up to twelve weeks in the past.</p>
<p>The blob containers covered by the protection for each SRE are the</p>
<ul class="simple">
<li><p>ingress container (mounted at <code class="docutils literal notranslate"><span class="pre">/data</span></code>)</p></li>
<li><p>egress container (mounted at <code class="docutils literal notranslate"><span class="pre">/output</span></code>)</p></li>
<li><p>backup container (mounted at <code class="docutils literal notranslate"><span class="pre">/backup</span></code>)</p></li>
</ul>
<p>To restore these containers to a previous point in time:</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Blobs are restored ‘in place’.
The current state will be overwritten by the point which you restore to.</p>
</div>
<ul>
<li><p>In the Azure portal select <code class="docutils literal notranslate"><span class="pre">Subscriptions</span></code> then navigate to the subscription containing the relevant SRE</p></li>
<li><p>Search for the resource group: <code class="docutils literal notranslate"><span class="pre">RG_SHM_&lt;SHM</span> <span class="pre">ID&gt;_SRE_&lt;SRE</span> <span class="pre">ID&gt;_BACKUP</span></code>, then click on the storage account called: <code class="docutils literal notranslate"><span class="pre">bv-&lt;shm</span> <span class="pre">id&gt;-sre-&lt;sre</span> <span class="pre">id&gt;</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Backup</span> <span class="pre">instances</span></code> under <code class="docutils literal notranslate"><span class="pre">Manage</span></code> in the left-hand menu</p></li>
<li><p>Ensure that the <code class="docutils literal notranslate"><span class="pre">Datasource</span> <span class="pre">type</span></code> filter is set to <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Blobs</span> <span class="pre">(Azure</span> <span class="pre">Storage)</span></code></p>
<img alt="Selecting blob backup instances" class="align-center" src="../../_images/backup_instances_blobs.png" />
</li>
<li><p>Click on the storage-account backup instance</p></li>
<li><p>Select a point in the past to restore to and click <code class="docutils literal notranslate"><span class="pre">Restore</span></code></p>
<img alt="Selecting blob backup restore point" class="align-center" src="../../_images/backup_select_restore_time_blobs.png" />
</li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Next:</span> <span class="pre">Restore</span> <span class="pre">Parameters</span></code></p></li>
<li><p>You can now choose whether to restore all, or a subset of the containers. In the example below the ‘egress’ and ‘backup’ containers are selected</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Validate</span></code></p>
<img alt="Selecting blob containers to restore and validating" class="align-center" src="../../_images/backup_select_containers_validate_blobs.png" />
</li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Next:</span> <span class="pre">Review</span> <span class="pre">+</span> <span class="pre">restore</span></code></p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Restore</span></code></p></li>
</ul>
</section>
<section id="restoring-disks">
<h3>💿 Restoring disks<a class="headerlink" href="#restoring-disks" title="Permalink to this headline">¶</a></h3>
<p>Backed up disks have incremental snapshots taken daily.
These snapshots are stored in the backup resource group,<code class="docutils literal notranslate"><span class="pre">RG_SHM_&lt;SHM</span> <span class="pre">ID&gt;_SRE_&lt;SRE</span> <span class="pre">ID&gt;_BACKUP</span></code>.</p>
<p>The disks covered by the protection for each SRE are the</p>
<ul class="simple">
<li><p>GitLab data disk</p></li>
<li><p>CodiMD data disk</p></li>
<li><p>CoCalc data disk</p></li>
<li><p>PostgreSQL data disk</p></li>
<li><p>MSSQL data disk</p></li>
</ul>
<p>To restore a disk:</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Restoring a disk creates a new disk object from the incremental snapshots.
You will need to specify where to create the disk and its name.
You will also need to attach the disk to any virtual machines which should use
it and enroll the new disk into the backup system.</p>
</div>
<ul>
<li><p>In the Azure portal select <code class="docutils literal notranslate"><span class="pre">Subscriptions</span></code> then navigate to the subscription containing the relevant SRE</p></li>
<li><p>Search for the resource group: <code class="docutils literal notranslate"><span class="pre">RG_SHM_&lt;SHM</span> <span class="pre">ID&gt;_SRE_&lt;SRE</span> <span class="pre">ID&gt;_BACKUP</span></code>, then click on the storage account called: `bv-<shm id>-sre-<sre id></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Backup</span> <span class="pre">instances</span></code> under <code class="docutils literal notranslate"><span class="pre">Manage</span></code> in the left-hand menu</p></li>
<li><p>Ensure that the <code class="docutils literal notranslate"><span class="pre">Datasource</span> <span class="pre">type</span></code> filter is set to <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">Disks</span></code></p>
<img alt="Selecting disk backup instances" class="align-center" src="../../_images/backup_instances_disks.png" />
</li>
<li><p>Click on the disk to restore</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Restore</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">restore</span> <span class="pre">point</span></code> to choose which snapshot to revert to and click <code class="docutils literal notranslate"><span class="pre">Select</span></code>. By default only snapshots from the last 30 days are displayed but this can be adjusted</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Next:</span> <span class="pre">Restore</span> <span class="pre">Parameters</span></code></p></li>
<li><p>Enter the subscription and resource group in which to create the new disk; these should match the original disk</p></li>
<li><p>Enter a name for the new disk and click <code class="docutils literal notranslate"><span class="pre">Validate</span></code></p>
<img alt="Configuring and validating disk backup" class="align-center" src="../../_images/backup_select_snapshot_validate_disks.png" />
</li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Next:</span> <span class="pre">Review</span> <span class="pre">+</span> <span class="pre">restore</span></code></p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Restore</span></code></p></li>
<li><p>Wait for the restoration to finish. You can monitor the progress on the backup instance page on the Azure portal</p>
<img alt="../../_images/backup_progress_disk_1.png" class="align-center" src="../../_images/backup_progress_disk_1.png" />
<img alt="../../_images/backup_progress_disk_2.png" class="align-center" src="../../_images/backup_progress_disk_2.png" />
<img alt="../../_images/backup_progress_disk_3.png" class="align-center" src="../../_images/backup_progress_disk_3.png" />
</li>
<li><p>Navigate to the resource group where the new disk has been created</p></li>
<li><p>Select the virtual machine the old disk is attached to and click <code class="docutils literal notranslate"><span class="pre">Disks</span></code> in the left-hand menu</p></li>
<li><p>Take note of the old disks ‘LUN’</p></li>
<li><p>Remove the old disk be clicking the ‘X’ at the righ-hand side of the disk table</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Save</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Attach</span> <span class="pre">existing</span> <span class="pre">disks</span></code> and selected the disk you restored</p></li>
<li><p>Ensure the restored disk has the same ‘LUN’ as the old disk</p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">Save</span></code></p>
<img alt="The state before swapping in the restored disk" class="align-center" src="../../_images/backup_swap_disk_before.png" />
<img alt="The state after swapping in the restored disk" class="align-center" src="../../_images/backup_swap_disk_after.png" />
</li>
<li><p>Restart the virtual machine</p></li>
</ul>
</section>
<section id="enrolling-restored-disks-for-backup">
<h3>💿 Enrolling restored disks for backup<a class="headerlink" href="#enrolling-restored-disks-for-backup" title="Permalink to this headline">¶</a></h3>
<p>On your <strong>deployment machine</strong>.</p>
<ul>
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Ensure you are logged into <code class="docutils literal notranslate"><span class="pre">Azure</span></code> within <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code>. This command will give you a URL and a short alphanumeric code. You will need to visit that URL in a web browser and enter the code</p></li>
<li><p>NB. If your account is a guest in additional Azure tenants, you may need to add the <code class="docutils literal notranslate"><span class="pre">-Tenant</span> <span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> flag, where <code class="docutils literal notranslate"><span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> is the ID of the Azure tenant you want to deploy into</p></li>
<li><p>Note the name of the restored disk and the name of the resource group it belongs to</p></li>
<li><p>Run the following script subsituting <resource group name> and <disk name> with the names of the resource group and disk respectively:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">./</span><span class="n">SRE_Enroll_Disk_Backup</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">SHM</span> <span class="n">ID</span><span class="p">&gt;</span> <span class="n">-sreId</span> <span class="p">&lt;</span><span class="n">SRE</span> <span class="n">ID</span><span class="p">&gt;</span> <span class="n">-resourceGroup</span>
<span class="p">&lt;</span><span class="n">resource</span> <span class="nb">group </span><span class="n">name</span><span class="p">&gt;</span> <span class="n">-diskName</span> <span class="p">&lt;</span><span class="n">disk</span> <span class="n">name</span><span class="p">&gt;</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="remove-a-deployed-safe-haven">
<h2>🔚 Remove a deployed Safe Haven<a class="headerlink" href="#remove-a-deployed-safe-haven" title="Permalink to this headline">¶</a></h2>
<section id="tear-down-an-sre">
<h3>🔥 Tear down an SRE<a class="headerlink" href="#tear-down-an-sre" title="Permalink to this headline">¶</a></h3>
<p>In order to tear down an SRE, use the following procedure:</p>
<p>On your <strong>deployment machine</strong>.</p>
<ul>
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Ensure you are logged into <code class="docutils literal notranslate"><span class="pre">Azure</span></code> within <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code>. This command will give you a URL and a short alphanumeric code. You will need to visit that URL in a web browser and enter the code</p></li>
<li><p>NB. If your account is a guest in additional Azure tenants, you may need to add the <code class="docutils literal notranslate"><span class="pre">-Tenant</span> <span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> flag, where <code class="docutils literal notranslate"><span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> is the ID of the Azure tenant you want to deploy into.</p></li>
<li><p>Run the following script:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">./</span><span class="n">SRE_Teardown</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">SHM</span> <span class="n">ID</span><span class="p">&gt;</span> <span class="n">-sreId</span> <span class="p">&lt;</span><span class="n">SRE</span> <span class="n">ID</span><span class="p">&gt;</span>
</pre></div>
</div>
</li>
<li><p>If you provide the optional <code class="docutils literal notranslate"><span class="pre">-dryRun</span></code> parameter then the names of all affected resources will be printed, but nothing will be deleted</p></li>
</ul>
</section>
<section id="tear-down-the-shm">
<h3>💣 Tear down the SHM<a class="headerlink" href="#tear-down-the-shm" title="Permalink to this headline">¶</a></h3>
<p>In order to tear down the SHM, use the following procedure (you may skip the tearing down of package mirrors, unless this is the specific thing you wanted to do):</p>
<section id="disconnect-from-the-azure-active-directory">
<h4>🔓 Disconnect from the Azure Active Directory<a class="headerlink" href="#disconnect-from-the-azure-active-directory" title="Permalink to this headline">¶</a></h4>
<p>Connect to the <strong>SHM Domain Controller (DC1)</strong> via Remote Desktop Client over the SHM VPN connection</p>
<ul class="simple">
<li><p>Log in as a <strong>domain</strong> user (ie. <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code>) using the username and password obtained from the Azure portal</p></li>
<li><p>If you see a warning dialog that the certificate cannot be verified as root, accept this and continue</p></li>
<li><p>Open Powershell as an administrator</p>
<ul>
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">C:\Installation</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">.\Disconnect_AD.ps1</span></code></p></li>
<li><p>You will need to provide login credentials (including MFA if set up) for <code class="docutils literal notranslate"><span class="pre">&lt;admin</span> <span class="pre">username&gt;&#64;&lt;SHM</span> <span class="pre">domain&gt;</span></code></p></li>
</ul>
</li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Full disconnection of the Azure Active Directory can take up to 72 hours but is typically less.
If you are planning to install a new SHM connected to the same Azure Active Directory you may find the <code class="docutils literal notranslate"><span class="pre">AzureADConnect</span></code> installation step requires you to wait for the previous disconnection to complete.</p>
</div>
</section>
<section id="tear-down-any-attached-sres-then-the-shm">
<h4>💥 Tear down any attached SREs then the SHM<a class="headerlink" href="#tear-down-any-attached-sres-then-the-shm" title="Permalink to this headline">¶</a></h4>
<p>On your <strong>deployment machine</strong>.</p>
<ul>
<li><p>Ensure you have the same version of the Data Safe Haven repository as was used by your deployment team</p></li>
<li><p>Open a <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> terminal and navigate to the <code class="docutils literal notranslate"><span class="pre">deployment/administration</span></code> directory within the Data Safe Haven repository</p></li>
<li><p>Ensure you are logged into <code class="docutils literal notranslate"><span class="pre">Azure</span></code> within <code class="docutils literal notranslate"><span class="pre">Powershell</span></code> using the command: <code class="docutils literal notranslate"><span class="pre">Connect-AzAccount</span></code>. This command will give you a URL and a short alphanumeric code. You will need to visit that URL in a web browser and enter the code</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If your account is a guest in additional Azure tenants, you may need to add the <code class="docutils literal notranslate"><span class="pre">-Tenant</span> <span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> flag, where <code class="docutils literal notranslate"><span class="pre">&lt;Tenant</span> <span class="pre">ID&gt;</span></code> is the ID of the Azure tenant you want to deploy into.</p>
</div>
</li>
<li><p>For each SRE attached to the SHM, do the following:</p>
<ul>
<li><p>Tear down the SRE by running:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">./</span><span class="n">SRE_Teardown</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-sreId</span> <span class="p">&lt;</span><span class="n">SRE</span> <span class="n">ID</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>where the SRE ID is the one specified in the relevant config file</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you provide the optional <code class="docutils literal notranslate"><span class="pre">-dryRun</span></code> parameter then the names of all affected resources will be printed, but nothing will be deleted</p>
</div>
</li>
</ul>
</li>
<li><p>Tear down the SHM by running:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="p">./</span><span class="n">SHM_Teardown</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-shmId</span> <span class="p">&lt;</span><span class="n">SHM</span> <span class="n">ID</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;SHM</span> <span class="pre">ID&gt;</span></code> is the <a class="reference internal" href="../system_deployer/deploy_shm.html#roles-deployer-shm-id"><span class="std std-ref">management environment ID</span></a> specified in the configuration file.</p>
</li>
</ul>
</section>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="security_checklist.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Security evaluation checklist</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../../policies/index.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Policies</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, The Alan Turing Institute.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/en/master/">Sphinx</a> 4.3.0.
    Hosted by <a href="https://pages.github.com/">GitHub Pages</a>.
    <br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>